<!DOCTYPE html>
<!-- TÃ¡c pháº©m cá»§a LÃ£o NÃ£o/Lá»¯ TrÃ¬nh Má»™ng Tinh, cáº¥m Ä‘Äƒng láº¡i, cáº¥m thÆ°Æ¡ng máº¡i hÃ³a, táº¥t cáº£ Ä‘á»u Ä‘Æ°á»£c chia sáº» miá»…n phÃ­ vÃ  mÃ£ nguá»“n má»Ÿ -->
<html lang="vi-VN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quy KhÆ° - TÃºc Má»‡nh LuÃ¢n Há»“i</title>
    <style>
      /* ç±»è„‘/æ—…ç¨‹æ¢¦æ˜Ÿä½œå“ï¼Œç¦æ­¢äºŒä¼ ï¼Œç¦æ­¢å•†ä¸šåŒ–ï¼Œå‡æ— å¿å…è´¹å¼€æºåˆ†äº« */
      @import url('?family=ZCOOL+KuaiLe&family=Ma+Shan+Zheng&display=swap');

      /* --- åŸºç¡€ä¸å¸ƒå±€ --- */
      .guixu-root-container {
        font-family: 'ZCOOL+KuaiLe', 'Ma+Shan+Zheng', serif;
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        color: #c9aa71;
        border: 1px solid #c9aa71;
        border-radius: 8px;
        overflow: hidden;
        max-width: 100%;
        margin: auto;
        box-shadow: 0 0 15px rgba(201, 170, 113, 0.2);
        position: relative;
        width: 100%;
        /* aspect-ratio: 16 / 9; */ /* ç§»é™¤å®½é«˜æ¯”ï¼Œä½¿ç”¨å›ºå®šé«˜åº¦ */
        //max-width: 900px; /* æ¢å¤åŸå§‹å®½åº¦ */
      }

      .guixu-root-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(15, 15, 35, 0.7);
        z-index: 1;
      }

      .game-container {
        position: relative;
        z-index: 2;
        display: grid;
        grid-template-rows: 65px 1fr auto; /* è®©åº•éƒ¨æ é«˜åº¦è‡ªé€‚åº” */
        grid-template-columns: 220px 1fr 160px;
        width: 100%;
        gap: 1px;
        height: 600px; /* å›ºå®šé«˜åº¦ä»¥ä¾¿æ»šåŠ¨ */
      }

      .guixu-root-container * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

		/* THÃŠM Má»šI 2 loáº¡i: Äiá»u chá»‰nh layout khi á»Ÿ cháº¿ Ä‘á»™ toÃ n mÃ n hÃ¬nh */
	  .guixu-root-container:fullscreen {
	    max-width: none; /* Bá» giá»›i háº¡n chiá»u rá»™ng khi toÃ n mÃ n hÃ¬nh */
	    height: 100%; /* Chiáº¿m toÃ n bá»™ chiá»u cao */
	    border-radius: 0; /* Bá» bo gÃ³c */
	    border: none; /* Bá» viá»n */
	  }
	  .guixu-root-container:fullscreen .game-container {
  	    height: 100%; /* Quan trá»ng: Cho phÃ©p container game giÃ£n ra 100% chiá»u cao cá»§a cha nÃ³ */
  	  }	  

      /* --- å„é¢æ¿æ ·å¼ --- */
      .top-status {
        grid-column: 1 / -1;
        background: linear-gradient(
          90deg,
          rgba(26, 26, 46, 0.8) 0%,
          rgba(45, 27, 61, 0.8) 50%,
          rgba(26, 26, 46, 0.8) 100%
        );
        border-bottom: 1px solid #c9aa71;
        display: flex;
        align-items: center;
        justify-content: space-around;
        padding: 0 10px;
        box-shadow: 0 1px 8px rgba(201, 170, 113, 0.15);
      }
      .status-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
      }
      .status-label {
        font-size: 11px;
        color: #8b7355;
      }
      .status-value {
        font-size: 14px;
        color: #c9aa71;
        font-weight: bold;
      }
      .progress-bar {
        width: 70px;
        height: 5px;
        background: rgba(0, 0, 0, 0.5);
        border-radius: 3px;
        overflow: hidden;
        border: 1px solid #c9aa71;
      }
      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #ff6b6b, #ffd93d);
        border-radius: 2px;
      }
      .guixu-charge {
        width: 100px;
        height: 6px;
        background: rgba(0, 0, 0, 0.7);
        border-radius: 4px;
        border: 1px solid #8b4513;
        overflow: hidden;
      }
      .guixu-fill {
        height: 100%;
        background: linear-gradient(90deg, #dc143c, #ff6b6b, #ffd700);
        width: var(--guixu-charge, 0%);
        border-radius: 3px;
      }

      .character-panel {
        background: rgba(26, 26, 46, 0.5);
        border-right: 1px solid #c9aa71;
        padding: 10px;
        overflow-y: auto;
      }
      .panel-section {
        margin-bottom: 15px;
        padding: 8px;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 5px;
        border: 1px solid rgba(201, 170, 113, 0.3);
      }
      .section-title {
        font-size: 13px;
        color: #c9aa71;
        margin-bottom: 8px;
        text-align: center;
        border-bottom: 1px solid rgba(201, 170, 113, 0.3);
        padding-bottom: 4px;
      }
      .equipment-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 6px;
      }
      .equipment-slot {
        aspect-ratio: 1;
        background: rgba(0, 0, 0, 0.5);
        border: 1px dashed rgba(201, 170, 113, 0.5);
        border-radius: 5px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        color: #8b7355;
        cursor: pointer;
        transition: background-color 0.3s;
      }
      .equipment-slot.equipped {
        border-style: solid;
        color: #e0dcd1;
        font-size: 12px;
      }
      .equipment-slot:hover {
        background: rgba(201, 170, 113, 0.1);
      }
      .attributes-list {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .details-container {
        margin-bottom: 5px;
      }
      .details-container summary {
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        font-size: 11px;
        list-style: none; /* éšè—é»˜è®¤ç®­å¤´ */
      }
      .details-container summary::-webkit-details-marker {
        display: none; /* éšè—é»˜è®¤ç®­å¤´ */
      }
      .details-content {
        padding: 8px;
        margin-top: 4px;
        font-size: 11px;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 4px;
        border-top: 1px solid rgba(201, 170, 113, 0.2);
        color: #a09c91;
      }
      .details-content p {
        margin-bottom: 4px;
      }
      .attribute-item {
        display: flex;
        justify-content: space-between;
        font-size: 11px;
      }
      .attribute-name {
        color: #8b7355;
      }
      .attribute-value {
        color: #c9aa71;
        font-weight: bold;
      }

      .interaction-panel {
        background: rgba(45, 27, 61, 0.5);
        border-left: 1px solid #c9aa71;
        padding: 10px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        overflow-y: auto; /* æ–°å¢ï¼šå…è®¸äº¤äº’é¢æ¿åœ¨å†…å®¹è¿‡å¤šæ—¶æ»šåŠ¨ */
      }
      .interaction-btn {
        padding: 10px 8px;
        background: linear-gradient(45deg, #1a1a2e, #2d1b3d);
        border: 1px solid #c9aa71;
        border-radius: 5px;
        color: #c9aa71;
        font-size: 12px;
        cursor: pointer;
        text-align: center;
        transition: all 0.3s ease;
      }
      .interaction-btn:hover {
        background: linear-gradient(45deg, #2d1b3d, #3d2b4d);
      }
      .world-line-section {
        border-top: 1px solid rgba(201, 170, 113, 0.5);
        padding-top: 10px;
        margin-top: auto;
      }
	  /* THÃŠM Má»šI */
      .world-line-section > div {
        flex-direction: column;
      }
      .world-line-title {
        font-size: 10px;
        color: #8b7355;
        text-align: center;
        margin-bottom: 6px;
      }
      .primary-btn {
        background: linear-gradient(45deg, #8b4513, #cd853f);
        border-color: #daa520;
        color: #fff;
      }
      .auto-write-section {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 15px; /* ä¸ä¸Šæ–¹å†…å®¹éš”å¼€ */
        padding-top: 15px; /* ä¸ä¸Šæ–¹å†…å®¹éš”å¼€ */
        border-top: 1px solid rgba(201, 170, 113, 0.3); /* åˆ†å‰²çº¿ */
      }
      .auto-write-label {
        font-size: 12px;
        color: #8b7355;
        cursor: pointer;
      }
      #auto-write-checkbox {
        cursor: pointer;
      }
      .primary-btn:hover {
        background: linear-gradient(45deg, #cd853f, #daa520);
      }

      .bottom-status {
        grid-column: 1 / -1;
        background: linear-gradient(
          90deg,
          rgba(45, 27, 61, 0.8) 0%,
          rgba(26, 26, 46, 0.8) 50%,
          rgba(45, 27, 61, 0.8) 100%
        );
        border-top: 1px solid #c9aa71;
        display: flex;
        align-items: center;
        justify-content: space-between; /* ä¿®æ”¹å¯¹é½æ–¹å¼ */
        gap: 15px; /* å¢åŠ é—´è· */
        padding: 0 15px;
        transition: height 0.2s ease-in-out; /* æ–°å¢ï¼šé«˜åº¦å˜åŒ–åŠ¨ç”» */
      }
      .quick-send-container {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .quick-send-input {
        background: rgba(0, 0, 0, 0.5);
        border: 1px solid #8b7355;
        border-radius: 4px;
        color: #e0dcd1;
        padding: 5px 10px;
        font-size: 12px;
        width: 250px; /* ç»™ä¸€ä¸ªåˆå§‹å®½åº¦ */
        height: 32px; /* ä¸æŒ‰é’®é«˜åº¦å¯¹é½ */
        resize: none; /* ç¦æ­¢ç”¨æˆ·è°ƒæ•´å¤§å° */
        line-height: 1.5; /* è°ƒæ•´è¡Œé«˜ä½¿å•è¡Œæ–‡æœ¬çœ‹èµ·æ¥å±…ä¸­ */
        font-family: inherit; /* ç»§æ‰¿å­—ä½“ */
        overflow-y: auto; /* å†…å®¹è¶…å‡ºæ—¶æ˜¾ç¤ºæ»šåŠ¨æ¡ */
        transition: height 0.2s ease-in-out;
      }
      .quick-send-input:focus {
        height: 80px;
      }
      .quick-send-input::placeholder {
        color: #8b7355;
      }

      /* --- æ–°å¢ï¼šå¿«é€ŸæŒ‡ä»¤å¼¹å‡ºèœå• --- */
      #quick-command-popup {
        display: none;
        position: absolute;
        bottom: 65px; /* å¢åŠ bottomå€¼ï¼Œå°†èœå•ä¸Šç§» */
        right: 175px; /* å¤§è‡´å¯¹é½åˆ°å¿«é€Ÿå‘é€åŒºåŸŸ */
        background: rgba(15, 15, 35, 0.98);
        border: 1px solid #c9aa71;
        border-radius: 6px;
        z-index: 1002;
        width: 280px;
        max-height: 200px;
        overflow-y: auto;
        box-shadow: 0 -4px 15px rgba(0, 0, 0, 0.5);
      }
      .quick-command-list {
        list-style: none;
        padding: 5px;
        margin: 0;
      }
      .quick-command-item {
        padding: 8px 12px;
        color: #a09c91;
        font-size: 12px;
        /* cursor: pointer; */ /* ç§»é™¤æŒ‡é’ˆæ‰‹åŠ¿ */
        border-bottom: 1px solid rgba(201, 170, 113, 0.1);
        transition: background-color 0.2s;
      }
      .quick-command-item:last-child {
        border-bottom: none;
      }
      .quick-command-item:hover {
        background-color: rgba(201, 170, 113, 0.15);
        color: #e0dcd1;
      }
      .quick-command-empty {
        padding: 15px;
        text-align: center;
        color: #8b7355;
        font-style: italic;
        font-size: 12px;
      }

      .status-effect {
        display: flex;
        align-items: center;
        gap: 5px;
        padding: 4px 8px;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 15px;
        border: 1px solid rgba(201, 170, 113, 0.3);
        white-space: nowrap;
        font-size: 10px;
      }
      .effect-icon {
        width: 14px;
        height: 14px;
        background: #c9aa71;
        border-radius: 50%;
      }

      /* --- ä¸­å¤®å†…å®¹åŒº --- */
      .main-content {
        padding: 20px;
        overflow-y: auto;
        background: rgba(0, 0, 0, 0.2);
      }
      .game-text-container {
        font-size: 14px;
        line-height: 1.8;
        color: #e0dcd1;
        white-space: pre-wrap;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7);
      }

      /* --- æ–°å¢ï¼šæ­£æ–‡æŸ“è‰²æ ·å¼ --- */
      .text-language {
        color: #ff1493; /* è§å…‰ç²‰è‰² */
        font-style: italic;
      }
      .text-psychology {
        color: rgba(255, 255, 255, 0.7); /* åŠé€æ˜ç™½è‰² */
        font-style: italic;
      }
      .text-scenery {
        color: #98fb98; /* æ·¡ç»¿è‰² */
      }

      /* --- æ¨¡æ€çª—å£ (Modal) æ ·å¼ --- */
      .modal-overlay {
        display: none; /* é»˜è®¤éšè— */
        position: absolute; /* ç›¸å¯¹äº .guixu-root-container å®šä½ */
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }
      .modal-content {
        background: rgba(26, 26, 46, 0.95);
        border: 1px solid #c9aa71;
        border-radius: 8px;
        padding: 20px;
        width: 90%;
        max-width: 800px;
        height: 90%;
        max-height: 550px;
        display: flex;
        flex-direction: column;
        box-shadow: 0 0 20px rgba(201, 170, 113, 0.3);
      }
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid rgba(201, 170, 113, 0.5);
        padding-bottom: 10px;
        margin-bottom: 15px;
      }
      .modal-title {
        font-size: 18px;
        color: #c9aa71;
      }
      .modal-close-btn {
        font-size: 24px;
        color: #8b7355;
        cursor: pointer;
        background: none;
        border: none;
      }
      .modal-close-btn:hover {
        color: #c9aa71;
      }
      .modal-body {
        flex-grow: 1;
        overflow-y: auto;
      }

      /* --- å¤§äº‹è®°æ—¶é—´çº¿æ ·å¼ (å‚è€ƒ ä¿®ä»™ä¹‹è·¯) --- */
      .timeline-container {
        position: relative;
        padding: 20px 0;
        margin-left: 20px;
      }
      .timeline-line {
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 2px;
        background: #e0e0e0; /* æ”¹ä¸ºæµ…ç°è‰² */
      }
      .timeline-event {
        position: relative;
        margin-bottom: 30px;
        padding-left: 30px;
        transition: all 0.3s ease;
      }
      .timeline-event:hover {
        transform: translateX(5px);
      }
      .timeline-event::before {
        content: '';
        position: absolute;
        left: -5px;
        top: 5px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #ffffff; /* æ”¹ä¸ºç™½è‰² */
        border: 2px solid #cccccc; /* æ”¹ä¸ºç°è‰²è¾¹æ¡† */
      }
      .timeline-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }
      .timeline-date {
        font-size: 12px;
        color: #757575; /* æ·±ç°è‰² */
        font-style: italic;
      }
      .timeline-tags {
        display: flex;
        gap: 5px;
      }
      .tag-item {
        background-color: #eeeeee; /* æµ…ç°è‰²èƒŒæ™¯ */
        border: 1px solid #e0e0e0;
        color: #616161; /* æ·±ç°è‰²æ–‡å­— */
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 10px;
        white-space: nowrap;
        font-style: italic;
      }
      .timeline-content {
        background: #ffffff; /* æ”¹ä¸ºç™½è‰²èƒŒæ™¯ */
        padding: 15px;
        border-radius: 5px;
        border: 1px solid #000000; /* é»‘è‰²è¾¹æ¡† */
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      .timeline-title {
        font-weight: bold;
        margin-bottom: 8px;
        color: #212121; /* è¿‘é»‘è‰² */
        font-style: italic;
      }
      .timeline-description {
        font-size: 13px;
        color: #424242; /* æ·±ç°è‰² */
        line-height: 1.7;
      }

      .past-life-details {
        margin-top: 10px;
        font-size: 12px;
        display: flex;
        flex-direction: column;
        gap: 6px;
        color: #424242; /* æ·±ç°è‰² */
      }

      .detail-item > strong {
        color: #212121; /* è¿‘é»‘è‰² */
        margin-right: 5px;
        font-style: italic;
      }

      /* æ»šåŠ¨æ¡ */
      ::-webkit-scrollbar {
        width: 5px;
      }
      /* ::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.3);
      } */ /* æš‚æ—¶æ³¨é‡Šæ‰ä»¥é¿å…SillyTavernæ ¸å¿ƒè„šæœ¬é”™è¯¯ */
      ::-webkit-scrollbar-thumb {
        background: rgba(201, 170, 113, 0.5);
        border-radius: 3px;
      }

      /* --- èƒŒåŒ…æ¨¡æ€æ¡†æ ·å¼ --- */
      .inventory-category {
        margin-bottom: 15px;
        border: 1px solid rgba(201, 170, 113, 0.3);
        border-radius: 5px;
        background: rgba(0, 0, 0, 0.2);
        overflow: hidden;
      }
      .inventory-category-title {
        padding: 10px 15px;
        font-size: 16px;
        color: #c9aa71;
        cursor: pointer;
        list-style: none; 
        display: block;
        background: rgba(0, 0, 0, 0.3);
      }
      .inventory-category-title::-webkit-details-marker {
        display: none; 
      }
      .inventory-item-list {
        padding: 10px;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .inventory-item {
        background: rgba(26, 26, 46, 0.7);
        border: 1px solid rgba(201, 170, 113, 0.2);
        border-radius: 4px;
        padding: 10px;
      }
      .item-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start; /* æ”¹ä¸ºé¡¶éƒ¨å¯¹é½ */
        margin-bottom: 8px;
      }
      .item-details {
        margin-top: 10px;
        font-size: 12px;
        border-top: 1px solid rgba(201, 170, 113, 0.2);
        padding-top: 8px;
      }
      .item-name {
        font-weight: bold;
        color: #e0dcd1;
      }
      .item-quantity {
        font-size: 12px;
        color: #8b7355;
      }
      .item-description {
        font-size: 12px;
        color: #a09c91;
      }
      .empty-category-text {
        color: #8b7355;
        font-style: italic;
        padding: 10px;
        text-align: center;
      }

      /* --- è£…å¤‡æŒ‰é’®å’Œæ‚¬æµ®æç¤ºæ¡† --- */
      .item-equip-btn,
      .item-unequip-btn {
        padding: 4px 10px;
        font-size: 12px;
        background: linear-gradient(45deg, #8b4513, #cd853f);
        border: 1px solid #daa520;
        color: #fff;
        border-radius: 4px;
        cursor: pointer;
        transition: background 0.3s;
        margin-left: 15px;
      }
      .item-equip-btn:hover,
      .item-unequip-btn:hover {
        background: linear-gradient(45deg, #cd853f, #daa520);
      }
      .item-use-btn {
        padding: 4px 10px;
        font-size: 12px;
        background: linear-gradient(45deg, #8b4513, #cd853f);
        border: 1px solid #daa520;
        color: #fff;
        border-radius: 4px;
        cursor: pointer;
        transition: background 0.3s;
        margin-left: 15px;
      }
      .item-use-btn:hover {
        background: linear-gradient(45deg, #cd853f, #daa520);
      }
      .item-discard-btn {
        padding: 4px 10px;
        font-size: 12px;
        background: #8b0000;
        border: 1px solid #ff6b6b;
        color: #fff;
        border-radius: 4px;
        cursor: pointer;
        transition: background 0.3s;
        margin-left: 5px;
      }
      .item-discard-btn:hover {
        background: #a52a2a;
      }
      #equipment-tooltip {
        display: none;
        position: absolute; /* è·Ÿéšé¼ æ ‡ */
        background: rgba(15, 15, 35, 0.95);
        border: 1px solid #c9aa71;
        border-radius: 6px;
        padding: 15px;
        color: #e0dcd1;
        font-size: 12px;
        z-index: 1001;
        width: auto;
        max-width: 300px;
        pointer-events: none;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
      }
      .tooltip-title {
        font-size: 16px;
        font-weight: bold;
        margin-bottom: 10px;
        padding-bottom: 8px;
        border-bottom: 1px solid rgba(201, 170, 113, 0.4);
      }
      .tooltip-section {
        margin-top: 10px;
      }
      .tooltip-section-title {
        color: #8b7355;
        font-style: italic;
        margin-bottom: 5px;
      }
      .tooltip-attributes p {
        margin: 3px 0;
      }
      .tooltip-attributes strong {
        color: #c9aa71;
        margin-right: 5px;
      }

      .command-center-actions {
        list-style-type: none;
        padding: 0;
        margin-bottom: 20px;
      }
      .command-center-action-item {
        background: rgba(0, 0, 0, 0.3);
        padding: 8px 12px;
        border-radius: 4px;
        margin-bottom: 8px;
        font-size: 14px;
      }
      .command-center-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
        margin-top: auto; /* æ¨åˆ°åº•éƒ¨ */
        padding-top: 15px;
        border-top: 1px solid rgba(201, 170, 113, 0.5);
      }

      /* --- è§’è‰²è¯¦æƒ…æ¨¡æ€æ¡†ç¾åŒ– --- */
      #character-details-modal .modal-content {
        background: radial-gradient(circle, rgba(45, 27, 61, 0.9) 0%, rgba(15, 15, 35, 0.95) 100%);
        border: 1px solid #8b7355;
        box-shadow: 0 0 25px rgba(201, 170, 113, 0.3);
      }

      #character-details-modal .section-title {
        font-family: 'Ma Shan Zheng', cursive;
        font-size: 16px;
        letter-spacing: 1px;
      }

      #character-details-modal .attributes-list {
        gap: 0; /* ç§»é™¤gapï¼Œä½¿ç”¨è¾¹æ¡†åˆ†éš” */
      }

      #character-details-modal .attribute-item {
        padding: 8px 4px;
        border-bottom: 1px solid rgba(201, 170, 113, 0.1);
        transition: background-color 0.3s;
      }
      #character-details-modal .attribute-item:hover {
        background-color: rgba(201, 170, 113, 0.05);
      }
      #character-details-modal .attribute-item:last-child {
        border-bottom: none;
      }

      .details-progress-bar {
        width: 100%;
        height: 8px;
        background: rgba(0, 0, 0, 0.5);
        border-radius: 4px;
        overflow: hidden;
        border: 1px solid #8b7355;
        margin-top: 8px;
      }

      .details-progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #6a11cb, #2575fc);
        border-radius: 3px;
        transition: width 0.5s ease-in-out;
      }

      /* --- å½’å¢Ÿç³»ç»Ÿæ¨¡æ€æ¡†ç¾åŒ– --- */
      #guixu-system-modal .modal-content {
        background: radial-gradient(circle, rgba(45, 27, 61, 0.9) 0%, rgba(15, 15, 35, 0.95) 100%);
        border: 1px solid #8b7355;
        box-shadow: 0 0 25px rgba(201, 170, 113, 0.3);
      }

      #guixu-system-modal .attribute-item {
        padding: 10px 4px; /* å¢åŠ å‚ç›´å†…è¾¹è· */
        font-size: 13px; /* æ”¾å¤§å­—ä½“ */
        border-bottom: 1px solid rgba(201, 170, 113, 0.1);
      }
      #guixu-system-modal .attribute-item:last-child {
        border-bottom: none;
      }

      /* --- äººç‰©å…³ç³»æ ·å¼ --- */
      .relationship-card {
        background: rgba(0, 0, 0, 0.2);
        border: 1px solid rgba(201, 170, 113, 0.3);
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 15px;
      }
      .relationship-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        padding-bottom: 10px;
        border-bottom: 1px solid rgba(201, 170, 113, 0.2);
      }
      .relationship-name {
        font-size: 18px;
        font-weight: bold;
      }
      .relationship-relation {
        font-size: 14px;
        color: #a09c91;
        font-style: italic;
      }
      .relationship-body {
        font-size: 13px;
        line-height: 1.7;
      }
      .relationship-body p {
        margin-bottom: 8px;
      }
      .relationship-meta {
        display: flex;
        justify-content: space-between;
        font-size: 12px;
        color: #a09c91;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid rgba(201, 170, 113, 0.2);
      }
      .favorability-bar-container {
        width: 100%;
        height: 8px;
        background: rgba(0, 0, 0, 0.5);
        border-radius: 4px;
        margin-top: 4px;
        border: 1px solid #8b7355;
      }
      .favorability-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #8b4513, #cd853f);
        border-radius: 3px;
      }
      .event-history-details {
        margin-top: 15px;
      }
      .event-history-summary {
        cursor: pointer;
        color: #c9aa71;
        font-style: italic;
      }
      .event-history-list {
        list-style-type: disc;
        padding-left: 20px;
        margin-top: 8px;
        color: #a09c91;
      }

      /* --- æ–°å¢ï¼šæœ¬ä¸–å†ç¨‹è¯¦ç»†ä¿¡æ¯æ ·å¼ --- */
      .detail-section {
        margin-bottom: 10px;
        padding: 8px;
        background: rgba(0, 0, 0, 0.1);
        border-radius: 4px;
        font-size: 12px;
        line-height: 1.5;
      }

      .detail-section strong {
        color: #c9aa71;
        margin-right: 5px;
      }

      .timeline-location {
        font-size: 12px;
        color: #8b7355;
        margin: 5px 0;
        font-style: italic;
      }


      .timeline-detailed-info {
        animation: fadeIn 0.3s ease-in-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
    <style>
      /* ç±»è„‘/æ—…ç¨‹æ¢¦æ˜Ÿä½œå“ï¼Œç¦æ­¢äºŒä¼ ï¼Œç¦æ­¢å•†ä¸šåŒ–ï¼Œå‡æ— å¿å…è´¹å¼€æºåˆ†äº« */
      /* --- æ–°å¢ï¼šç§»åŠ¨ç«¯é€‚é…æ ·å¼ --- */
      /* --- æ–°å¢ï¼šè§†å›¾åˆ‡æ¢æŒ‰é’®æ ·å¼ --- */
      .view-toggle-btn {
        position: absolute;
        top: 15px;
        right: 15px;
        width: 35px;
        height: 35px;
        background: rgba(15, 15, 35, 0.8);
        border: 1px solid #c9aa71;
        color: #c9aa71;
        border-radius: 50%;
        cursor: pointer;
        z-index: 100;
        font-size: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.3s;
      }
      .view-toggle-btn:hover {
        background-color: rgba(45, 27, 61, 0.9);
      }

      /* THÃŠM Má»šI: Äá»‹nh vá»‹ nÃºt toÃ n mÃ n hÃ¬nh */
      #fullscreen-toggle-btn {
        right: 60px; /* Äáº·t vá»‹ trÃ­ bÃªn trÃ¡i nÃºt chuyá»ƒn Ä‘á»•i view */
      }
	  /* THÃŠM Má»šI: áº¨n nÃºt toÃ n mÃ n hÃ¬nh khi á»Ÿ cháº¿ Ä‘á»™ mobile */
	  .mobile-view #fullscreen-toggle-btn {
        display: none;
      }
	  
      /* --- æ–°å¢ï¼šç§»åŠ¨ç«¯è§†å›¾æ ·å¼ (ç”±JSåˆ‡æ¢) --- */
      .mobile-view .guixu-root-container {
        height: 100%;
        aspect-ratio: unset; /* åœ¨ç§»åŠ¨ç«¯ç§»é™¤PCç«¯çš„å®½é«˜æ¯”é™åˆ¶ */
      }

      .mobile-view .game-container {
        grid-template-columns: 1fr; /* å•åˆ—å¸ƒå±€ */
        grid-template-rows: auto 1fr auto auto auto; /* æ–°é¡ºåº: é¡¶, ä¸­, å·¦, å³, åº• */
        height: auto; /* è¦†ç›–å›ºå®šé«˜åº¦, è®©å…¶è‡ªé€‚åº”å†…å®¹ */
        gap: 0;
      }

      /* è®©æ‰€æœ‰é¢æ¿å æ®æ•´è¡Œ */
      .mobile-view .top-status,
      .mobile-view .character-panel,
      .mobile-view .main-content,
      .mobile-view .interaction-panel,
      .mobile-view .bottom-status {
        grid-column: 1 / -1;
      }

      .mobile-view .character-panel {
        grid-row: 3; /* ç§»åŠ¨åˆ°æ­£æ–‡ä¸‹æ–¹ */
        border-right: none;
        border-bottom: 1px solid #c9aa71;
        max-height: 250px; /* ç»™ä¸€ä¸ªæœ€å¤§é«˜åº¦ï¼Œå†…å®¹å¯æ»šåŠ¨ */
      }

      .mobile-view .main-content {
        grid-row: 2; /* ç§»åŠ¨åˆ°é¡¶éƒ¨ä¸‹æ–¹ */
      }

      .mobile-view .interaction-panel {
        grid-row: 4;
        border-left: none;
        border-top: 1px solid #c9aa71;
        flex-direction: row; /* æŒ‰é’®æ¨ªå‘æ’åˆ— */
        flex-wrap: wrap; /* å…è®¸æ¢è¡Œ */
        justify-content: center;
        gap: 8px;
        padding: 8px;
      }

      .mobile-view .interaction-btn {
        flex-grow: 1; /* è®©æŒ‰é’®å¡«å……ç©ºé—´ */
        min-width: 120px; /* æœ€å°å®½åº¦ */
      }

      .mobile-view .world-line-section {
        width: 100%;
        display: flex;
        justify-content: space-around;
      }
	  /* THÃŠM Má»šI */
      .mobile-view .world-line-section > div {
        flex-direction: row;
      }
	  
      .mobile-view .bottom-status {
        flex-direction: column; /* å‚ç›´å †å  */
        height: auto;
        padding: 8px;
      }

      .mobile-view .quick-send-container {
        width: 100%;
        flex-direction: column;
      }

      .mobile-view .quick-send-input {
        width: 100%;
      }

      .mobile-view #quick-command-popup {
        width: 90%;
        left: 5%;
        right: 5%;
        bottom: 110px; /* è°ƒæ•´ä½ç½® */
      }

      /* è°ƒæ•´å­—ä½“å¤§å° */
      .mobile-view .status-value {
        font-size: 12px;
      }
      .mobile-view .status-label {
        font-size: 10px;
      }
      .mobile-view .section-title {
        font-size: 12px;
      }
      .mobile-view .attribute-item {
        font-size: 11px;
      }
      .mobile-view .game-text-container {
        font-size: 13px;
      }
      .mobile-view .interaction-btn {
        font-size: 11px;
      }
    </style>
    <style>
      /* ç±»è„‘/æ—…ç¨‹æ¢¦æ˜Ÿä½œå“ï¼Œç¦æ­¢äºŒä¼ ï¼Œç¦æ­¢å•†ä¸šåŒ–ï¼Œå‡æ— å¿å…è´¹å¼€æºåˆ†äº« */
      /* --- è‡ªå®šä¹‰ç¡®è®¤æ¨¡æ€æ¡† --- */
      .confirm-modal-content {
        width: auto;
        max-width: 400px;
        height: auto;
        max-height: none;
        text-align: center;
        padding: 30px;
      }
      .confirm-modal-message {
        font-size: 16px;
        color: #ff6b6b; /* çº¢è‰²è­¦å‘Š */
        margin-bottom: 25px;
        line-height: 1.6;
      }
      .confirm-modal-buttons {
        display: flex;
        justify-content: center;
        gap: 20px;
      }
    </style>
    <style>
      /* ç±»è„‘/æ—…ç¨‹æ¢¦æ˜Ÿä½œå“ï¼Œç¦æ­¢äºŒä¼ ï¼Œç¦æ­¢å•†ä¸šåŒ–ï¼Œå‡æ— å¿å…è´¹å¼€æºåˆ†äº« */
      /* --- æ–°å¢ï¼šå­˜æ¡£ç®¡ç†æ¨¡æ€æ¡†æ ·å¼ --- */
      .clear-saves-btn {
        background: #8b0000;
        color: #fff;
        border: 1px solid #ff6b6b;
        padding: 4px 10px;
        font-size: 12px;
        border-radius: 4px;
        cursor: pointer;
        transition: background 0.3s;
        margin-left: auto; /* å°†æŒ‰é’®æ¨åˆ°å³è¾¹ */
      }
      .clear-saves-btn:hover {
        background: #a52a2a;
      }
      #save-slots-container {
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      .save-slot {
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(201, 170, 113, 0.3);
        border-radius: 5px;
        padding: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .save-slot-info {
        flex-grow: 1;
      }

      .save-slot-info .slot-name {
        font-size: 16px;
        color: #e0dcd1;
      }

      .save-slot-info .slot-time {
        font-size: 12px;
        color: #8b7355;
        margin-top: 5px;
      }
      .save-slot-info .slot-summary {
        font-size: 11px;
        color: #a09c91;
        margin-top: 8px;
        font-style: italic;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 450px; /* æ ¹æ®æ¨¡æ€æ¡†å®½åº¦è°ƒæ•´ */
      }

      .save-slot-actions {
        display: flex;
        gap: 10px;
      }
    </style>
    <style>
      /* ç±»è„‘/æ—…ç¨‹æ¢¦æ˜Ÿä½œå“ï¼Œç¦æ­¢äºŒä¼ ï¼Œç¦æ­¢å•†ä¸šåŒ–ï¼Œå‡æ— å¿å…è´¹å¼€æºåˆ†äº« */
      /* --- æ–°å¢ï¼šç­‰å¾…æ‚¬æµ®çª— --- */
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      @keyframes god-tier-animation {
        0% {
          background-position: -200% center;
        }
        100% {
          background-position: 200% center;
        }
      }

      .waiting-spinner {
        width: 24px;
        height: 24px;
        border: 3px solid rgba(201, 170, 113, 0.3);
        border-top-color: #c9aa71;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        flex-shrink: 0;
      }

      .waiting-popup {
        position: absolute;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(15, 15, 35, 0.8);
        color: #c9aa71;
        padding: 15px 25px;
        border-radius: 8px;
        border: 1px solid #c9aa71;
        z-index: 9999;
        font-size: 16px;
        box-shadow: 0 5px 25px rgba(0, 0, 0, 0.7);
        line-height: 1.6;
        display: flex;
        align-items: center;
        gap: 20px;
        width: 450px; /* æ‹‰é•¿æ‚¬æµ®æ¡† */
        max-width: 90%;
      }
    </style>
  </head>
  <body>
  <!-- TÃ¡c pháº©m cá»§a LÃ£o NÃ£o/Lá»¯ TrÃ¬nh Má»™ng Tinh, cáº¥m Ä‘Äƒng láº¡i, cáº¥m thÆ°Æ¡ng máº¡i hÃ³a, táº¥t cáº£ Ä‘á»u Ä‘Æ°á»£c chia sáº» miá»…n phÃ­ vÃ  mÃ£ nguá»“n má»Ÿ -->
  <div class="guixu-root-container">
    <!-- Má»šI: NÃºt toÃ n mÃ n hÃ¬nh -->
    <button id="fullscreen-toggle-btn" class="view-toggle-btn" title="ToÃ n mÃ n hÃ¬nh">â›¶</button>
    <!-- Má»›i: NÃºt chuyá»ƒn Ä‘á»•i giao diá»‡n -->
    <!-- TÃ¡c pháº©m cá»§a LÃ£o NÃ£o/Lá»¯ TrÃ¬nh Má»™ng Tinh, cáº¥m Ä‘Äƒng láº¡i, cáº¥m thÆ°Æ¡ng máº¡i hÃ³a, táº¥t cáº£ Ä‘á»u Ä‘Æ°á»£c chia sáº» miá»…n phÃ­ vÃ  mÃ£ nguá»“n má»Ÿ -->
    <button id="view-toggle-btn" class="view-toggle-btn" title="Chuyá»ƒn Ä‘á»•i giao diá»‡n">ğŸ“±</button>
    <div class="game-container">
      <!-- Thanh tráº¡ng thÃ¡i trÃªn cÃ¹ng -->
      <!-- TÃ¡c pháº©m cá»§a LÃ£o NÃ£o/Lá»¯ TrÃ¬nh Má»™ng Tinh, cáº¥m Ä‘Äƒng láº¡i, cáº¥m thÆ°Æ¡ng máº¡i hÃ³a, táº¥t cáº£ Ä‘á»u Ä‘Æ°á»£c chia sáº» miá»…n phÃ­ vÃ  mÃ£ nguá»“n má»Ÿ -->
      <div class="top-status">
        <div class="status-item">
          <div class="status-label">Cáº£nh Giá»›i</div>
          <div id="val-jingjie" class="status-value">...</div>
        </div>
        <div class="status-item">
          <div class="status-label">NiÃªn Ká»· Hiá»‡n Táº¡i</div>
          <div id="val-jinian" class="status-value">...</div>
        </div>
        <div class="status-item">
          <div class="status-label">Quy KhÆ° Náº¡p NÄƒng</div>
          <div id="val-guixu-charge-text" class="status-value">...%</div>
          <div id="bar-guixu-charge" class="guixu-charge">
            <div class="guixu-fill"></div>
          </div>
        </div>
      </div>

      <!-- Báº£ng nhÃ¢n váº­t bÃªn trÃ¡i -->
      <!-- TÃ¡c pháº©m cá»§a LÃ£o NÃ£o/Lá»¯ TrÃ¬nh Má»™ng Tinh, cáº¥m Ä‘Äƒng láº¡i, cáº¥m thÆ°Æ¡ng máº¡i hÃ³a, táº¥t cáº£ Ä‘á»u Ä‘Æ°á»£c chia sáº» miá»…n phÃ­ vÃ  mÃ£ nguá»“n má»Ÿ -->
      <div class="character-panel">
        <div class="panel-section">
          <div class="section-title">Thuá»™c TÃ­nh Cá»‘t LÃµi <span style="font-size: 10px; color: #8b7355">(Hiá»‡n táº¡i/Giá»›i háº¡n)</span></div>
          <div class="attributes-list">
            <div class="attribute-item">
              <span class="attribute-name">PhÃ¡p Lá»±c</span><span id="attr-fali" class="attribute-value">...</span>
            </div>
            <div class="attribute-item">
              <span class="attribute-name">Tháº§n Háº£i</span><span id="attr-shenhai" class="attribute-value">...</span>
            </div>
            <div class="attribute-item">
              <span class="attribute-name">Äáº¡o TÃ¢m</span><span id="attr-daoxin" class="attribute-value">...</span>
            </div>
            <div class="attribute-item">
              <span class="attribute-name">KhÃ´ng Tá»‘c</span><span id="attr-kongsu" class="attribute-value">...</span>
            </div>
            <div class="attribute-item">
              <span class="attribute-name">KhÃ­ Váº­n</span><span id="attr-qiyun" class="attribute-value">...</span>
            </div>
            <div class="attribute-item">
              <span class="attribute-name">Tuá»•i Sinh LÃ½</span><span id="attr-shengli" class="attribute-value">...</span>
            </div>
            <div class="attribute-item">
              <span class="attribute-name">Tuá»•i TÃ¢m LÃ½</span><span id="attr-xinli" class="attribute-value">...</span>
            </div>
          </div>
        </div>
        <div class="panel-section">
          <div class="section-title">ThiÃªn PhÃº & Linh CÄƒn</div>
          <div id="talent-linggen-list" class="attributes-list">
            <!-- ThiÃªn phÃº vÃ  Linh cÄƒn sáº½ Ä‘Æ°á»£c Ä‘iá»n tá»± Ä‘á»™ng vÃ o Ä‘Ã¢y -->
          </div>
        </div>
        <div class="panel-section">
          <div class="section-title">Trang Bá»‹ Hiá»‡n Táº¡i</div>
          <div class="equipment-grid">
            <div id="equip-wuqi" class="equipment-slot">VÅ© KhÃ­</div>
            <div id="equip-fangju" class="equipment-slot">PhÃ²ng Cá»¥</div>
            <div id="equip-shipin" class="equipment-slot">Phá»¥ Kiá»‡n</div>
            <div id="equip-fabao1" class="equipment-slot">PhÃ¡p Báº£o</div>
            <div id="equip-zhuxiuGongfa" class="equipment-slot">CÃ´ng PhÃ¡p Chá»§ Tu</div>
            <div id="equip-fuxiuXinfa" class="equipment-slot">TÃ¢m PhÃ¡p Phá»¥ Tu</div>
          </div>
        </div>
      </div>

      <!-- Khu vá»±c ná»™i dung trung tÃ¢m -->
      <!-- TÃ¡c pháº©m cá»§a LÃ£o NÃ£o/Lá»¯ TrÃ¬nh Má»™ng Tinh, cáº¥m Ä‘Äƒng láº¡i, cáº¥m thÆ°Æ¡ng máº¡i hÃ³a, táº¥t cáº£ Ä‘á»u Ä‘Æ°á»£c chia sáº» miá»…n phÃ­ vÃ  mÃ£ nguá»“n má»Ÿ -->
      <div class="main-content">
        <div id="game-text-display" class="game-text-container">
          <!-- VÄƒn báº£n chÃ­nh cá»§a trÃ² chÆ¡i do AI táº¡o ra sáº½ hiá»ƒn thá»‹ á»Ÿ Ä‘Ã¢y -->
          <gametxt> ChÃ o má»«ng Ä‘áº¿n vá»›i tháº¿ giá»›i cá»§a ã€ŠQuy KhÆ°ã€‹. TÃºc má»‡nh cá»§a ngÆ°Æ¡i, báº¯t Ä‘áº§u tá»« Ä‘Ã¢y. </gametxt>
        </div>
      </div>

      <!-- Báº£ng tÆ°Æ¡ng tÃ¡c bÃªn pháº£i -->
      <div class="interaction-panel">
        <button id="btn-inventory" class="interaction-btn">TÃºi Äá»“</button>
        <button id="btn-relationships" class="interaction-btn">Quan Há»‡ NhÃ¢n Váº­t</button>
        <button id="btn-command-center" class="interaction-btn">Trung TÃ¢m Má»‡nh Lá»‡nh</button>
        <button id="btn-character-details" class="interaction-btn">Chi Tiáº¿t NhÃ¢n Váº­t</button>
        <button id="btn-guixu-system" class="interaction-btn">Há»‡ Thá»‘ng Quy KhÆ°</button>
        <button id="btn-show-extracted" class="interaction-btn">Xem Ná»™i Dung TrÃ­ch Xuáº¥t</button>
        <button id="btn-save-load-manager" class="interaction-btn">LÆ°u Trá»¯/Táº£i Láº¡i</button>
        <!-- Má»›i: MÃ´-Ä‘un Ä‘iá»u khiá»ƒn Lorebook thá»‘ng nháº¥t -->
        <div id="world-book-controls" class="panel-section" style="padding: 8px; margin-top: 10px">
          <div class="section-title" style="font-size: 11px; margin-bottom: 6px">Äiá»u Khiá»ƒn Lorebook</div>
          <div style="display: flex; flex-direction: column; gap: 8px">
            <div style="display: flex; align-items: center; justify-content: space-between">
              <label for="unified-index-input" style="font-size: 11px; color: #8b7355">Sá»‘ thá»© tá»± Äá»c/Ghi:</label>
              <input type="number" id="unified-index-input" value="1" min="1" style="width: 60px; background: rgba(0, 0, 0, 0.5); border: 1px solid #8b7355; color: #e0dcd1; border-radius: 4px; padding: 4px; font-size: 12px" />
            </div>
            <div style="display: flex; align-items: center; gap: 6px">
              <input type="checkbox" id="auto-toggle-lorebook-checkbox" style="cursor: pointer" />
              <label for="auto-toggle-lorebook-checkbox" class="auto-write-label" style="font-size: 11px">Tá»± Ä‘á»™ng báº­t/táº¯t Lorebook</label>
            </div>
          </div>
        </div>
        <!-- NÃºt dÃ²ng thá»i gian Ä‘Ã£ Ä‘Æ°á»£c chuyá»ƒn Ä‘áº¿n giao diá»‡n lÆ°u trá»¯ -->
        <div class="world-line-section">
          <div class="world-line-title">NhÃ¬n Láº¡i DÃ²ng Thá»i Gian</div>
          <div style="display: flex; gap: 10px; justify-content: center">
            <button id="btn-view-journey-main" class="interaction-btn primary-btn" style="flex-grow: 1; white-space: nowrap">HÃ nh TrÃ¬nh Kiáº¿p NÃ y</button>
            <button id="btn-view-past-lives-main" class="interaction-btn primary-btn" style="flex-grow: 1; white-space: nowrap">SÃ³ng NÆ°á»›c Kiáº¿p XÆ°a</button>
          </div>
        </div>
      </div>

      <!-- Hiá»‡u á»©ng tráº¡ng thÃ¡i á»Ÿ dÆ°á»›i cÃ¹ng -->
      <div id="bottom-status-container" class="bottom-status">
        <div id="status-effects-wrapper" style="display: flex; gap: 8px; overflow-x: auto">
          <!-- Hiá»‡u á»©ng tráº¡ng thÃ¡i sáº½ Ä‘Æ°á»£c JS Ä‘iá»n tá»± Ä‘á»™ng -->
          <div class="status-effect">
            <div class="effect-icon"></div>
            <span>Hiá»‡n khÃ´ng cÃ³ tráº¡ng thÃ¡i hiá»‡u á»©ng</span>
          </div>
        </div>
        <div class="quick-send-container">
          <button id="btn-quick-commands" class="interaction-btn" style="padding: 5px 12px">Má»‡nh Lá»‡nh Hiá»‡n Táº¡i</button>
          <textarea id="quick-send-input" class="quick-send-input" placeholder="Vui lÃ²ng nháº­p pháº£n há»“i táº¡i Ä‘Ã¢y..."></textarea>
          <button id="btn-quick-send" class="interaction-btn" style="padding: 5px 12px">Gá»­i</button>
        </div>
      </div>
    </div>

    <!-- CÃ¡c cá»­a sá»• modal khÃ¡c nhau (ÄÃƒ DI CHUYá»‚N VÃ€O TRONG .guixu-root-container) -->
    <div id="inventory-modal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">TÃºi Äá»“ Cá»§a Ta</h2>
          <button class="modal-close-btn">&times;</button>
        </div>
        <div class="modal-body">
          <!-- Ná»™i dung tÃºi Ä‘á»“ sáº½ Ä‘Æ°á»£c JS Ä‘iá»n tá»± Ä‘á»™ng -->
        </div>
      </div>
    </div>
    <div id="relationships-modal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">Quan Há»‡ NhÃ¢n Váº­t</h2>
          <button class="modal-close-btn">&times;</button>
        </div>
        <div class="modal-body">
          <!-- Ná»™i dung quan há»‡ nhÃ¢n váº­t sáº½ Ä‘Æ°á»£c JS Ä‘iá»n tá»± Ä‘á»™ng -->
        </div>
      </div>
    </div>
    <div id="history-modal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="history-modal-title" class="modal-title">NhÃ¬n Láº¡i Lá»‹ch Sá»­</h2>
          <div style="display: flex; align-items: center; gap: 10px; margin-left: auto"></div>
          <button class="modal-close-btn" style="margin-left: 15px">&times;</button>
        </div>
        <div id="history-modal-body" class="modal-body">
          <!-- Ná»™i dung HÃ nh trÃ¬nh/Gá»£n sÃ³ng sáº½ Ä‘Æ°á»£c JS Ä‘iá»n tá»± Ä‘á»™ng -->
        </div>
      </div>
    </div>
    <div id="command-center-modal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">Trung TÃ¢m Má»‡nh Lá»‡nh</h2>
          <button class="modal-close-btn">&times;</button>
        </div>
        <div class="modal-body">
          <!-- Má»‡nh lá»‡nh sáº½ Ä‘Æ°á»£c JS Ä‘iá»n tá»± Ä‘á»™ng -->
        </div>
        <div class="command-center-footer">
          <button id="btn-refresh-storage" class="interaction-btn">LÃ m má»›i bá»™ nhá»› Ä‘á»‡m</button>
          <div>
            <button id="btn-clear-commands" class="interaction-btn">XÃ³a sáº¡ch má»‡nh lá»‡nh</button>
            <button id="btn-execute-commands" class="interaction-btn primary-btn" style="margin-left: 10px">
              Cháº¥p hÃ nh má»‡nh lá»‡nh
            </button>
          </div>
        </div>
      </div>
    </div>
    <div id="extracted-content-modal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">Ná»™i dung AI Ä‘Æ°á»£c trÃ­ch xuáº¥t láº§n cuá»‘i</h2>
          <div style="display: flex; align-items: center; gap: 10px; margin-left: auto"></div>
          <button class="modal-close-btn" style="margin-left: 15px">&times;</button>
        </div>
        <div class="modal-body">
          <div class="panel-section">
            <div class="section-title" style="display: flex; justify-content: space-between; align-items: center">
              <span>HÃ nh TrÃ¬nh Kiáº¿p NÃ y</span>
              <button
                id="btn-write-journey"
                class="interaction-btn"
                style="padding: 4px 8px; font-size: 12px; margin-left: 10px"
              >
                Ghi vÃ o Lorebook
              </button>
            </div>
            <pre
              id="extracted-journey"
              style="
                  white-space: pre-wrap;
                  word-wrap: break-word;
                  color: #e0dcd1;
                  font-size: 12px;
                  padding: 10px;
                  background: rgba(0, 0, 0, 0.2);
                  border-radius: 4px;
                  min-height: 50px;
                "
            >
KhÃ´ng cÃ³ ná»™i dung</pre
            >
          </div>
          <div class="panel-section">
            <div class="section-title" style="display: flex; justify-content: space-between; align-items: center">
              <span>SÃ³ng NÆ°á»›c Kiáº¿p XÆ°a</span>
              <button
                id="btn-write-past-lives"
                class="interaction-btn"
                style="padding: 4px 8px; font-size: 12px; margin-left: 10px"
              >
                Ghi vÃ o Lorebook
              </button>
            </div>
            <pre
              id="extracted-past-lives"
              style="
                  white-space: pre-wrap;
                  word-wrap: break-word;
                  color: #e0dcd1;
                  font-size: 12px;
                  padding: 10px;
                  background: rgba(0, 0, 0, 0.2);
                  border-radius: 4px;
                  min-height: 50px;
                "
            >
KhÃ´ng cÃ³ ná»™i dung</pre
            >
          </div>
          <div class="panel-section">
            <div class="section-title" style="display: flex; justify-content: space-between; align-items: center">
              <span>Cháº¿ Ä‘á»™ tiá»ƒu thuyáº¿t</span>
              <button
                id="btn-write-novel-mode"
                class="interaction-btn"
                style="padding: 4px 8px; font-size: 12px; margin-left: 10px"
              >
                Ghi vÃ o Lorebook
              </button>
            </div>
            <pre
              id="extracted-novel-mode"
              style="
                  white-space: pre-wrap;
                  word-wrap: break-word;
                  color: #e0dcd1;
                  font-size: 12px;
                  padding: 10px;
                  background: rgba(0, 0, 0, 0.2);
                  border-radius: 4px;
                  min-height: 50px;
                "
            >
Cháº¿ Ä‘á»™ tiá»ƒu thuyáº¿t Ä‘Ã£ táº¯t</pre
            >
          </div>
          <div class="panel-section">
            <div class="section-title" style="display: flex; justify-content: space-between; align-items: center">
              <span>TrÃ­ch xuáº¥t nhÃ¢n váº­t</span>
              <button
                id="btn-write-character-card"
                class="interaction-btn"
                style="padding: 4px 8px; font-size: 12px; margin-left: 10px"
              >
                Ghi vÃ o Lorebook
              </button>
            </div>
            <pre
              id="extracted-character-card"
              style="
                  white-space: pre-wrap;
                  word-wrap: break-word;
                  color: #e0dcd1;
                  font-size: 12px;
                  padding: 10px;
                  background: rgba(0, 0, 0, 0.2);
                  border-radius: 4px;
                  min-height: 50px;
                "
            >
KhÃ´ng cÃ³ ná»™i dung</pre
            >
          </div>
          <!-- Má»›i: Chuyá»ƒn tÃ¹y chá»n tá»± Ä‘á»™ng ghi vÃ o bÃªn trong modal nÃ y -->
          <div class="auto-write-section">
            <input type="checkbox" id="novel-mode-enabled-checkbox" />
            <label for="novel-mode-enabled-checkbox" class="auto-write-label">Báº­t cháº¿ Ä‘á»™ tiá»ƒu thuyáº¿t</label>
            <input type="checkbox" id="auto-write-checkbox" checked style="margin-left: 20px" />
            <label for="auto-write-checkbox" class="auto-write-label">Tá»± Ä‘á»™ng ghi HÃ nh trÃ¬nh/Gá»£n sÃ³ng</label>
          </div>
          <details class="panel-section" style="margin-top: 15px">
            <summary class="section-title" style="cursor: pointer; list-style: none">
              <span>Thay Ä‘á»•i biáº¿n láº§n nÃ y</span>
            </summary>
            <pre
              id="extracted-variable-changes"
              style="
                  white-space: pre-wrap;
                  word-wrap: break-word;
                  color: #e0dcd1;
                  font-size: 12px;
                  padding: 10px;
                  background: rgba(0, 0, 0, 0.2);
                  border-radius: 4px;
                  min-height: 50px;
                "
            >
KhÃ´ng cÃ³ ná»™i dung</pre
            >
          </details>
        </div>
      </div>
    </div>

    <!-- Má»›i: Cá»­a sá»• modal chi tiáº¿t nhÃ¢n váº­t -->
    <div id="character-details-modal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">Chi Tiáº¿t NhÃ¢n Váº­t</h2>
          <button class="modal-close-btn">&times;</button>
        </div>
        <div class="modal-body">
          <!-- Thuá»™c tÃ­nh chi tiáº¿t sáº½ Ä‘Æ°á»£c JS Ä‘iá»n tá»± Ä‘á»™ng -->
        </div>
      </div>
    </div>

    <!-- Má»›i: Cá»­a sá»• modal há»‡ thá»‘ng Quy KhÆ° -->
    <div id="guixu-system-modal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">Há»‡ Thá»‘ng Quy KhÆ°</h2>
          <button class="modal-close-btn">&times;</button>
        </div>
        <div class="modal-body">
          <!-- ThÃ´ng tin há»‡ thá»‘ng Quy KhÆ° sáº½ Ä‘Æ°á»£c JS Ä‘iá»n tá»± Ä‘á»™ng -->
        </div>
      </div>
    </div>


    <!-- Há»™p thoáº¡i chi tiáº¿t trang bá»‹ (di chuyá»ƒn Ä‘áº¿n cuá»‘i body) -->
    <div id="equipment-tooltip"></div>

    <!-- Má»›i: Há»™p thoáº¡i xÃ¡c nháº­n tÃ¹y chá»‰nh -->
    <div id="custom-confirm-modal" class="modal-overlay">
      <div class="modal-content confirm-modal-content">
        <div id="custom-confirm-message" class="confirm-modal-message">
          <!-- Tin nháº¯n sáº½ Ä‘Æ°á»£c JS Ä‘iá»n -->
        </div>
        <div class="confirm-modal-buttons">
          <button id="custom-confirm-btn-ok" class="interaction-btn primary-btn">XÃ¡c nháº­n</button>
          <button id="custom-confirm-btn-cancel" class="interaction-btn">Há»§y</button>
        </div>
      </div>
    </div>

    <!-- Má»›i: Menu lá»‡nh nhanh báº­t lÃªn -->
    <div id="quick-command-popup">
      <!-- Ná»™i dung sáº½ Ä‘Æ°á»£c JS Ä‘iá»n tá»± Ä‘á»™ng -->
    </div>

    <!-- Má»›i: Cá»­a sá»• modal quáº£n lÃ½ LÆ°u/Táº£i -->
    <div id="save-load-modal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">Quáº£n lÃ½ LÆ°u trá»¯</h2>
          <div style="display: flex; gap: 10px; margin-left: auto;">
            <button id="btn-clear-all-saves" class="clear-saves-btn">XÃ³a táº¥t cáº£ tá»‡p lÆ°u</button>
          </div>
          <button class="modal-close-btn" style="margin-left: 15px;">&times;</button>
        </div>
        <div id="save-slots-container" class="modal-body">
          <!-- CÃ¡c Ã´ lÆ°u trá»¯ sáº½ Ä‘Æ°á»£c JS Ä‘iá»n tá»± Ä‘á»™ng -->
        </div>
      </div>
    </div>
  </div><!-- tháº» Ä‘Ã³ng cá»§a .guixu-root-container -->

  <script>
    // TÃ¡c pháº©m cá»§a LÃ£o NÃ£o/Lá»¯ TrÃ¬nh Má»™ng Tinh, cáº¥m Ä‘Äƒng láº¡i, cáº¥m thÆ°Æ¡ng máº¡i hÃ³a, táº¥t cáº£ Ä‘á»u Ä‘Æ°á»£c chia sáº» miá»…n phÃ­ vÃ  mÃ£ nguá»“n má»Ÿ
    // --- SillyTavern Global API ---
    // These are provided by the SillyTavern environment at runtime.
      // We will check for their existence before using them.
      /* global TavernHelper, eventOn, tavern_events, getChatMessages, getCurrentMessageId, _ */

      // --- Main Application Logic ---
      (function () {
        'use strict';

        // --- API Availability Check ---
        if (
          typeof TavernHelper === 'undefined' ||
          typeof eventOn === 'undefined' ||
          typeof tavern_events === 'undefined' ||
          typeof getChatMessages === 'undefined' ||
          typeof getCurrentMessageId === 'undefined' ||
          typeof _ === 'undefined'
        ) {
          console.error('TavernHelper API, event system, or lodash not found.');
          document.addEventListener('DOMContentLoaded', () => {
            document.body.innerHTML =
              '<h1 style="color: red; text-align: center;">Lá»—i: KhÃ´ng tÃ¬m tháº¥y API mÃ´i trÆ°á»ng SillyTavern hoáº·c phiÃªn báº£n khÃ´ng tÆ°Æ¡ng thÃ­ch</h1><p style="color:grey; text-align:center;">Vui lÃ²ng Ä‘áº£m báº£o Ä‘Ã£ cÃ i Ä‘áº·t vÃ  kÃ­ch hoáº¡t tiá»‡n Ã­ch má»Ÿ rá»™ng TavernHelper.</p>';
          });
          return;
        }

        // --- Core Application Object for UI Interactions ---
        // ç±»è„‘/æ—…ç¨‹æ¢¦æ˜Ÿä½œå“ï¼Œç¦æ­¢äºŒä¼ ï¼Œç¦æ­¢å•†ä¸šåŒ–ï¼Œå‡æ— å¿å…è´¹å¼€æºåˆ†äº«
        const GuixuManager = {
          listenersBound: false, // Má»›i: Cá» Ä‘á»ƒ ngÄƒn cháº·n viá»‡c gÃ¡n láº¡i trÃ¬nh láº¯ng nghe sá»± kiá»‡n
          // Theo dÃµi tráº¡ng thÃ¡i cá»§a cÃ¡c váº­t pháº©m Ä‘Ã£ trang bá»‹
          // **Sá»­a lá»—i logic**: equippedItems bÃ¢y giá» lÆ°u trá»¯ Ä‘á»‘i tÆ°á»£ng váº­t pháº©m hoÃ n chá»‰nh, khÃ´ng chá»‰ ID
          equippedItems: {
            wuqi: null,
            fangju: null,
            shipin: null,
            fabao1: null,
            zhuxiuGongfa: null,
            fuxiuXinfa: null,
          },
          currentMvuState: null, // Má»›i: DÃ¹ng Ä‘á»ƒ lÆ°u trá»¯ tráº¡ng thÃ¡i mvu má»›i nháº¥t
          pendingActions: [], // Giá» hÃ ng/HÃ ng Ä‘á»£i lá»‡nh
          baseAttributes: {}, // LÆ°u trá»¯ cÃ¡c thuá»™c tÃ­nh gá»‘c Ä‘Æ°á»£c táº£i tá»« mvu
          calculatedMaxAttributes: {}, // Má»›i: DÃ¹ng Ä‘á»ƒ lÆ°u trá»¯ giá»›i háº¡n thuá»™c tÃ­nh sau khi tÃ­nh toÃ¡n
          lastExtractedJourney: null,
          lastExtractedPastLives: null,
          lastExtractedNovelText: null, // Má»›i: DÃ¹ng Ä‘á»ƒ lÆ°u trá»¯ vÄƒn báº£n gá»‘c Ä‘Æ°á»£c trÃ­ch xuáº¥t
          lastExtractedCharacterCard: null, // Má»›i: DÃ¹ng Ä‘á»ƒ lÆ°u trá»¯ tháº» nhÃ¢n váº­t Ä‘Æ°á»£c trÃ­ch xuáº¥t
          lastExtractedVariables: null, // Má»›i: DÃ¹ng Ä‘á»ƒ lÆ°u trá»¯ cÃ¡c thay Ä‘á»•i biáº¿n
          lastSentPrompt: null, // Má»›i: DÃ¹ng Ä‘á»ƒ lÆ°u trá»¯ lá»i nháº¯c hoÃ n chá»‰nh Ä‘Æ°á»£c gá»­i Ä‘áº¿n AI
          isNovelModeEnabled: false, // Má»›i: Tráº¡ng thÃ¡i báº­t/táº¯t cháº¿ Ä‘á»™ tiá»ƒu thuyáº¿t
          isAutoWriteEnabled: true, // Máº·c Ä‘á»‹nh báº­t tá»± Ä‘á»™ng ghi
          autoWriteIntervalId: null, // DÃ¹ng Ä‘á»ƒ lÆ°u trá»¯ ID bá»™ háº¹n giá» thÄƒm dÃ²
          novelModeAutoWriteIntervalId: null, // Má»›i: ID thÄƒm dÃ² tá»± Ä‘á»™ng ghi cho cháº¿ Ä‘á»™ tiá»ƒu thuyáº¿t
          isMobileView: false, // Má»›i: Theo dÃµi tráº¡ng thÃ¡i giao diá»‡n di Ä‘á»™ng
          unifiedIndex: 1, // Má»›i: Sá»‘ thá»© tá»± Ä‘á»c/ghi thá»‘ng nháº¥t
          isAutoToggleLorebookEnabled: false, // Má»›i: Tráº¡ng thÃ¡i tá»± Ä‘á»™ng báº­t/táº¯t Lorebook
          autoToggleIntervalId: null, // Má»›i: ID bá»™ háº¹n giá» thÄƒm dÃ²
          listenersBound: false, // æ–°å¢ï¼šé˜²æ­¢äº‹ä»¶ç›‘å¬å™¨é‡å¤ç»‘å®šçš„æ ‡å¿—
          // --- æ–°å¢ï¼šå¤„ç†æ‰€æœ‰åŠ¨ä½œçš„æ ¸å¿ƒå‡½æ•° ---
          waitingMessages: [
            'Ã” Ã´ Ã´ Ã´, Má»™ng Tinh Ä‘áº¡i nhÃ¢n vÄ© Ä‘áº¡i há»¡i, xin hÃ£y há»“i Ä‘Ã¡p cho tÃ­n Ä‘á»“ thÃ nh kÃ­nh {{user}} cá»§a ngÃ i Ä‘i mÃ ......',
            'Má»™ng Tinh Ä‘áº¡i nhÃ¢n, chÃºng con kÃ­nh yÃªu ngÃ i!! Xin hÃ£y há»“i Ä‘Ã¡p cho con Ä‘i!!',
            'Má»™ng Tinh Ä‘áº¡i nhÃ¢n Ä‘ang pháº£n há»“i yÃªu cáº§u cá»§a báº¡n, sáº½ há»“i Ä‘Ã¡p trong báº£y ngÃ y lÃ m viá»‡c',
            'Äang cáº§u nguyá»‡n vá»›i Má»™ng Tinh vÄ© Ä‘áº¡i...... huhuhu ngÆ°á»i nhanh lÃªn má»™t chÃºt Ä‘Æ°á»£c khÃ´ng',
			'Äang cáº§u xin Decal tá»‘t bá»¥ng thÆ°Æ¡ng xÃ³t......'
          ],

          showWaitingMessage() {
            this.hideWaitingMessage(); // Ensure only one is visible
            const message = this.waitingMessages[Math.floor(Math.random() * this.waitingMessages.length)];
            const msgElement = document.createElement('div');
            msgElement.id = 'waiting-popup';
            msgElement.className = 'waiting-popup';
            // Update HTML structure to include spinner
            msgElement.innerHTML = `
              <div class="waiting-spinner"></div>
              <span>${message}</span>
            `;
            const container = document.querySelector('.guixu-root-container');
            if (container) {
                container.appendChild(msgElement);
            }
          },

          hideWaitingMessage() {
              const existingMsg = document.getElementById('waiting-popup');
              if (existingMsg) {
                  existingMsg.remove();
              }
          },

          // --- æ–°å¢ï¼šè§†å›¾åˆ‡æ¢æ ¸å¿ƒåŠŸèƒ½ ---
          toggleViewMode() {
            this.isMobileView = !this.isMobileView;
            const container = document.querySelector('.guixu-root-container');
            const btn = document.getElementById('view-toggle-btn');
            if (container && btn) {
              if (this.isMobileView) {
                container.classList.add('mobile-view');
                btn.textContent = 'ğŸ’»'; // Switch to desktop icon
                btn.title = 'Chuyá»ƒn sang giao diá»‡n mÃ¡y tÃ­nh';
              } else {
                container.classList.remove('mobile-view');
                btn.textContent = 'ğŸ“±'; // Switch to mobile icon
                btn.title = 'Chuyá»ƒn sang giao diá»‡n di Ä‘á»™ng';
              }
            }
            this.saveViewMode();
          },
		  
		  /* THÃŠM Má»šI: HÃ m xá»­ lÃ½ Fullscreen */
          toggleFullscreen() {
            const container = document.querySelector('.guixu-root-container');
            if (!container) return;

            // Kiá»ƒm tra xem cÃ³ pháº§n tá»­ nÃ o Ä‘ang á»Ÿ cháº¿ Ä‘á»™ toÃ n mÃ n hÃ¬nh khÃ´ng
            const isFullscreen = document.fullscreenElement || document.webkitFullscreenElement;

            if (!isFullscreen) {
              // Náº¿u khÃ´ng, yÃªu cáº§u vÃ o cháº¿ Ä‘á»™ toÃ n mÃ n hÃ¬nh
              if (container.requestFullscreen) {
                container.requestFullscreen().catch(err => {
                  console.error(`Lá»—i khi cá»‘ gáº¯ng báº­t cháº¿ Ä‘á»™ toÃ n mÃ n hÃ¬nh: ${err.message} (${err.name})`);
                });
              } else if (container.webkitRequestFullscreen) { // DÃ nh cho Safari
                container.webkitRequestFullscreen();
              }
            } else {
              // Náº¿u cÃ³, thoÃ¡t khá»i cháº¿ Ä‘á»™ toÃ n mÃ n hÃ¬nh
              if (document.exitFullscreen) {
                document.exitFullscreen();
              } else if (document.webkitExitFullscreen) { // DÃ nh cho Safari
                document.webkitExitFullscreen();
              }
            }
          },

          saveViewMode() {
            try {
              localStorage.setItem('guixu_view_mode', this.isMobileView ? 'mobile' : 'desktop');
            } catch (e) {
              console.error('LÆ°u cháº¿ Ä‘á»™ xem tháº¥t báº¡i:', e);
            }
          },

          loadViewMode() {
            try {
              const savedMode = localStorage.getItem('guixu_view_mode');
              // ä»…å½“ä¿å­˜çš„æ¨¡å¼ä¸º 'mobile' æ—¶ï¼Œæ‰åœ¨åŠ è½½æ—¶åˆ‡æ¢åˆ°ç§»åŠ¨è§†å›¾
              if (savedMode === 'mobile') {
                this.isMobileView = true; // è®¾ç½®åˆå§‹çŠ¶æ€
                const container = document.querySelector('.guixu-root-container');
                const btn = document.getElementById('view-toggle-btn');
                if (container && btn) {
                  container.classList.add('mobile-view');
                  btn.textContent = 'ğŸ’»';
                  btn.title = 'Chuyá»ƒn sang giao diá»‡n mÃ¡y tÃ­nh';
                }
              } else {
                this.isMobileView = false; // ç¡®ä¿é»˜è®¤æ˜¯æ¡Œé¢è§†å›¾
              }
            } catch (e) {
              console.error('Táº£i cháº¿ Ä‘á»™ xem tháº¥t báº¡i:', e);
            }
          },

          formatMessageContent(text) {
            if (!text) return '';
            // é¦–å…ˆï¼Œå¤„ç†æ¢è¡Œç¬¦ã€‚AIå“åº”ä¼¼ä¹ä½¿ç”¨æ–‡å­—â€œ\\nâ€ã€‚
            let processedText = text.replace(/\\n/g, '<br />');

            // è¯­è¨€: â€œ...â€ æˆ– ã€Œ...ã€ -> ä¿ç•™å¼•å·, åº”ç”¨æ ·å¼
            processedText = processedText.replace(/(â€œ[^â€]+â€|ã€Œ[^ã€]+ã€)/g, match => {
              return `<span class="text-language">${match}</span>`;
            });

            // å¿ƒç†: *...* -> ç§»é™¤æ˜Ÿå·, åº”ç”¨æ ·å¼
            processedText = processedText.replace(/\*([^*]+)\*/g, (match, p1) => {
              return `<span class="text-psychology">${p1}</span>`;
            });

            // æ™¯ç‰©: ã€...ã€‘ -> ç§»é™¤æ‹¬å·, åº”ç”¨æ ·å¼, ä¸”ä¸åŒ¹é…çº¯æ•°å­—å†…å®¹
            processedText = processedText.replace(/ã€([^ã€‘\d]+[^ã€‘]*)ã€‘/g, (match, p1) => {
              return `<span class="text-scenery">${p1}</span>`;
            });

            return processedText;
          },

          async init() {
            console.log('Khá»Ÿi táº¡o trÃ¬nh quáº£n lÃ½ tÆ°Æ¡ng tÃ¡c UI Quy KhÆ°...');
            this.bindStaticListeners();
            this.applyRandomBackground();
            await this.updateDynamicData(); // Initial data load
            this.loadAutoWriteState(); // åŠ è½½è‡ªåŠ¨å†™å…¥çŠ¶æ€
            this.loadNovelModeState(); // åŠ è½½å°è¯´æ¨¡å¼çŠ¶æ€
            this.loadEquipmentState(); // åŠ è½½å·²è£…å¤‡ç‰©å“çŠ¶æ€
            this.loadPendingActions(); // åŠ è½½å¾…å¤„ç†æŒ‡ä»¤
            this.loadViewMode(); // æ–°å¢ï¼šåŠ è½½ç”¨æˆ·ä¿å­˜çš„è§†å›¾æ¨¡å¼
            this.loadUnifiedIndex(); // æ–°å¢ï¼šåŠ è½½ç»Ÿä¸€çš„è¯»å†™åºå·
            this.loadAutoToggleState(); // æ–°å¢ï¼šåŠ è½½è‡ªåŠ¨å¼€å…³çŠ¶æ€
 
              // å·²ç§»é™¤ MESSAGE_SWIPED äº‹ä»¶ç›‘å¬å™¨ï¼Œä»¥é¿å…ä¸æ ¸å¿ƒmvuè„šæœ¬å†²çªã€‚
            // UIåˆ·æ–°ç°åœ¨é€šè¿‡ handleAction å†…éƒ¨çš„ä¸»åŠ¨è°ƒç”¨æ¥å®Œæˆã€‚
          },

          // --- Data Handling ---
          SafeGetValue(obj, path, defaultValue = 'N/A') {
            let keys = Array.isArray(path) ? path : path.split('.');
            let current = obj;
            for (let i = 0; i < keys.length; i++) {
              if (
                current === undefined ||
                current === null ||
                typeof current !== 'object' ||
                !current.hasOwnProperty(keys[i])
              ) {
                return defaultValue;
              }
              current = current[keys[i]];
            }
            if (current === undefined || current === null) {
              return defaultValue;
            }
            if (Array.isArray(current)) {
              if (current.length > 0) {
                const actualValue = current[0];
                if (typeof actualValue === 'boolean') return actualValue;
                return String(actualValue);
              } else {
                return defaultValue;
              }
            }
            if (typeof current === 'boolean') return current;
            return String(current);
          },

          async updateDynamicData() {
            try {
              // åŠ è½½æ ¸å¿ƒmvuæ•°æ®
              const messages = await getChatMessages(getCurrentMessageId());
              if (messages && messages.length > 0 && messages[0].data) {
                // ç¼“å­˜å®Œæ•´çš„ mvu çŠ¶æ€ï¼Œè€Œä¸ä»…ä»…æ˜¯ stat_data
                this.currentMvuState = messages[0].data;
                this.renderUI(this.currentMvuState.stat_data);
              } else {
                console.warn('KhÃ´ng thá»ƒ táº£i dá»¯ liá»‡u mvu tá»« tin nháº¯n hiá»‡n táº¡i.');
              }

              // æ–°å¢ï¼šåŠ è½½å¹¶æ˜¾ç¤ºå½“å‰åœºæ™¯æ­£æ–‡
              // æ­¤å‡½æ•°ç°åœ¨å¤„ç†è‡ªå·±çš„æ–‡æœ¬æ ¼å¼åŒ–ã€‚
              await this.loadAndDisplayCurrentScene();
            } catch (error) {
              console.error('Lá»—i khi cáº­p nháº­t dá»¯ liá»‡u Ä‘á»™ng cá»§a Quy KhÆ°:', error);
            }
          },

          // æ–°å¢ï¼šç»Ÿä¸€çš„UIæ¸²æŸ“å‡½æ•°
          renderUI(data) {
            if (!data) {
              console.warn('Gá»i RenderUI tháº¥t báº¡i: khÃ´ng cÃ³ dá»¯ liá»‡u Ä‘Æ°á»£c cung cáº¥p.');
              return;
            }
            const updateText = (id, value, style = '') => {
              const el = document.getElementById(id);
              if (el) {
                el.innerText = value;
                if (style) {
                  el.setAttribute('style', style);
                }
              }
            };

            // BUGFIX: Per the variable definition, the actual value is the first element of the array.
            const jingjieValue = this.SafeGetValue(data, 'Cáº£nh Giá»›i Hiá»‡n Táº¡i.0', '...');
            const match = jingjieValue.match(/^(\S{2})/);
            const jingjieTier = match ? match[1] : '';
            const jingjieStyle = this.getTierStyle(jingjieTier);
            updateText('val-jingjie', jingjieValue, jingjieStyle);
            updateText('val-jinian', this.SafeGetValue(data, 'NiÃªn Äáº¡i Thá»i Gian Hiá»‡n Táº¡i'));
            const charge = this.SafeGetValue(data, 'Thá»i Gian Náº¡p Quy KhÆ°', '0');
            updateText('val-guixu-charge-text', `${charge}%`);
            const chargeBar = document.getElementById('bar-guixu-charge');
            if (chargeBar) chargeBar.style.setProperty('--guixu-charge', `${charge}%`);

            // æ­¤å¤„ä¸å†éœ€è¦å¡«å…… this.baseAttributesï¼Œå› ä¸º updateDisplayedAttributes ä¼šç›´æ¥ä» stat_data è¯»å–
            
            this.updateTalentAndLinggen(data);
            this.loadEquipmentFromMVU(data);
            this.updateDisplayedAttributes(); // æ ¸å¿ƒæ¸²æŸ“å‡½æ•°

            const statusWrapper = document.getElementById('status-effects-wrapper');
            if (statusWrapper) {
              const statuses = _.get(data, 'Tráº¡ng ThÃ¡i Hiá»‡n Táº¡i.0', []);
              if (Array.isArray(statuses) && statuses.length > 0 && statuses[0] !== '$__META_EXTENSIBLE__$') {
                statusWrapper.innerHTML = statuses
                  .map(s => {
                    let statusText = 'Tráº¡ng thÃ¡i khÃ´ng xÃ¡c Ä‘á»‹nh';
                    if (typeof s === 'string') {
                      statusText = s;
                    } else if (typeof s === 'object' && s !== null) {
                      statusText = this.SafeGetValue(s, 'name', 'Tráº¡ng thÃ¡i khÃ´ng xÃ¡c Ä‘á»‹nh');
                    }
                    return `<div class="status-effect"><div class="effect-icon"></div><span>${statusText}</span></div>`;
                  })
                  .join('');
              } else {
                statusWrapper.innerHTML =
                  '<div class="status-effect"><div class="effect-icon"></div><span>Hiá»‡n khÃ´ng cÃ³ tráº¡ng thÃ¡i hiá»‡u á»©ng</span></div>';
              }
            }
          },

          // --- Event Listeners for Buttons and Modals ---
          bindStaticListeners() {
            if (this.listenersBound) return; // å¦‚æœå·²ç»ç»‘å®šè¿‡ï¼Œåˆ™ç›´æ¥è¿”å›
			/* THÃŠM Má»šI: TrÃ¬nh láº¯ng nghe sá»± kiá»‡n click Fullscreen */
            document.getElementById('fullscreen-toggle-btn')?.addEventListener('click', () => this.toggleFullscreen());
            // æ–°å¢ï¼šä¸ºè§†å›¾åˆ‡æ¢æŒ‰é’®ç»‘å®šç›‘å¬å™¨
            document.getElementById('view-toggle-btn')?.addEventListener('click', () => this.toggleViewMode());
            
            // æ–°å¢ï¼šä¸ºä¸–ç•Œä¹¦åºå·è¾“å…¥æ¡†ç»‘å®šç›‘å¬
            // æ–°å¢ï¼šä¸ºç»Ÿä¸€çš„åºå·è¾“å…¥æ¡†ç»‘å®šç›‘å¬
            document.getElementById('unified-index-input')?.addEventListener('change', (e) => {
                const newIndex = parseInt(e.target.value, 10);
                if (!isNaN(newIndex) && newIndex > 0) {
                    this.unifiedIndex = newIndex;
                    this.saveUnifiedIndex();
                    this.showTemporaryMessage(`Sá»‘ thá»© tá»± Ä‘á»c/ghi Lorebook Ä‘Ã£ cáº­p nháº­t thÃ nh ${newIndex}`);
                    // å¦‚æœè‡ªåŠ¨å¼€å…³æ˜¯å¼€å¯çš„ï¼Œç«‹å³æ›´æ–°å¯ç”¨çš„æ¡ç›®
                    if (this.isAutoToggleLorebookEnabled) {
                        this.startAutoTogglePolling();
                    }
                } else {
                    e.target.value = this.unifiedIndex; // å¦‚æœè¾“å…¥æ— æ•ˆï¼Œåˆ™æ¢å¤
                }
            });

            // æ–°å¢ï¼šä¸ºè‡ªåŠ¨å¼€å…³ä¸–ç•Œä¹¦å¤é€‰æ¡†ç»‘å®šç›‘å¬
            document.getElementById('auto-toggle-lorebook-checkbox')?.addEventListener('change', (e) => {
                this.isAutoToggleLorebookEnabled = e.target.checked;
                this.saveAutoToggleState();
                this.showTemporaryMessage(`Tá»± Ä‘á»™ng báº­t/táº¯t Lorebook Ä‘Ã£ Ä‘Æ°á»£c ${this.isAutoToggleLorebookEnabled ? 'báº­t' : 'táº¯t'}`);
                if (this.isAutoToggleLorebookEnabled) {
                  this.startAutoTogglePolling();
                } else {
                  this.stopAutoTogglePolling();
                }
            });

            document.getElementById('btn-inventory')?.addEventListener('click', () => this.showInventory());
            document.getElementById('btn-relationships')?.addEventListener('click', () => this.showRelationships());
            document.getElementById('btn-command-center')?.addEventListener('click', () => this.showCommandCenter());
            document
              .getElementById('btn-character-details')
              ?.addEventListener('click', () => this.showCharacterDetails());
            document.getElementById('btn-guixu-system')?.addEventListener('click', () => this.showGuixuSystem());
            document.getElementById('btn-show-extracted')?.addEventListener('click', () => this.showExtractedContent());
            // ä¸»ç•Œé¢çš„ä¸–ç•Œçº¿å›é¡¾æŒ‰é’®
            document.getElementById('btn-view-journey-main')?.addEventListener('click', () => this.showJourney());
            document.getElementById('btn-view-past-lives-main')?.addEventListener('click', () => this.showPastLives());
            document.getElementById('btn-save-load-manager')?.addEventListener('click', () => this.showSaveLoadManager());
            document.getElementById('btn-clear-all-saves')?.addEventListener('click', () => this.clearAllSaves());
            // æ—¶é—´çº¿å¤‡ä»½/æ¢å¤äº‹ä»¶ç›‘å¬å™¨å·²ç§»é™¤ï¼ŒåŠŸèƒ½å·²é›†æˆåˆ°å­˜æ¡£ç³»ç»Ÿä¸­
 
              // ä¸ºå†™å…¥ä¸–ç•Œä¹¦æŒ‰é’®ç»‘å®šç›‘å¬å™¨
             document
              .getElementById('btn-write-journey')
              ?.addEventListener('click', () => this.writeJourneyToLorebook());
            document
              .getElementById('btn-write-past-lives')
              ?.addEventListener('click', () => this.writePastLivesToLorebook());
            document
              .getElementById('btn-write-novel-mode')
              ?.addEventListener('click', () => this.writeNovelModeToLorebook());

            document
              .getElementById('btn-write-character-card')
              ?.addEventListener('click', () => this.writeCharacterCardToLorebook());
            // ä¸ºè‡ªåŠ¨å†™å…¥å¤é€‰æ¡†ç»‘å®šç›‘å¬å™¨ï¼Œå¹¶å¢åŠ çŠ¶æ€ä¿å­˜
            const autoWriteCheckbox = document.getElementById('auto-write-checkbox');
            if (autoWriteCheckbox) {
              autoWriteCheckbox.addEventListener('change', e => {
                this.isAutoWriteEnabled = e.target.checked;
                this.saveAutoWriteState(this.isAutoWriteEnabled);
                this.showTemporaryMessage(`Tá»± Ä‘á»™ng ghi HÃ nh trÃ¬nh/Gá»£n sÃ³ng Ä‘Ã£ ${this.isAutoWriteEnabled ? 'báº­t' : 'táº¯t'}`);
                if (this.isAutoWriteEnabled) {
                  this.startAutoWritePolling();
                } else {
                  this.stopAutoWritePolling();
                }
              });
            }

            // ä¸ºå°è¯´æ¨¡å¼å¤é€‰æ¡†ç»‘å®šç›‘å¬å™¨
            const novelModeCheckbox = document.getElementById('novel-mode-enabled-checkbox');
            if (novelModeCheckbox) {
              novelModeCheckbox.addEventListener('change', e => {
                this.isNovelModeEnabled = e.target.checked;
                this.saveNovelModeState(this.isNovelModeEnabled);
                this.showTemporaryMessage(`Tá»± Ä‘á»™ng ghi cháº¿ Ä‘á»™ tiá»ƒu thuyáº¿t Ä‘Ã£ ${this.isNovelModeEnabled ? 'báº­t' : 'táº¯t'}`);

                // æ–°é€»è¾‘ï¼šæ­¤å¼€å…³åªæ§åˆ¶è½®è¯¢ï¼Œä¸è§¦å‘UIåˆ·æ–°
                if (this.isNovelModeEnabled) {
                  this.startNovelModeAutoWritePolling();
                } else {
                  this.stopNovelModeAutoWritePolling();
                }

                // æ‰‹åŠ¨æ›´æ–°æ ‡ç­¾æ–‡æœ¬ä»¥æä¾›å³æ—¶åé¦ˆ
                const label = document.querySelector('label[for="novel-mode-enabled-checkbox"]');
                if (label) {
                  label.textContent = `Báº­t cháº¿ Ä‘á»™ tiá»ƒu thuyáº¿t`; // Restore original text
                }
                // åˆ·æ–°æ‰“å¼€çš„æ¨¡æ€æ¡†ä»¥æ›´æ–°æŒ‰é’®çŠ¶æ€å’Œæç¤º
                if (document.getElementById('extracted-content-modal').style.display === 'flex') {
                  this.showExtractedContent();
                }
              });
            }

            // æŒ‡ä»¤ä¸­å¿ƒæŒ‰é’®
            document
              .getElementById('btn-execute-commands')
              ?.addEventListener('click', () => this.executePendingActions());
            document.getElementById('btn-clear-commands')?.addEventListener('click', () => this.clearPendingActions());
            document.getElementById('btn-refresh-storage')?.addEventListener('click', () => this.refreshLocalStorage());

            document
              .querySelectorAll('.modal-close-btn')
              .forEach(btn => btn.addEventListener('click', () => this.closeAllModals()));
            document.querySelectorAll('.modal-overlay').forEach(overlay => {
              overlay.addEventListener('click', e => {
                if (e.target === overlay) this.closeAllModals();
              });
            });

            // äº‹ä»¶å§”æ‰˜ï¼šèƒŒåŒ…å†…çš„ç‚¹å‡»äº‹ä»¶
            const inventoryModalBody = document.querySelector('#inventory-modal .modal-body');
            if (inventoryModalBody) {
              inventoryModalBody.addEventListener('click', e => {
                if (e.target.classList.contains('item-equip-btn')) {
                  const itemElement = e.target.closest('.inventory-item');
                  const itemData = JSON.parse(itemElement.dataset.itemDetails.replace(/'/g, "'") || '{}');
                  const category = itemElement.dataset.category;
                  // æ–°å¢ï¼šå¤„ç†åŠŸæ³•è£…å¤‡æŒ‰é’®
                  if (e.target.dataset.equipType === 'zhuxiu') {
                    this.equipItem(itemData, category, e.target, 'zhuxiuGongfa');
                  } else if (e.target.dataset.equipType === 'fuxiu') {
                    this.equipItem(itemData, category, e.target, 'fuxiuXinfa');
                  } else {
                    this.equipItem(itemData, category, e.target);
                  }
                } else if (e.target.classList.contains('item-use-btn')) {
                  const itemElement = e.target.closest('.inventory-item');
                  const itemData = JSON.parse(itemElement.dataset.itemDetails.replace(/'/g, "'") || '{}');
                  this.useItem(itemData, e.target);
                } else if (e.target.classList.contains('item-unequip-btn')) {
                  const slotId = e.target.dataset.slotId;
                  const slotElement = document.getElementById(slotId);
                  if (slotElement) {
                    this.unequipItem(slotId, slotElement, true, true); // ä»èƒŒåŒ…å¸è½½ï¼Œéœ€è¦åˆ·æ–°èƒŒåŒ…UI
                  }
                } else if (e.target.classList.contains('item-discard-btn')) {
                  const itemElement = e.target.closest('.inventory-item');
                  const itemData = JSON.parse(itemElement.dataset.itemDetails.replace(/'/g, "'") || '{}');
                  const category = itemElement.dataset.category;
                  this.discardItem(itemData, category, itemElement);
                }
              });
            }

            // äº‹ä»¶å§”æ‰˜ï¼šå·¦ä¾§è£…å¤‡é¢æ¿çš„äº‹ä»¶
            const characterPanel = document.querySelector('.character-panel');
            if (characterPanel) {
              // æ‚¬æµ®æ˜¾ç¤ºTooltip
              characterPanel.addEventListener('mouseover', e => {
                const slot = e.target.closest('.equipment-slot');
                if (slot && slot.classList.contains('equipped')) {
                  this.showEquipmentTooltip(slot, e);
                }
              });
              characterPanel.addEventListener('mouseout', e => {
                const slot = e.target.closest('.equipment-slot');
                if (slot) {
                  this.hideEquipmentTooltip();
                }
              });
              // ç‚¹å‡»å¸è½½è£…å¤‡
              characterPanel.addEventListener('click', e => {
                const slot = e.target.closest('.equipment-slot');
                if (slot && slot.classList.contains('equipped')) {
                  this.unequipItem(slot.id, slot, true, false); // ä»ä¸»é¢æ¿å¸è½½ï¼Œä¸éœ€è¦å¼¹å‡ºèƒŒåŒ…
                }
              });
            }

            // ä¸ºå¿«é€Ÿå‘é€æŒ‰é’®ç»‘å®šäº‹ä»¶
            document.getElementById('btn-quick-send')?.addEventListener('click', () => this.executeQuickSend());

            // æ–°å¢ï¼šä¸ºâ€œå½“å‰æŒ‡ä»¤â€æŒ‰é’®ç»‘å®šäº‹ä»¶
            document.getElementById('btn-quick-commands')?.addEventListener('click', e => {
              e.stopPropagation(); // é˜²æ­¢è§¦å‘documentçš„ç‚¹å‡»äº‹ä»¶
              this.toggleQuickCommands();
            });

            // æ–°å¢ï¼šä¸ºæŒ‡ä»¤åˆ—è¡¨é¡¹ç»‘å®šäº‹ä»¶ï¼ˆäº‹ä»¶å§”æ‰˜ï¼‰ - å·²ç§»é™¤ç‚¹å‡»åŠŸèƒ½

            // æ–°å¢ï¼šç‚¹å‡»å¤–éƒ¨å…³é—­æŒ‡ä»¤åˆ—è¡¨
            document.addEventListener('click', e => {
              const popup = document.getElementById('quick-command-popup');
              const button = document.getElementById('btn-quick-commands');
              if (popup && button && popup.style.display === 'block') {
                if (!popup.contains(e.target) && !button.contains(e.target)) {
                  this.hideQuickCommands();
                }
              }
            });
            this.listenersBound = true; // è®¾ç½®æ ‡å¿—ä½ï¼Œç¡®ä¿æ­¤ä»£ç å—åªè¿è¡Œä¸€æ¬¡
          },
 
            // --- Modal Control ---
           async showGuixuSystem() {
            this.openModal('guixu-system-modal');
            const body = document.querySelector('#guixu-system-modal .modal-body');
            if (!body) return;
            body.innerHTML =
              '<p class="modal-placeholder" style="text-align:center; color:#8b7355; font-size:12px;">Äang káº¿t ná»‘i Ä‘áº¿n Quy KhÆ°...</p>';

            try {
              const messages = await getChatMessages(getCurrentMessageId());
              const stat_data = messages?.[0]?.data?.stat_data;
              if (!stat_data) {
                body.innerHTML =
                  '<p class="modal-placeholder" style="text-align:center; color:#8b7355; font-size:12px;">KhÃ´ng thá»ƒ káº¿t ná»‘i Ä‘áº¿n Quy KhÆ°.</p>';
                return;
              }

              const currentLife = this.SafeGetValue(stat_data, 'Kiáº¿p Thá»© x Hiá»‡n Táº¡i', '1');
              const guixuSpace = this.SafeGetValue(stat_data, 'KhÃ´ng Gian Quy KhÆ°', 'KhÃ´ng cÃ³ gÃ¬');
              const currentChoice = this.SafeGetValue(stat_data, 'Lá»±a Chá»n Quy KhÆ° Kiáº¿p NÃ y', 'KhÃ´ng');
              const chargeTime = this.SafeGetValue(stat_data, 'Thá»i Gian Náº¡p Quy KhÆ°', '0');
              const shengli = this.SafeGetValue(stat_data, 'Tuá»•i Sinh LÃ½', 'N/A');
              const shengliMax = this.SafeGetValue(stat_data, 'Giá»›i Háº¡n Tuá»•i Sinh LÃ½', 'N/A');
              const xinli = this.SafeGetValue(stat_data, 'Tuá»•i TÃ¢m LÃ½', 'N/A');
              const xinliMax = this.SafeGetValue(stat_data, 'Giá»›i Háº¡n Tuá»•i TÃ¢m LÃ½', 'N/A');

              body.innerHTML = `
                    <div class="panel-section">
                        <div class="attributes-list">
                            <div class="attribute-item"><span class="attribute-name">Sá»‘ kiáº¿p hiá»‡n táº¡i</span><span class="attribute-value">Kiáº¿p thá»© ${currentLife}</span></div>
                            <div class="attribute-item"><span class="attribute-name">Tuá»•i Sinh LÃ½</span><span class="attribute-value">${shengli} / ${shengliMax}</span></div>
                            <div class="attribute-item"><span class="attribute-name">Tuá»•i TÃ¢m LÃ½</span><span class="attribute-value">${xinli} / ${xinliMax}</span></div>
                            <div class="attribute-item"><span class="attribute-name">KhÃ´ng Gian Quy KhÆ°</span><span class="attribute-value">${guixuSpace}</span></div>
                            <div class="attribute-item"><span class="attribute-name">Lá»±a chá»n kiáº¿p nÃ y</span><span class="attribute-value">${currentChoice}</span></div>
                            <div class="attribute-item" style="margin-top: 15px;"><span class="attribute-name">Quy KhÆ° Náº¡p NÄƒng</span><span class="attribute-value">${chargeTime}%</span></div>
                            <div class="details-progress-bar">
                                <div class="details-progress-fill" style="width: ${chargeTime}%; background: linear-gradient(90deg, #dc143c, #ff6b6b, #ffd700);"></div>
                            </div>
                        </div>
                    </div>
                    <div style="padding: 20px 10px; text-align: center;">
                         <button id="btn-trigger-guixu" class="interaction-btn primary-btn" style="width: 80%; padding: 12px; font-size: 16px;">QUY KHÆ¯</button>
                    </div>
                `;

              // ä¸ºåŠ¨æ€æ·»åŠ çš„æŒ‰é’®ç»‘å®šäº‹ä»¶
              document.getElementById('btn-trigger-guixu').addEventListener('click', () => {
                if (chargeTime >= 100) {
                  this.showCustomConfirm('NgÆ°Æ¡i cÃ³ cháº¯c muá»‘n báº¯t Ä‘áº§u vÃ²ng luÃ¢n há»“i tiáº¿p theo khÃ´ng? Táº¥t cáº£ kÃ½ á»©c chÆ°a Ä‘Æ°á»£c lÆ°u trá»¯ sáº½ tan biáº¿n.', async () => {
                    try {
                      const command = '{{user}} lá»±a chá»n Quy KhÆ°, tháº¿ giá»›i sáº½ trá»Ÿ vá» Ä‘iá»ƒm neo ban Ä‘áº§u';
                      await this.handleAction(command); // Changed to call handleAction
                      this.showTemporaryMessage('LuÃ¢n há»“i Ä‘Ã£ báº¯t Ä‘áº§u...');
                      this.closeAllModals();
                    } catch (error) {
                      console.error('Lá»—i khi thá»±c hiá»‡n lá»‡nh Quy KhÆ°:', error);
                      this.showTemporaryMessage('Thá»±c hiá»‡n lá»‡nh Quy KhÆ° tháº¥t báº¡i!');
                    }
                  });
                } else {
                  this.showTemporaryMessage('Tiáº¿n Ä‘á»™ náº¡p nÄƒng Quy KhÆ° chÆ°a Ä‘á»§');
                }
              });
            } catch (error) {
              console.error('Lá»—i khi táº£i há»‡ thá»‘ng Quy KhÆ°:', error);
              body.innerHTML =
                '<p class="modal-placeholder" style="text-align:center; color:#8b7355; font-size:12px;">Lá»—i khi táº£i dá»¯ liá»‡u.</p>';
            }
          },

          async showCharacterDetails() {
            this.openModal('character-details-modal');
            const body = document.querySelector('#character-details-modal .modal-body');
            if (!body) return;
            body.innerHTML =
              '<p class="modal-placeholder" style="text-align:center; color:#8b7355; font-size:12px;">Äang táº£i dá»¯ liá»‡u nhÃ¢n váº­t...</p>';

            try {
              const messages = await getChatMessages(getCurrentMessageId());
              const stat_data = messages?.[0]?.data?.stat_data;
              if (!stat_data) {
                body.innerHTML =
                  '<p class="modal-placeholder" style="text-align:center; color:#8b7355; font-size:12px;">KhÃ´ng thá»ƒ táº£i dá»¯ liá»‡u nhÃ¢n váº­t.</p>';
                return;
              }

              // ç¡®ä¿ this.baseAttributes å’Œè£…å¤‡åŠ æˆæ˜¯æœ€æ–°çš„
              this.updateDisplayedAttributes();

              // ä»å·²æ¸²æŸ“çš„å·¦ä¾§é¢æ¿è·å–å€¼ï¼Œç¡®ä¿ä¸æ˜¾ç¤ºä¸€è‡´
              const fali = document.getElementById('attr-fali').innerText;
              const shenhai = document.getElementById('attr-shenhai').innerText;
              const daoxin = document.getElementById('attr-daoxin').innerText;
              const kongsu = document.getElementById('attr-kongsu').innerText;
              const qiyun = document.getElementById('attr-qiyun').innerText;
              const shengli = document.getElementById('attr-shengli').innerText;
              const xinli = document.getElementById('attr-xinli').innerText;

              // ä» stat_data è·å–æ–°å¢çš„å€¼
              const xiuxingjindu = this.SafeGetValue(stat_data, 'Tiáº¿n Äá»™ Tu Vi', '0');
              const xiuxingpingjing = this.SafeGetValue(stat_data, 'BÃ¬nh Cáº£nh Tu Vi', 'KhÃ´ng');

              // æ„å»ºHTML
              body.innerHTML = `
                    <div class="panel-section">
                        <div class="section-title">Thuá»™c TÃ­nh Cá»‘t LÃµi <span style="font-size: 10px; color: #8b7355;">(Hiá»‡n táº¡i/Giá»›i háº¡n)</span></div>
                        <div class="attributes-list">
                            <div class="attribute-item"><span class="attribute-name">PhÃ¡p Lá»±c</span><span class="attribute-value">${fali}</span></div>
                            <div class="attribute-item"><span class="attribute-name">Tháº§n Háº£i</span><span class="attribute-value">${shenhai}</span></div>
                            <div class="attribute-item"><span class="attribute-name">Äáº¡o TÃ¢m</span><span class="attribute-value">${daoxin}</span></div>
                            <div class="attribute-item"><span class="attribute-name">KhÃ´ng Tá»‘c</span><span class="attribute-value">${kongsu}</span></div>
                            <div class="attribute-item"><span class="attribute-name">KhÃ­ Váº­n</span><span class="attribute-value">${qiyun}</span></div>
                            <div class="attribute-item"><span class="attribute-name">Tuá»•i Sinh LÃ½</span><span class="attribute-value">${shengli}</span></div>
                            <div class="attribute-item"><span class="attribute-name">Tuá»•i TÃ¢m LÃ½</span><span class="attribute-value">${xinli}</span></div>
                        </div>
                    </div>
                    <div class="panel-section">
                        <div class="section-title">Chi Tiáº¿t Tu Vi</div>
                        <div class="attributes-list">
                            <div class="attribute-item">
                                <span class="attribute-name">Tiáº¿n Äá»™ Tu Vi</span>
                                <span class="attribute-value">${xiuxingjindu}%</span>
                            </div>
                            <div class="details-progress-bar">
                                <div class="details-progress-fill" style="width: ${xiuxingjindu}%;"></div>
                            </div>
                            <div class="attribute-item" style="margin-top: 8px;">
                                <span class="attribute-name">BÃ¬nh Cáº£nh Hiá»‡n Táº¡i</span>
                                <span class="attribute-value">${xiuxingpingjing}</span>
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
              console.error('Lá»—i khi táº£i chi tiáº¿t nhÃ¢n váº­t:', error);
              body.innerHTML =
                '<p class="modal-placeholder" style="text-align:center; color:#8b7355; font-size:12px;">Lá»—i khi táº£i dá»¯ liá»‡u.</p>';
            }
          },

          openModal(modalId) {
            this.closeAllModals();
            const modal = document.getElementById(modalId);
            if (modal) modal.style.display = 'flex';
          },

          closeAllModals() {
            document.querySelectorAll('.modal-overlay').forEach(modal => {
              modal.style.display = 'none';
            });
          },

          showCustomConfirm(message, onConfirm) {
            const modal = document.getElementById('custom-confirm-modal');
            const messageEl = document.getElementById('custom-confirm-message');
            const okBtn = document.getElementById('custom-confirm-btn-ok');
            const cancelBtn = document.getElementById('custom-confirm-btn-cancel');

            if (!modal || !messageEl || !okBtn || !cancelBtn) return;

            messageEl.textContent = message;

            // ä½¿ç”¨ .cloneNode(true) æ¥ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨
            const newOkBtn = okBtn.cloneNode(true);
            okBtn.parentNode.replaceChild(newOkBtn, okBtn);

            const newCancelBtn = cancelBtn.cloneNode(true);
            cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);

            newOkBtn.addEventListener('click', () => {
              this.closeAllModals();
              if (typeof onConfirm === 'function') {
                onConfirm();
              }
            });

            newCancelBtn.addEventListener('click', () => {
              this.closeAllModals();
            });

            this.openModal('custom-confirm-modal');
          },

          // --- Feature Implementations (now simplified) ---
          async showInventory() {
            this.openModal('inventory-modal');
            const body = document.querySelector('#inventory-modal .modal-body');
            if (!body) return;

            body.innerHTML =
              '<p class="modal-placeholder" style="text-align:center; color:#8b7355; font-size:12px;">Äang kiá»ƒm kÃª hÃ nh trang...</p>';

            try {
              const messages = await getChatMessages(getCurrentMessageId());
              if (!messages || messages.length === 0 || !messages[0].data || !messages[0].data.stat_data) {
                body.innerHTML =
                  '<p class="modal-placeholder" style="text-align:center; color:#8b7355; font-size:12px;">KhÃ´ng thá»ƒ láº¥y dá»¯ liá»‡u tÃºi Ä‘á»“.</p>';
                console.warn('KhÃ´ng thá»ƒ táº£i stat_data tá»« tin nháº¯n hiá»‡n táº¡i cho tÃºi Ä‘á»“.');
                return;
              }
              const stat_data = messages[0].data.stat_data;
              body.innerHTML = this.renderInventory(stat_data || {});
            } catch (error) {
              console.error('Lá»—i khi táº£i tÃºi Ä‘á»“:', error);
              body.innerHTML = `<p class="modal-placeholder" style="text-align:center; color:#8b7355; font-size:12px;">Lá»—i khi táº£i tÃºi Ä‘á»“: ${error.message}</p>`;
            }
          },

          async showRelationships() {
            this.openModal('relationships-modal');
            const body = document.querySelector('#relationships-modal .modal-body');
            if (!body) return;

            body.innerHTML =
              '<p class="modal-placeholder" style="text-align:center; color:#8b7355; font-size:12px;">Äang sáº¯p xáº¿p láº¡i cÃ¡c má»‘i nhÃ¢n duyÃªn...</p>';

            try {
              const messages = await getChatMessages(getCurrentMessageId());
              if (!messages || messages.length === 0 || !messages[0].data || !messages[0].data.stat_data) {
                body.innerHTML =
                  '<p class="modal-placeholder" style="text-align:center; color:#8b7355; font-size:12px;">KhÃ´ng thá»ƒ láº¥y dá»¯ liá»‡u quan há»‡ nhÃ¢n váº­t.</p>';
                return;
              }
              const stat_data = messages[0].data.stat_data;
              let relationships = stat_data['Danh SÃ¡ch Quan Há»‡ NhÃ¢n Váº­t']?.[0];

              // **å…³é”®ä¿®å¤**: å¤„ç†ä»mvuåŠ è½½çš„æ•°æ®å¯èƒ½æ˜¯å­—ç¬¦ä¸²åŒ–JSONçš„æƒ…å†µ
              if (typeof relationships === 'string') {
                try {
                  relationships = JSON.parse(relationships);
                } catch (e) {
                  console.error('PhÃ¢n tÃ­ch chuá»—i danh sÃ¡ch quan há»‡ nhÃ¢n váº­t tháº¥t báº¡i:', e);
                  relationships = []; // Treat as an empty array on parse failure
                }
              }

              body.innerHTML = this.renderRelationships(relationships || []);
            } catch (error) {
              console.error('Lá»—i khi táº£i quan há»‡ nhÃ¢n váº­t:', error);
              body.innerHTML = `<p class="modal-placeholder" style="text-align:center; color:#8b7355; font-size:12px;">Lá»—i khi táº£i quan há»‡ nhÃ¢n váº­t: ${error.message}</p>`;
            }
          },

          renderRelationships(relationships) {
            if (
              !Array.isArray(relationships) ||
              relationships.length === 0 ||
              relationships[0] === '$__META_EXTENSIBLE__$'
            ) {
              return '<p class="modal-placeholder" style="text-align:center; color:#8b7355; font-size:12px;">Há»“ng tráº§n tháº¿ tá»¥c, táº¡m thá»i khÃ´ng vÆ°á»›ng báº­n.</p>';
            }

            let html = '';
            relationships.forEach(rawRel => {
              try {
                const rel = typeof rawRel === 'string' ? JSON.parse(rawRel) : rawRel;

                const name = this.SafeGetValue(rel, 'name', 'NgÆ°á»i vÃ´ danh');
                const tier = this.SafeGetValue(rel, 'tier', 'PhÃ m nhÃ¢n');
                const level = this.SafeGetValue(rel, 'Cáº¥p Äá»™', '');
                const relationship = this.SafeGetValue(rel, 'relationship', 'BÃ¨o nÆ°á»›c gáº·p nhau');
                const description = this.SafeGetValue(rel, 'description', 'ThÃ¢n tháº¿ khÃ´ng rÃµ');
                const favorability = parseInt(this.SafeGetValue(rel, 'favorability', 0), 10);
                const eventHistory = rel.event_history || [];

                const tierStyle = this.getTierStyle(tier);
                const favorabilityPercent = Math.max(0, Math.min(100, (favorability / 200) * 100)); // å‡è®¾å¥½æ„Ÿåº¦ä¸Šé™ä¸º200
                const cultivationDisplay = level ? `${tier} ${level}` : tier;

                html += `
                            <div class="relationship-card">
                                <div class="relationship-body">
                                    <p class="relationship-name" style="${tierStyle}">${name}</p>
                                    <p>${description}</p>
                                    
                                    <div class="relationship-meta">
                                        <span>Quan há»‡: ${relationship}</span>
                                        <span>Tu vi: <span style="${tierStyle}">${cultivationDisplay}</span></span>
                                    </div>

                                    <p style="margin-top: 10px;">Thiá»‡n cáº£m: ${favorability}</p>
                                    <div class="favorability-bar-container">
                                        <div class="favorability-bar-fill" style="width: ${favorabilityPercent}%;"></div>
                                    </div>

                                    ${
                                      Array.isArray(eventHistory) && eventHistory.length > 0
                                        ? `
                                    <details class="event-history-details">
                                        <summary class="event-history-summary">Tá»«ng giao háº£o</summary>
                                        <ul class="event-history-list">
                                            ${eventHistory.filter(event => event !== '$__META_EXTENSIBLE__$' && event !== '...').map(event => `<li>${event}</li>`).join('')}
                                        </ul>
                                    </details>
                                    `
                                        : ''
                                    }
                                </div>
                            </div>
                        `;
              } catch (e) {
                console.error('PhÃ¢n tÃ­ch quan há»‡ nhÃ¢n váº­t tháº¥t báº¡i:', rawRel, e);
              }
            });

            return (
              html ||
              '<p class="modal-placeholder" style="text-align:center; color:#8b7355; font-size:12px;">Há»“ng tráº§n tháº¿ tá»¥c, táº¡m thá»i khÃ´ng vÆ°á»›ng báº­n.</p>'
            );
          },

          getTierStyle(tier) {
            const animatedStyle = 'background-size: 200% auto; -webkit-background-clip: text; background-clip: text; color: transparent; animation: god-tier-animation 3s linear infinite; font-weight: bold;';
            const styles = {
              'Luyá»‡n KhÃ­': 'color: #FFFFFF;',
              'TrÃºc CÆ¡': 'color: #66CDAA;',
              'Kim Äan': 'color: #FFD700;',
              'NguyÃªn Anh': `background: linear-gradient(90deg, #DA70D6, #BA55D3, #9932CC, #BA55D3, #DA70D6); ${animatedStyle}`,
              'HÃ³a Tháº§n': `background: linear-gradient(90deg, #DC143C, #FF4500, #B22222, #FF4500, #DC143C); ${animatedStyle}`,
              'Há»£p Thá»ƒ': `background: linear-gradient(90deg, #C71585, #FF1493, #DB7093, #FF1493, #C71585); ${animatedStyle}`,
              'Phi ThÄƒng': `background: linear-gradient(90deg, #FF416C, #FF4B2B, #FF6B6B, #FF4B2B, #FF416C); ${animatedStyle}`,
              'Tháº§n Kiá»u': `background: linear-gradient(90deg, #cccccc, #ffffff, #bbbbbb, #ffffff, #cccccc); ${animatedStyle}`,
            };
            const baseStyle = 'font-style: italic;';
            return (styles[tier] || 'color: #e0dcd1;') + baseStyle;
          },

          // --- æ–°å¢ï¼šå“é˜¶æ’åºæ ¸å¿ƒå‡½æ•° ---
          getTierOrder(tier) {
            // Tier level mapping: higher value means higher tier
            // Supports two tier systems:
            // 1. Item Tiers: Tháº§n Pháº©m > TiÃªn Pháº©m > ThiÃªn Pháº©m > Cá»±c Pháº©m > ThÆ°á»£ng Pháº©m > Trung Pháº©m > Háº¡ Pháº©m > PhÃ m Pháº©m
            // 2. Cultivation Realms: Tháº§n Kiá»u > Phi ThÄƒng > Há»£p Thá»ƒ > HÃ³a Tháº§n > NguyÃªn Anh > Kim Äan > TrÃºc CÆ¡ > Luyá»‡n KhÃ­
            const tierOrder = {
              // ç‰©å“å“é˜¶ç³»ç»Ÿ
              'PhÃ m Pháº©m': 1,
              'Háº¡ Pháº©m': 2,
              'Trung Pháº©m': 3,
              'ThÆ°á»£ng Pháº©m': 4,
              'Cá»±c Pháº©m': 5,
              'ThiÃªn Pháº©m': 6,
              'TiÃªn Pháº©m': 7,
              'Tháº§n Pháº©m': 8,
              
              // ä¿®ä»™å¢ƒç•Œç³»ç»Ÿ
              'TrÃºc CÆ¡': 2,
              'Kim Äan': 3,
              'NguyÃªn Anh': 4,
              'HÃ³a Tháº§n': 5,
              'Há»£p Thá»ƒ': 6,
              'Phi ThÄƒng': 7,
              'Tháº§n Kiá»u': 8
            };
            return tierOrder[tier] || 0; // æœªçŸ¥å“é˜¶æ’åœ¨æœ€å‰
          },

          // --- æ–°å¢ï¼šé€šç”¨å“é˜¶æ’åºå‡½æ•° ---
          sortByTier(items, getTierFn) {
            if (!Array.isArray(items)) return items;
            
            return [...items].sort((a, b) => {
              const tierA = getTierFn(a);
              const tierB = getTierFn(b);
              const orderA = this.getTierOrder(tierA);
              const orderB = this.getTierOrder(tierB);
              
              // æŒ‰å“é˜¶ä»é«˜åˆ°ä½æ’åºï¼Œæ”¯æŒä¸¤ç§å“é˜¶ç³»ç»Ÿï¼š
              // Item Tiers: Tháº§n Pháº©m > TiÃªn Pháº©m > ... > PhÃ m Pháº©m
              // Cultivation Realms: Tháº§n Kiá»u > Phi ThÄƒng > ... > Luyá»‡n KhÃ­
              // å¦‚æœå“é˜¶ç›¸åŒï¼Œåˆ™ä¿æŒåŸæœ‰é¡ºåºï¼ˆç¨³å®šæ’åºï¼‰
              if (orderA === orderB) {
                return 0;
              }
              return orderB - orderA;
            });
          },

          getTierColorStyle(tier) {
            const tierColors = {
              'PhÃ m Pháº©m': '#FFFFFF',
              'Háº¡ Pháº©m': '#66CDAA',
              'Trung Pháº©m': '#FFD700',
              'ThÆ°á»£ng Pháº©m': 'linear-gradient(90deg, #DA70D6, #BA55D3, #9932CC, #BA55D3, #DA70D6)',
              'Cá»±c Pháº©m': 'linear-gradient(90deg, #DC143C, #FF4500, #B22222, #FF4500, #DC143C)',
              'ThiÃªn Pháº©m': 'linear-gradient(90deg, #C71585, #FF1493, #DB7093, #FF1493, #C71585)',
              'TiÃªn Pháº©m': 'linear-gradient(90deg, #FF416C, #FF4B2B, #FF6B6B, #FF4B2B, #FF416C)',
              'Tháº§n Pháº©m': 'linear-gradient(90deg, #cccccc, #ffffff, #bbbbbb, #ffffff, #cccccc)',
            };

            const animatedTiers = ['ThÆ°á»£ng Pháº©m', 'Cá»±c Pháº©m', 'ThiÃªn Pháº©m', 'TiÃªn Pháº©m', 'Tháº§n Pháº©m'];
            const color = tierColors[tier] || '#e0dcd1';

            if (animatedTiers.includes(tier)) {
              return `background: ${color}; background-size: 200% auto; -webkit-background-clip: text; background-clip: text; color: transparent; animation: god-tier-animation 3s linear infinite; font-weight: bold;`;
            }

            return `color: ${color};`;
          },

          updateTalentAndLinggen(data) {
            const container = document.getElementById('talent-linggen-list');
            if (!container) return;
            container.innerHTML = '';

            let html = '';

            // 1. å¤„ç†çµæ ¹åˆ—è¡¨ - æ·»åŠ å“é˜¶æ’åº
            const linggenList = _.get(data, 'Danh SÃ¡ch Linh CÄƒn.0', []);
            if (Array.isArray(linggenList) && linggenList.length > 0 && linggenList[0] !== '$__META_EXTENSIBLE__$') {
              // è§£æå¹¶æ’åºçµæ ¹
              const parsedLinggenList = [];
              linggenList.forEach(rawLinggen => {
                try {
                  const linggen = typeof rawLinggen === 'string' ? JSON.parse(rawLinggen) : rawLinggen;
                  if (linggen && typeof linggen === 'object') {
                    parsedLinggenList.push(linggen);
                  }
                } catch (e) {
                  console.error('PhÃ¢n tÃ­ch Linh CÄƒn tháº¥t báº¡i:', rawLinggen, e);
                }
              });

              // Sort Linh CÄƒn by tier (Tháº§n Pháº©m > TiÃªn Pháº©m > ... > PhÃ m Pháº©m)
              const sortedLinggenList = this.sortByTier(parsedLinggenList, (linggen) =>
                this.SafeGetValue(linggen, 'Pháº©m Giai', 'PhÃ m Pháº©m')
              );

              sortedLinggenList.forEach(linggen => {
                const name = this.SafeGetValue(linggen, 'TÃªn', 'Linh CÄƒn khÃ´ng rÃµ');
                const tier = this.SafeGetValue(linggen, 'Pháº©m Giai', 'PhÃ m Pháº©m');
                const description = this.SafeGetValue(linggen, 'MÃ´ táº£', 'KhÃ´ng cÃ³ mÃ´ táº£');
                const tierStyle = this.getTierColorStyle(tier);
                const itemDetailsHtml = this.renderItemDetailsForInventory(linggen);

                html += `
                     <details class="details-container">
                         <summary>
                             <span class="attribute-name">Linh CÄƒn</span>
                             <span class="attribute-value" style="${tierStyle}">ã€${tier}ã€‘ ${name}</span>
                         </summary>
                         <div class="details-content">
                             <p>${description}</p>
                             ${itemDetailsHtml ? `<div class="item-details">${itemDetailsHtml}</div>` : ''}
                         </div>
                     </details>
                 `;
              });
            } else {
                 html += `
                   <div class="attribute-item">
                       <span class="attribute-name">Linh CÄƒn</span>
                       <span class="attribute-value">ChÆ°a thá»©c tá»‰nh</span>
                   </div>
               `;
            }

            // 2. å¤„ç†å¤©èµ‹åˆ—è¡¨ - æ·»åŠ å“é˜¶æ’åº
            const tianfuList = _.get(data, 'Danh SÃ¡ch ThiÃªn PhÃº.0', []);
            if (Array.isArray(tianfuList) && tianfuList.length > 0 && tianfuList[0] !== '$__META_EXTENSIBLE__$') {
              // è§£æå¹¶æ’åºå¤©èµ‹
              const parsedTianfuList = [];
              tianfuList.forEach(rawTianfu => {
                try {
                  const tianfu = typeof rawTianfu === 'string' ? JSON.parse(rawTianfu) : rawTianfu;
                  if (tianfu && typeof tianfu === 'object') {
                    parsedTianfuList.push(tianfu);
                  }
                } catch (e) {
                  console.error('PhÃ¢n tÃ­ch ThiÃªn PhÃº tháº¥t báº¡i:', rawTianfu, e);
                }
              });

              // Sort ThiÃªn PhÃº by tier (Tháº§n Pháº©m > TiÃªn Pháº©m > ... > PhÃ m Pháº©m)
              const sortedTianfuList = this.sortByTier(parsedTianfuList, (tianfu) =>
                this.SafeGetValue(tianfu, 'tier', 'PhÃ m Pháº©m')
              );

              sortedTianfuList.forEach(tianfu => {
                const name = this.SafeGetValue(tianfu, 'name', 'ThiÃªn PhÃº khÃ´ng rÃµ');
                const tier = this.SafeGetValue(tianfu, 'tier', 'PhÃ m Pháº©m');
                const description = this.SafeGetValue(tianfu, 'description', 'KhÃ´ng cÃ³ mÃ´ táº£');
                const tierStyle = this.getTierColorStyle(tier);
                const itemDetailsHtml = this.renderItemDetailsForInventory(tianfu);

                html += `
                         <details class="details-container">
                             <summary>
                                 <span class="attribute-name">ThiÃªn PhÃº</span>
                                 <span class="attribute-value" style="${tierStyle}">ã€${tier}ã€‘ ${name}</span>
                             </summary>
                             <div class="details-content">
                                 <p>${description}</p>
                                 ${itemDetailsHtml ? `<div class="item-details">${itemDetailsHtml}</div>` : ''}
                             </div>
                         </details>
                     `;
              });
            } else {
              html += `
                   <div class="attribute-item">
                       <span class="attribute-name">ThiÃªn PhÃº</span>
                       <span class="attribute-value">ChÆ°a thá»©c tá»‰nh</span>
                   </div>
               `;
            }

            container.innerHTML = html;
          },

          renderInventory(stat_data) {
            if (!stat_data || Object.keys(stat_data).length === 0) {
              return '<p class="modal-placeholder" style="text-align:center; color:#8b7355; font-size:12px;">Dá»¯ liá»‡u tÃºi Ä‘á»“ trá»‘ng.</p>';
            }

            const categories = [
              { title: 'CÃ´ng PhÃ¡p', key: 'Danh SÃ¡ch CÃ´ng PhÃ¡p', equipable: true },
              { title: 'VÅ© KhÃ­', key: 'Danh SÃ¡ch VÅ© KhÃ­', equipable: true },
              { title: 'PhÃ²ng Cá»¥', key: 'Danh SÃ¡ch PhÃ²ng Cá»¥', equipable: true },
              { title: 'Phá»¥ Kiá»‡n', key: 'Danh SÃ¡ch Phá»¥ Kiá»‡n', equipable: true },
              { title: 'PhÃ¡p Báº£o', key: 'Danh SÃ¡ch PhÃ¡p Báº£o', equipable: true },
              { title: 'Äan DÆ°á»£c', key: 'Danh SÃ¡ch Äan DÆ°á»£c', equipable: false },
              { title: 'Táº¡p Váº­t', key: 'Danh SÃ¡ch KhÃ¡c', equipable: false },
            ];

            let html = '';

            categories.forEach(cat => {
              const rawItems = stat_data?.[cat.key]?.[0];

              html += `<details class="inventory-category" open>`;
              html += `<summary class="inventory-category-title">${cat.title}</summary>`;

              if (Array.isArray(rawItems) && rawItems.length > 0 && rawItems[0] !== '$__META_EXTENSIBLE__$') {
                html += '<div class="inventory-item-list">';
                
                // --- æ–°å¢ï¼šè§£æå¹¶æŒ‰å“é˜¶æ’åºç‰©å“ ---
                const parsedItems = [];
                rawItems.forEach(rawItem => {
                  try {
                    // **å…³é”®ä¿®å¤**: åœ¨å¤„ç†å‰æ£€æŸ¥ rawItem æ˜¯å¦ä¸º null æˆ– undefined
                    if (!rawItem) {
                        console.warn(`PhÃ¡t hiá»‡n má»™t má»¥c váº­t pháº©m trá»‘ng trong danh má»¥c "${cat.title}", Ä‘Ã£ bá» qua.`);
                        return; // è·³è¿‡è¿™ä¸ªæ— æ•ˆçš„æ¡ç›®
                    }
                    const item = typeof rawItem === 'string' ? JSON.parse(rawItem) : rawItem;
                    if (item && typeof item === 'object') {
                      parsedItems.push(item);
                    }
                  } catch (e) {
                    console.error('PhÃ¢n tÃ­ch váº­t pháº©m trong tÃºi Ä‘á»“ tháº¥t báº¡i:', rawItem, e);
                  }
                });

                // Sort items by tier (Tháº§n Pháº©m > TiÃªn Pháº©m > ... > PhÃ m Pháº©m)
                const sortedItems = this.sortByTier(parsedItems, (item) =>
                  this.SafeGetValue(item, 'tier', 'PhÃ m Pháº©m')
                );

                sortedItems.forEach(item => {
                  try {
                    // ç¡®ä¿ä¼ é€’ç»™å‰ç«¯çš„æ•°æ®æ˜¯å®Œæ•´çš„
                    const itemJson = JSON.stringify(item).replace(/'/g, "'");

                    const name = this.SafeGetValue(item, 'name', 'Váº­t pháº©m khÃ´ng rÃµ');
                    const id = this.SafeGetValue(item, 'id', null);
                    const tier = this.SafeGetValue(item, 'tier', 'KhÃ´ng');
                    const hasQuantity = item.hasOwnProperty('quantity');
                    const quantity = parseInt(this.SafeGetValue(item, 'quantity', 1), 10);
                    const description = this.SafeGetValue(
                      item,
                      'description',
                      this.SafeGetValue(item, 'effect', 'KhÃ´ng cÃ³ mÃ´ táº£'),
                    );

                    // **BUGä¿®å¤**: è®¡ç®—æ˜¾ç¤ºæ•°é‡æ—¶ï¼Œå‡å»å¾…å¤„ç†é˜Ÿåˆ—ä¸­çš„ä½¿ç”¨å’Œä¸¢å¼ƒæ•°é‡
                    const pendingUses = this.pendingActions
                      .filter(action => action.action === 'use' && action.itemName === name)
                      .reduce((total, action) => total + action.quantity, 0);
                    const pendingDiscards = this.pendingActions
                      .filter(action => action.action === 'discard' && action.itemName === name)
                      .reduce((total, action) => total + action.quantity, 0);
                    const displayQuantity = quantity - pendingUses - pendingDiscards;

                    // å¦‚æœç‰©å“æ•°é‡ä¸º0æˆ–è´Ÿæ•°ï¼Œè·³è¿‡æ¸²æŸ“ï¼ˆå®ç°å‰ç«¯ä¹è§‚éšè—ï¼‰
                    if (hasQuantity && displayQuantity <= 0) {
                      return; // è·³è¿‡è¿™ä¸ªç‰©å“çš„æ¸²æŸ“
                    }

                    // å¯¹äºè£…å¤‡ç±»ç‰©å“ï¼Œå¦‚æœåœ¨å¾…ä¸¢å¼ƒé˜Ÿåˆ—ä¸­ï¼Œä¹Ÿè·³è¿‡æ¸²æŸ“
                    if (!hasQuantity && pendingDiscards > 0) {
                      return; // è·³è¿‡è¿™ä¸ªç‰©å“çš„æ¸²æŸ“
                    }

                    const tierStyle = this.getTierStyle(tier);
                    const tierDisplay =
                      tier !== 'KhÃ´ng' ? `<span style="${tierStyle} margin-right: 15px;">Pháº©m Giai: ${tier}</span>` : '';
                    const quantityDisplay = hasQuantity ? `<span class="item-quantity">Sá»‘ lÆ°á»£ng: ${displayQuantity}</span>` : '';

                    // **å…³é”®ä¿®å¤**: æ£€æŸ¥ç‰©å“æ˜¯å¦å·²è¢«è£…å¤‡
                    const isEquipped = id ? Object.values(this.equippedItems).some(equippedItem => equippedItem && equippedItem.id === id) : false;
                    let actionButton = '';

                    if (cat.title === 'CÃ´ng PhÃ¡p') {
                      const isEquippedAsMain =
                        id && this.equippedItems.zhuxiuGongfa && this.equippedItems.zhuxiuGongfa.id === id;
                      const isEquippedAsAux =
                        id && this.equippedItems.fuxiuXinfa && this.equippedItems.fuxiuXinfa.id === id;

                      if (isEquippedAsMain) {
                        actionButton = `
                                <button class="item-unequip-btn" data-slot-id="equip-zhuxiuGongfa" style="margin-left: 5px;">ThÃ¡o</button>
                                <button class="item-equip-btn" data-equip-type="fuxiu" style="margin-left: 5px; opacity: 0.5; cursor: not-allowed;" disabled>Phá»¥ Tu</button>
                            `;
                      } else if (isEquippedAsAux) {
                        actionButton = `
                                <button class="item-equip-btn" data-equip-type="zhuxiu" style="margin-left: 5px; opacity: 0.5; cursor: not-allowed;" disabled>Chá»§ Tu</button>
                                <button class="item-unequip-btn" data-slot-id="equip-fuxiuXinfa" style="margin-left: 5px;">ThÃ¡o</button>
                            `;
                      } else {
                        actionButton = `
                                <button class="item-equip-btn" data-equip-type="zhuxiu" style="margin-left: 5px;">Chá»§ Tu</button>
                                <button class="item-equip-btn" data-equip-type="fuxiu" style="margin-left: 5px;">Phá»¥ Tu</button>
                            `;
                      }
                    } else if (cat.equipable) {
                      if (isEquipped) {
                        const slotKey = Object.keys(this.equippedItems).find(
                          key => this.equippedItems[key] && this.equippedItems[key].id === id,
                        );
                        actionButton = `<button class="item-unequip-btn" data-slot-id="equip-${slotKey}">ThÃ¡o</button>`;
                      } else {
                        actionButton = `<button class="item-equip-btn">Trang bá»‹</button>`;
                      }
                    } else if (cat.title === 'Äan DÆ°á»£c' || cat.title === 'Táº¡p Váº­t') {
                      if (displayQuantity <= 0) {
                          actionButton = `<button class="item-use-btn" disabled>ÄÃ£ háº¿t</button>`;
                      } else {
                          actionButton = `<button class="item-use-btn">DÃ¹ng</button>`;
                      }
                    }

                    // ä¸ºæ‰€æœ‰ç‰©å“æ·»åŠ ä¸¢å¼ƒæŒ‰é’®
                    if (cat.title === 'Äan DÆ°á»£c' || cat.title === 'Táº¡p Váº­t') {
                      // æœ‰æ•°é‡çš„ç‰©å“ï¼Œéœ€è¦è¾“å…¥æ•°é‡
                      actionButton += `<button class="item-discard-btn" style="margin-left: 5px; background: #8b0000; border-color: #ff6b6b;">Vá»©t</button>`;
                    } else {
                      // è£…å¤‡ç±»ç‰©å“ï¼Œç›´æ¥ä¸¢å¼ƒ
                      actionButton += `<button class="item-discard-btn" style="margin-left: 5px; background: #8b0000; border-color: #ff6b6b;">Vá»©t</button>`;
                    }

                    let itemDetailsHtml = this.renderItemDetailsForInventory(item);

                    html += `
                                    <div class="inventory-item" data-item-details='${itemJson}' data-category='${
                      cat.title
                    }'>
                                        <div class="item-header">
                                            <div class="item-name-desc">
                                                <span class="item-name" style="${tierStyle}">${name}</span>
                                                <div class="item-description">${description}</div>
                                            </div>
                                            <div class="item-meta" style="text-align: right; white-space: nowrap; display: flex; align-items: center;">
                                                ${tierDisplay}
                                                ${quantityDisplay}
                                                ${actionButton}
                                            </div>
                                        </div>
                                        ${itemDetailsHtml ? `<div class="item-details">${itemDetailsHtml}</div>` : ''}
                                    </div>
                                `;
                  } catch (e) {
                    console.error('PhÃ¢n tÃ­ch váº­t pháº©m trong tÃºi Ä‘á»“ tháº¥t báº¡i:', item, e);
                    html += `<div class="inventory-item"><p class="item-description">Äá»‹nh dáº¡ng dá»¯ liá»‡u váº­t pháº©m bá»‹ lá»—i</p></div>`;
                  }
                });
                html += '</div>';
              } else {
                html += '<div class="inventory-item-list"><p class="empty-category-text">Trá»‘ng rá»—ng</p></div>';
              }
              html += `</details>`;
            });

            return html;
          },

          // --- Tooltip and Equip Logic (é‡æ„å) ---
          renderTooltipContent(item) {
            // æ ¹æ®æœ€æ–°çš„å˜é‡ç»“æ„è§£æ
            const tierStyle = this.getTierStyle(this.SafeGetValue(item, 'tier'));
            const level = this.SafeGetValue(item, 'level', '');
            const tierDisplay = level
              ? `${this.SafeGetValue(item, 'tier', 'PhÃ m Pháº©m')} ${level}`
              : this.SafeGetValue(item, 'tier', 'PhÃ m Pháº©m');

            let attributesHtml = '';
            const attributes = item.attributes_bonus; // ç›´æ¥ä½¿ç”¨æ–°key
            if (typeof attributes === 'object' && attributes !== null && Object.keys(attributes).length > 0) {
              attributesHtml += `<div class="tooltip-section-title">Cá»™ng thÃªm cá»‘ Ä‘á»‹nh</div>`;
              for (const [key, value] of Object.entries(attributes)) {
                attributesHtml += `<p><strong>${key}:</strong> ${value > 0 ? '+' : ''}${value}</p>`;
              }
            }

            const percentBonuses = item['Pháº§n trÄƒm gia tÄƒng'];
            if (typeof percentBonuses === 'object' && percentBonuses !== null && Object.keys(percentBonuses).length > 0) {
              attributesHtml += `<div class="tooltip-section-title" style="margin-top: 5px;">Pháº§n trÄƒm gia tÄƒng</div>`;
              for (const [key, value] of Object.entries(percentBonuses)) {
                 attributesHtml += `<p><strong>${key}:</strong> +${value}</p>`;
              }
            }

            let effectsHtml = '';
            const effects = item.special_effects; // ç›´æ¥ä½¿ç”¨æ–°key
            if (Array.isArray(effects) && effects.length > 0) {
              effectsHtml += `<div class="tooltip-section-title">Thuá»™c tÃ­nh Ä‘áº·c biá»‡t</div>`;
              effectsHtml += effects.filter(eff => eff !== '$__META_EXTENSIBLE__$').map(eff => `<p>${eff}</p>`).join('');
            }

            return `
                    <div class="tooltip-title" style="${tierStyle}">${this.SafeGetValue(item, 'name')}</div>
                    <p><strong>Pháº©m Giai:</strong> ${tierDisplay}</p>
                    <p><i>${this.SafeGetValue(item, 'description', 'KhÃ´ng cÃ³ mÃ´ táº£')}</i></p>
                    ${
                      attributesHtml
                        ? `<div class="tooltip-section tooltip-attributes">${attributesHtml}</div>`
                        : ''
                    }
                    ${effectsHtml ? `<div class="tooltip-section">${effectsHtml}</div>` : ''}
                `;
          },

          showEquipmentTooltip(element, event) {
            const tooltip = document.getElementById('equipment-tooltip');
            const itemDataString = element.dataset.itemDetails;
            if (!tooltip || !itemDataString) return;

            try {
              const item = JSON.parse(itemDataString.replace(/'/g, "'"));
              tooltip.innerHTML = this.renderTooltipContent(item);
              tooltip.style.display = 'block';

              // **å…³é”®ä¿®å¤**: è°ƒæ•´Tooltipä½ç½®ä»¥é˜²æ­¢è¶…å‡ºè§†å£
              const tooltipRect = tooltip.getBoundingClientRect();
              const viewportWidth = window.innerWidth;
              const viewportHeight = window.innerHeight;

              let left = event.pageX + 15;
              let top = event.pageY + 15;

              // å¦‚æœTooltipè¶…å‡ºå³è¾¹ç•Œï¼Œåˆ™æ˜¾ç¤ºåœ¨é¼ æ ‡å·¦ä¾§
              if (left + tooltipRect.width > viewportWidth) {
                left = event.pageX - tooltipRect.width - 15;
              }

              // å¦‚æœTooltipè¶…å‡ºä¸‹è¾¹ç•Œï¼Œåˆ™æ˜¾ç¤ºåœ¨é¼ æ ‡ä¸Šä¾§
              if (top + tooltipRect.height > viewportHeight) {
                top = event.pageY - tooltipRect.height - 15;
              }

              tooltip.style.left = `${left}px`;
              tooltip.style.top = `${top}px`;
            } catch (e) {
              console.error('PhÃ¢n tÃ­ch dá»¯ liá»‡u tooltip trang bá»‹ tháº¥t báº¡i:', e);
            }
          },

          hideEquipmentTooltip() {
            const tooltip = document.getElementById('equipment-tooltip');
            if (tooltip) tooltip.style.display = 'none';
          },

          renderItemDetailsForInventory(item) {
            let attributesHtml = '';
            const attributes = item.attributes_bonus;
            if (typeof attributes === 'object' && attributes !== null && Object.keys(attributes).length > 0) {
              attributesHtml += '<div class="tooltip-section-title" style="margin-top: 5px;">Cá»™ng thÃªm cá»‘ Ä‘á»‹nh</div>';
              for (const [key, value] of Object.entries(attributes)) {
                attributesHtml += `<p><strong>${key}:</strong> ${value > 0 ? '+' : ''}${value}</p>`;
              }
            }

            const percentBonuses = item['Pháº§n trÄƒm gia tÄƒng'];
            if (typeof percentBonuses === 'object' && percentBonuses !== null && Object.keys(percentBonuses).length > 0) {
              attributesHtml += '<div class="tooltip-section-title" style="margin-top: 5px;">Pháº§n trÄƒm gia tÄƒng</div>';
              for (const [key, value] of Object.entries(percentBonuses)) {
                 attributesHtml += `<p><strong>${key}:</strong> +${value}</p>`;
              }
            }

            let effectsHtml = '';
            let effects = item.special_effects;

            // å…³é”®ä¿®å¤ï¼šå¤„ç† special_effects å¯èƒ½æ˜¯å­—ç¬¦ä¸²ï¼ˆç”¨\nåˆ†éš”ï¼‰æˆ–æ•°ç»„ä¸¤ç§æƒ…å†µ
            if (typeof effects === 'string' && effects.trim() !== '') {
                effects = effects.split('\n').map(e => e.trim()).filter(e => e);
            }

            if (Array.isArray(effects) && effects.length > 0) {
              effectsHtml += `<div class="tooltip-section-title" style="margin-top: 5px;">Thuá»™c tÃ­nh Ä‘áº·c biá»‡t</div>`;
              effectsHtml += effects.filter(eff => eff !== '$__META_EXTENSIBLE__$').map(eff => `<p>${eff}</p>`).join('');
            }

            return `${attributesHtml}${effectsHtml}`;
          },

          equipItem(item, category, buttonElement, equipType = null) {
            const itemId = this.SafeGetValue(item, 'id');
            if (!itemId || itemId === 'N/A') {
              this.showTemporaryMessage('Váº­t pháº©m khÃ´ng cÃ³ ID, khÃ´ng thá»ƒ trang bá»‹.');
              return;
            }

            // Bugä¿®å¤ï¼šæ£€æŸ¥åŠŸæ³•æ˜¯å¦å·²è¢«è£…å¤‡åœ¨å¦ä¸€ä¸ªæ§½ä½
            if (category === 'CÃ´ng PhÃ¡p') {
              const isEquippedAsMain = this.equippedItems.zhuxiuGongfa && this.equippedItems.zhuxiuGongfa.id === itemId;
              const isEquippedAsAux = this.equippedItems.fuxiuXinfa && this.equippedItems.fuxiuXinfa.id === itemId;

              if (
                (equipType === 'fuxiuXinfa' && isEquippedAsMain) ||
                (equipType === 'zhuxiuGongfa' && isEquippedAsAux)
              ) {
                this.showTemporaryMessage('CÃ´ng phÃ¡p nÃ y Ä‘Ã£ Ä‘Æ°á»£c trang bá»‹ á»Ÿ Ã´ khÃ¡c.');
                return;
              }
            }

            const categoryMap = { 'VÅ© KhÃ­': 'wuqi', 'PhÃ²ng Cá»¥': 'fangju', 'Phá»¥ Kiá»‡n': 'shipin', 'PhÃ¡p Báº£o': 'fabao1', 'CÃ´ng PhÃ¡p': equipType };
            const slotKey = categoryMap[category];

            if (!slotKey) {
              this.showTemporaryMessage('PhÃ¢n loáº¡i hoáº·c loáº¡i trang bá»‹ khÃ´ng há»£p lá»‡.');
              return;
            }

            // **å…³é”®ä¿®å¤**: æ£€æŸ¥ç‰©å“æ˜¯å¦å·²è£…å¤‡åœ¨å…¶ä»–æ§½ä½ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™å…ˆå¸è½½
            const currentlyEquippedSlot = Object.keys(this.equippedItems).find(
              key => this.equippedItems[key] && this.equippedItems[key].id === itemId,
            );
            if (currentlyEquippedSlot && currentlyEquippedSlot !== slotKey) {
              const oldSlotElement = document.getElementById(`equip-${currentlyEquippedSlot}`);
              if (oldSlotElement) {
                this.unequipItem(`equip-${currentlyEquippedSlot}`, oldSlotElement, false); // é™é»˜å¸è½½
              }
            }

            const slotElement = document.getElementById(`equip-${slotKey}`);
            if (!slotElement) return;

            // å¦‚æœè¯¥æ§½ä½å·²æœ‰è£…å¤‡ï¼Œå…ˆæ‰§è¡Œå¸è½½æ“ä½œ
            const oldItemId = this.equippedItems[slotKey];
            if (oldItemId) {
              this.unequipItem(`equip-${slotKey}`, slotElement, false);
            }

            // æ›´æ–°å‰ç«¯çŠ¶æ€å’ŒUIï¼ˆä¹è§‚æ›´æ–°ï¼‰
            this.equippedItems[slotKey] = item; // **é€»è¾‘ä¿®æ­£**: å­˜å‚¨å®Œæ•´å¯¹è±¡
            const tier = this.SafeGetValue(item, 'tier', 'PhÃ m Pháº©m');
            const tierStyle = this.getTierStyle(tier);
            slotElement.textContent = this.SafeGetValue(item, 'name');
            slotElement.setAttribute('style', tierStyle);
            slotElement.classList.add('equipped');
            slotElement.dataset.itemDetails = JSON.stringify(item).replace(/'/g, "'");

            // æ›´æ–°èƒŒåŒ…UIï¼Œä½¿å…¶èƒ½åæ˜ æœ€æ–°çŠ¶æ€
            if (buttonElement.closest('#inventory-modal')) {
              this.showInventory();
            }

            // æ·»åŠ åˆ°æŒ‡ä»¤é˜Ÿåˆ—ï¼ˆä¼˜åŒ–ï¼šå…ˆç§»é™¤æ—§æŒ‡ä»¤ï¼Œå†æ·»åŠ æ–°æŒ‡ä»¤ï¼‰
            const itemName = this.SafeGetValue(item, 'name');
            const defaultTextMap = {
              wuqi: 'VÅ© KhÃ­',
              fangju: 'PhÃ²ng Cá»¥',
              shipin: 'Phá»¥ Kiá»‡n',
              fabao1: 'PhÃ¡p Báº£o',
              zhuxiuGongfa: 'CÃ´ng PhÃ¡p Chá»§ Tu',
              fuxiuXinfa: 'TÃ¢m PhÃ¡p Phá»¥ Tu',
            };
            const slotFriendlyName = defaultTextMap[slotKey] || category;
            this.pendingActions = this.pendingActions.filter(action => action.itemName !== itemName);
            this.pendingActions.push({
              action: 'equip',
              itemName: itemName,
              category: slotFriendlyName,
            });

            this.showTemporaryMessage(`ÄÃ£ trang bá»‹ ${this.SafeGetValue(item, 'name')}`);
            this.updateDisplayedAttributes();
            this.saveEquipmentState(); // ä¿å­˜çŠ¶æ€
            this.savePendingActions(); // ä¿å­˜æŒ‡ä»¤çŠ¶æ€
          },

          unequipItem(slotId, slotElement, showMessage = true, refreshInventoryUI = true) {
            const slotKey = slotId.replace('equip-', '');
            const defaultTextMap = {
              wuqi: 'VÅ© KhÃ­',
              fangju: 'PhÃ²ng Cá»¥',
              shipin: 'Phá»¥ Kiá»‡n',
              fabao1: 'PhÃ¡p Báº£o',
              zhuxiuGongfa: 'CÃ´ng PhÃ¡p Chá»§ Tu',
              fuxiuXinfa: 'TÃ¢m PhÃ¡p Phá»¥ Tu',
            };

            const itemDataString = slotElement.dataset.itemDetails;
            if (!itemDataString) return; // å¦‚æœæ²¡æœ‰ç‰©å“ï¼Œåˆ™ä¸æ‰§è¡Œä»»ä½•æ“ä½œ

            let itemName = 'má»™t trang bá»‹';
            let itemId = null;
            try {
              const item = JSON.parse(itemDataString.replace(/'/g, "'"));
              itemName = this.SafeGetValue(item, 'name');
              itemId = this.SafeGetValue(item, 'id');
            } catch (e) {
              console.error('PhÃ¢n tÃ­ch dá»¯ liá»‡u váº­t pháº©m khi thÃ¡o tháº¥t báº¡i', e);
            }

            // æ¸…ç†å‰ç«¯çŠ¶æ€å’ŒUI
            this.equippedItems[slotKey] = null;
            slotElement.textContent = defaultTextMap[slotKey] || 'Trá»‘ng';
            slotElement.classList.remove('equipped');
            slotElement.removeAttribute('style');
            delete slotElement.dataset.itemDetails;

            // **å…³é”®ä¿®å¤**: ä¸å†è¿›è¡Œå¤æ‚çš„å±€éƒ¨DOMæ›´æ–°ï¼Œè€Œæ˜¯ç›´æ¥é‡æ–°æ¸²æŸ“æ•´ä¸ªèƒŒåŒ…ä»¥ç¡®ä¿UIåŒæ­¥
            if (refreshInventoryUI) {
              this.showInventory();
            }

            // æ·»åŠ åˆ°æŒ‡ä»¤é˜Ÿåˆ—ï¼ˆä¼˜åŒ–ï¼šå…ˆç§»é™¤æ—§æŒ‡ä»¤ï¼Œå†æ·»åŠ æ–°æŒ‡ä»¤ï¼‰
            this.pendingActions = this.pendingActions.filter(action => action.itemName !== itemName);
            this.pendingActions.push({
              action: 'unequip',
              itemName: itemName,
              category: defaultTextMap[slotKey],
            });

            if (showMessage) {
              this.showTemporaryMessage(`ÄÃ£ thÃ¡o ${itemName}`);
            }
            this.updateDisplayedAttributes();
            this.saveEquipmentState(); // ä¿å­˜çŠ¶æ€
            this.savePendingActions(); // ä¿å­˜æŒ‡ä»¤çŠ¶æ€
            // æ³¨æ„ï¼šshowInventory() å·²ç»åŒ…å«äº†å…³é—­æ¨¡æ€æ¡†å†æ‰“å¼€çš„è¿‡ç¨‹ï¼Œæ‰€ä»¥UIä¼šåˆ·æ–°
          },

          loadEquipmentFromMVU(data) {
            const equipmentMap = {
              'VÅ© KhÃ­': 'wuqi',
              'CÃ´ng PhÃ¡p Chá»§ Tu': 'zhuxiuGongfa',
              'TÃ¢m PhÃ¡p Phá»¥ Tu': 'fuxiuXinfa',
              'PhÃ²ng Cá»¥': 'fangju',
              'Phá»¥ Kiá»‡n': 'shipin',
              'Ã” PhÃ¡p Báº£o 1': 'fabao1',
            };
            const defaultTextMap = {
              wuqi: 'VÅ© KhÃ­',
              fangju: 'PhÃ²ng Cá»¥',
              shipin: 'Phá»¥ Kiá»‡n',
              fabao1: 'PhÃ¡p Báº£o',
              zhuxiuGongfa: 'CÃ´ng PhÃ¡p Chá»§ Tu',
              fuxiuXinfa: 'TÃ¢m PhÃ¡p Phá»¥ Tu',
            };

            for (const [mvuKey, slotKey] of Object.entries(equipmentMap)) {
              const slot = document.getElementById(`equip-${slotKey}`);
              if (!slot) continue;

              // mvuä¸­çš„è£…å¤‡æ•°æ®é€šå¸¸æ˜¯ [ { item_object } ] çš„å½¢å¼
              // **å±€éƒ¨ä¿®å¤**: ç›´æ¥ä½¿ç”¨ _.get è·å–è£…å¤‡æ•°ç»„ï¼Œé¿å… SafeGetValue å°†å…¶é”™è¯¯åœ°è½¬ä¸ºå­—ç¬¦ä¸²
              const itemArray = _.get(data, mvuKey, null);
              const item = Array.isArray(itemArray) && itemArray.length > 0 ? itemArray[0] : null;

              if (item && typeof item === 'object') {
                const tier = this.SafeGetValue(item, 'tier', 'PhÃ m Pháº©m');
                const tierStyle = this.getTierStyle(tier);
                // **é€»è¾‘ä¿®æ­£**: æ­¤å¤„ä¸å†ä¸»åŠ¨ä¿®æ”¹ this.equippedItems
                // this.equippedItems çš„çŠ¶æ€ç”± localStorage å’Œ equip/unequip åŠ¨ä½œç®¡ç†
                // this.equippedItems[slotKey] = item;
                slot.textContent = this.SafeGetValue(item, 'name');
                slot.setAttribute('style', tierStyle);
                slot.classList.add('equipped');
                slot.dataset.itemDetails = JSON.stringify(item).replace(/'/g, "'");
              } else {
                // this.equippedItems[slotKey] = null; // **å…³é”®ä¿®å¤**: æ­¤å‡½æ•°ä¸åº”ä¿®æ”¹æ ¸å¿ƒçŠ¶æ€ï¼Œåªæ¸²æŸ“ä»mvuå¾—åˆ°çš„æ•°æ®
                slot.textContent = defaultTextMap[slotKey];
                slot.classList.remove('equipped');
                slot.removeAttribute('style');
                delete slot.dataset.itemDetails;
              }
            }
          },

          updateDisplayedAttributes() {
            // ç±»è„‘/æ—…ç¨‹æ¢¦æ˜Ÿä½œå“ï¼Œç¦æ­¢äºŒä¼ ï¼Œç¦æ­¢å•†ä¸šåŒ–ï¼Œå‡æ— å¿å…è´¹å¼€æºåˆ†äº«
            // æ ¹æ®æ–°çš„å˜é‡ç»“æ„é‡å†™å±æ€§è®¡ç®—é€»è¾‘
            if (!this.currentMvuState || !this.currentMvuState.stat_data) {
              console.warn('æ— æ³•æ›´æ–°å±æ€§ï¼šmvuçŠ¶æ€ä¸å¯ç”¨ã€‚');
              return;
            }

            const stat_data = this.currentMvuState.stat_data;
            const baseAttrs = {
              fali: parseInt(this.SafeGetValue(stat_data, 'PhÃ¡p Lá»±c CÆ¡ Báº£n', 0), 10),
              shenhai: parseInt(this.SafeGetValue(stat_data, 'Tháº§n Háº£i CÆ¡ Báº£n', 0), 10),
              daoxin: parseInt(this.SafeGetValue(stat_data, 'Äáº¡o TÃ¢m CÆ¡ Báº£n', 0), 10),
              kongsu: parseInt(this.SafeGetValue(stat_data, 'KhÃ´ng Tá»‘c CÆ¡ Báº£n', 0), 10),
              qiyun: parseInt(this.SafeGetValue(stat_data, 'KhÃ­ Váº­n CÆ¡ Báº£n', 0), 10),
            };

            const totalFlatBonuses = { fali: 0, shenhai: 0, daoxin: 0, kongsu: 0, qiyun: 0 };
            const totalPercentBonuses = { fali: 0, shenhai: 0, daoxin: 0, kongsu: 0, qiyun: 0 };
            const attributeMapping = { 'PhÃ¡p Lá»±c': 'fali', 'Tháº§n Háº£i': 'shenhai', 'Äáº¡o TÃ¢m': 'daoxin', 'KhÃ´ng Tá»‘c': 'kongsu', 'KhÃ­ Váº­n': 'qiyun' };

            const processBonuses = (item) => {
              if (!item || typeof item !== 'object') return;
              
              const flatBonuses = item.attributes_bonus;
              if (flatBonuses && typeof flatBonuses === 'object') {
                for (const [attrName, bonusValue] of Object.entries(flatBonuses)) {
                  const attrKey = attributeMapping[attrName];
                  if (attrKey) {
                    totalFlatBonuses[attrKey] += parseInt(bonusValue, 10) || 0;
                  }
                }
              }
              
              const percentBonuses = item['Pháº§n trÄƒm gia tÄƒng'];
              if (percentBonuses && typeof percentBonuses === 'object') {
                 for (const [attrName, bonusValue] of Object.entries(percentBonuses)) {
                    const attrKey = attributeMapping[attrName];
                    if (attrKey) {
                        totalPercentBonuses[attrKey] += parseFloat(String(bonusValue).replace('%','')) / 100 || 0;
                    }
                }
              }
            };

            // 1. æ”¶é›†æ‰€æœ‰åŠ æˆæ¥æº
            Object.values(this.equippedItems).forEach(processBonuses);
            const tianfuList = _.get(stat_data, 'Danh SÃ¡ch ThiÃªn PhÃº.0', []);
            if (Array.isArray(tianfuList)) {
              tianfuList.forEach(tianfu => {
                if (typeof tianfu === 'object' && tianfu !== null) processBonuses(tianfu);
              });
            }
            // ä¿®æ”¹ï¼šå¤„ç†çµæ ¹åˆ—è¡¨è€Œéå•ä¸ªçµæ ¹
            const linggenListData = _.get(stat_data, 'Danh SÃ¡ch Linh CÄƒn.0', []);
            if (Array.isArray(linggenListData)) {
              linggenListData.forEach(rawLinggen => {
                try {
                  if (!rawLinggen || rawLinggen === '$__META_EXTENSIBLE__$') return;
                  const linggen = typeof rawLinggen === 'string' ? JSON.parse(rawLinggen) : rawLinggen;
                  if (linggen && typeof linggen === 'object') {
                    processBonuses(linggen);
                  }
                } catch (e) {
                  console.error('PhÃ¢n tÃ­ch tháº¥t báº¡i khi xá»­ lÃ½ cá»™ng thÃªm tá»« Linh CÄƒn:', rawLinggen, e);
                }
              });
            }

            // 2. è®¡ç®—æœ€ç»ˆä¸Šé™: ä¸Šé™ = (åŸºç¡€ + Î£å›ºå®š) * (1 + Î£ç™¾åˆ†æ¯”)
            const calculatedMaxAttrs = {
              fali: Math.floor((baseAttrs.fali + totalFlatBonuses.fali) * (1 + totalPercentBonuses.fali)),
              shenhai: Math.floor((baseAttrs.shenhai + totalFlatBonuses.shenhai) * (1 + totalPercentBonuses.shenhai)),
              daoxin: Math.floor((baseAttrs.daoxin + totalFlatBonuses.daoxin) * (1 + totalPercentBonuses.daoxin)),
              kongsu: Math.floor((baseAttrs.kongsu + totalFlatBonuses.kongsu) * (1 + totalPercentBonuses.kongsu)),
              qiyun: Math.floor((baseAttrs.qiyun + totalFlatBonuses.qiyun) * (1 + totalPercentBonuses.qiyun)),
            };
            
            // æ–°å¢ï¼šç¼“å­˜è®¡ç®—ç»“æœï¼Œä¾›å…¶ä»–å‡½æ•°ä½¿ç”¨
            this.calculatedMaxAttributes = calculatedMaxAttrs;

            // 3. è·å–å½“å‰å€¼ï¼Œå¹¶ç¡®ä¿ä¸è¶…è¿‡æ–°è®¡ç®—çš„ä¸Šé™
            const currentAttrs = {
                fali: Math.min(parseInt(this.SafeGetValue(stat_data, 'PhÃ¡p Lá»±c Hiá»‡n Táº¡i', 0), 10), calculatedMaxAttrs.fali),
                shenhai: Math.min(parseInt(this.SafeGetValue(stat_data, 'Tháº§n Háº£i Hiá»‡n Táº¡i', 0), 10), calculatedMaxAttrs.shenhai),
                daoxin: Math.min(parseInt(this.SafeGetValue(stat_data, 'Äáº¡o TÃ¢m Hiá»‡n Táº¡i', 0), 10), calculatedMaxAttrs.daoxin),
                kongsu: Math.min(parseInt(this.SafeGetValue(stat_data, 'KhÃ´ng Tá»‘c Hiá»‡n Táº¡i', 0), 10), calculatedMaxAttrs.kongsu),
            };

            // 4. æ›´æ–°UI
            document.getElementById('attr-fali').innerText = `${currentAttrs.fali} / ${calculatedMaxAttrs.fali}`;
            document.getElementById('attr-shenhai').innerText = `${currentAttrs.shenhai} / ${calculatedMaxAttrs.shenhai}`;
            document.getElementById('attr-daoxin').innerText = `${currentAttrs.daoxin} / ${calculatedMaxAttrs.daoxin}`;
            document.getElementById('attr-kongsu').innerText = `${currentAttrs.kongsu} / ${calculatedMaxAttrs.kongsu}`;
            document.getElementById('attr-qiyun').innerText = calculatedMaxAttrs.qiyun;
            
            // å¹´é¾„ç­‰éè®¡ç®—å±æ€§ç›´æ¥æ›´æ–°
            document.getElementById('attr-shengli').innerText = `${this.SafeGetValue(stat_data, 'Tuá»•i Sinh LÃ½')} / ${this.SafeGetValue(stat_data, 'Giá»›i Háº¡n Tuá»•i Sinh LÃ½')}`;
            document.getElementById('attr-xinli').innerText = `${this.SafeGetValue(stat_data, 'Tuá»•i TÃ¢m LÃ½')} / ${this.SafeGetValue(stat_data, 'Giá»›i Háº¡n Tuá»•i TÃ¢m LÃ½')}`;
          },

          showTemporaryMessage(message, duration = 2000) {
            const existingMsg = document.querySelector('.temp-message-popup');
            if (existingMsg) existingMsg.remove();

            const msgElement = document.createElement('div');
            msgElement.className = 'temp-message-popup';
            msgElement.textContent = message;
            msgElement.style.cssText = `
                    position: absolute;
                    top: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: rgba(45, 27, 61, 0.9);
                    color: #c9aa71;
                    padding: 10px 20px;
                    border-radius: 5px;
                    z-index: 2000;
                    font-size: 14px;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.5);
                    text-align: center;
                    transition: opacity 0.5s ease-out;
                `;
            document.querySelector('.guixu-root-container').appendChild(msgElement);

            setTimeout(() => {
              msgElement.style.opacity = '0';
              setTimeout(() => msgElement.remove(), 500);
            }, duration - 500);
          },

          showCommandCenter() {
            this.openModal('command-center-modal');
            const body = document.querySelector('#command-center-modal .modal-body');
            if (!body) return;

            if (this.pendingActions.length === 0) {
              body.innerHTML =
                '<p class="modal-placeholder" style="text-align:center; color:#8b7355; font-size:12px;">ChÆ°a cÃ³ má»‡nh lá»‡nh nÃ o chá» cháº¥p hÃ nh.</p>';
              return;
            }

            let html = '<ul class="command-center-actions">';
            this.pendingActions.forEach(cmd => {
              let actionText = '';
              switch (cmd.action) {
                case 'equip':
                  actionText = `[Trang bá»‹] ${cmd.itemName} vÃ o Ã´ ${cmd.category}`;
                  break;
                case 'unequip':
                  actionText = `[ThÃ¡o] ${cmd.itemName} tá»« Ã´ ${cmd.category}`;
                  break;
                case 'use':
                  actionText = `[DÃ¹ng] ${cmd.itemName} x ${cmd.quantity}`;
                  break;
                case 'discard':
                  if (cmd.quantity && cmd.quantity > 1) {
                    actionText = `[Vá»©t] ${cmd.itemName} x ${cmd.quantity}`;
                  } else {
                    actionText = `[Vá»©t] ${cmd.itemName}`;
                  }
                  break;
              }
              html += `<li class="command-center-action-item">${actionText}</li>`;
            });
            html += '</ul>';
            body.innerHTML = html;
          },

          clearPendingActions() {
            this.pendingActions = [];
            this.showCommandCenter(); // é‡æ–°æ¸²æŸ“æŒ‡ä»¤ä¸­å¿ƒä»¥æ˜¾ç¤ºç©ºçŠ¶æ€
            this.showTemporaryMessage('Má»‡nh lá»‡nh Ä‘Ã£ Ä‘Æ°á»£c xÃ³a sáº¡ch');
            this.savePendingActions();
          },

          refreshLocalStorage() {
            this.showCustomConfirm('Thao tÃ¡c nÃ y dÃ¹ng Ä‘á»ƒ lÃ m má»›i dá»¯ liá»‡u cache cá»§a cuá»™c trÃ² chuyá»‡n trÆ°á»›c. Náº¿u khÃ´ng pháº£i má»Ÿ cuá»™c trÃ² chuyá»‡n má»›i, xin Ä‘á»«ng báº¥m vÃ o', () => {
              try {
                localStorage.removeItem('guixu_equipped_items');
                localStorage.removeItem('guixu_pending_actions');
                localStorage.removeItem('guixu_auto_write_enabled');
                this.showTemporaryMessage('Bá»™ nhá»› Ä‘á»‡m Ä‘Ã£ Ä‘Æ°á»£c xÃ³a, trang sáº½ sá»›m Ä‘Æ°á»£c lÃ m má»›i...');
                setTimeout(() => {
                  window.location.reload();
                }, 1500);
              } catch (e) {
                console.error('XÃ³a bá»™ nhá»› cá»¥c bá»™ tháº¥t báº¡i:', e);
                this.showTemporaryMessage('XÃ³a bá»™ nhá»› Ä‘á»‡m tháº¥t báº¡i!');
              }
            });
          },

          async executePendingActions() {
            // æŒ‡ä»¤ä¸­å¿ƒæ‰§è¡Œæ—¶ï¼Œä¸å¸¦ç”¨æˆ·è¾“å…¥
            await this.handleAction();
          },

          useItem(item, buttonElement) {
            const itemName = this.SafeGetValue(item, 'name');
            if (itemName === 'N/A') {
              this.showTemporaryMessage('ThÃ´ng tin váº­t pháº©m bá»‹ lá»—i, khÃ´ng thá»ƒ sá»­ dá»¥ng.');
              return;
            }

            // **BUGä¿®å¤**: ä¸å†æ‰‹åŠ¨æ“ä½œDOMï¼Œè€Œæ˜¯é€šè¿‡åˆ·æ–°èƒŒåŒ…æ¥æ›´æ–°UI
            // æ£€æŸ¥å¾…å®šé˜Ÿåˆ—ä¸­çš„æ•°é‡ï¼Œä»¥é˜²æ­¢ç”¨æˆ·è¶…é¢ä½¿ç”¨
            const originalQuantity = parseInt(this.SafeGetValue(item, 'quantity', 0), 10);
            const pendingUses = this.pendingActions
              .filter(action => action.action === 'use' && action.itemName === itemName)
              .reduce((total, action) => total + action.quantity, 0);

            if (originalQuantity - pendingUses <= 0) {
              this.showTemporaryMessage(`${itemName} Ä‘Ã£ dÃ¹ng háº¿t hoáº·c Ä‘Ã£ cÃ³ trong hÃ ng Ä‘á»£i lá»‡nh.`);
              return;
            }

            // æ›´æ–°æŒ‡ä»¤é˜Ÿåˆ—
            const existingAction = this.pendingActions.find(
              action => action.action === 'use' && action.itemName === itemName,
            );

            if (existingAction) {
              existingAction.quantity++;
            } else {
              this.pendingActions.push({
                action: 'use',
                itemName: itemName,
                quantity: 1,
              });
            }

            this.showTemporaryMessage(`ÄÃ£ thÃªm [DÃ¹ng ${itemName}] vÃ o hÃ ng Ä‘á»£i lá»‡nh`);
            this.savePendingActions();

            // é€šè¿‡é‡æ–°æ¸²æŸ“æ•´ä¸ªèƒŒåŒ…æ¥ä¿è¯UIä¸€è‡´æ€§
            this.showInventory();
          },

          discardItem(item, category, itemElement) {
            const itemName = this.SafeGetValue(item, 'name');
            if (itemName === 'N/A') {
              this.showTemporaryMessage('ThÃ´ng tin váº­t pháº©m bá»‹ lá»—i, khÃ´ng thá»ƒ vá»©t.');
              return;
            }

            const hasQuantity = item.hasOwnProperty('quantity');
            
            if (hasQuantity && (category === 'Äan DÆ°á»£c' || category === 'Táº¡p Váº­t')) {
              // æœ‰æ•°é‡çš„ç‰©å“ï¼Œéœ€è¦è¾“å…¥ä¸¢å¼ƒæ•°é‡
              this.promptDiscardQuantity(item, category, itemElement);
            } else {
              // è£…å¤‡ç±»ç‰©å“ï¼Œç›´æ¥ç¡®è®¤ä¸¢å¼ƒ
              this.confirmDiscardItem(item, category, itemElement, 1);
            }
          },

          async promptDiscardQuantity(item, category, itemElement) {
            const itemName = this.SafeGetValue(item, 'name');
            const currentQuantity = parseInt(this.SafeGetValue(item, 'quantity', 0), 10);
            
            // è®¡ç®—å¯ä¸¢å¼ƒçš„æ•°é‡ï¼ˆå‡å»å¾…å¤„ç†é˜Ÿåˆ—ä¸­çš„ä½¿ç”¨å’Œä¸¢å¼ƒæ•°é‡ï¼‰
            const pendingUses = this.pendingActions
              .filter(action => action.action === 'use' && action.itemName === itemName)
              .reduce((total, action) => total + action.quantity, 0);
            const pendingDiscards = this.pendingActions
              .filter(action => action.action === 'discard' && action.itemName === itemName)
              .reduce((total, action) => total + action.quantity, 0);
            const availableQuantity = currentQuantity - pendingUses - pendingDiscards;

            if (availableQuantity <= 0) {
              this.showTemporaryMessage(`${itemName} khÃ´ng cÃ³ sá»‘ lÆ°á»£ng Ä‘á»ƒ vá»©t.`);
              return;
            }

            return new Promise((resolve) => {
              // åˆ›å»ºæ•°é‡è¾“å…¥æ¨¡æ€æ¡†
              const modal = document.createElement('div');
              modal.className = 'modal-overlay';
              modal.style.display = 'flex';
              modal.style.zIndex = '2000';
              modal.innerHTML = `
                <div class="modal-content" style="width: 400px; height: auto; max-height: none;">
                  <div class="modal-header">
                    <h2 class="modal-title">Vá»©t váº­t pháº©m</h2>
                  </div>
                  <div class="modal-body" style="padding: 20px;">
                    <p style="margin-bottom: 15px; color: #c9aa71;">Vui lÃ²ng nháº­p sá»‘ lÆ°á»£ng <strong>${itemName}</strong> muá»‘n vá»©t:</p>
                    <p style="font-size: 12px; color: #8b7355; margin-bottom: 10px;">Sá»‘ lÆ°á»£ng cÃ³ thá»ƒ vá»©t hiá»‡n táº¡i: ${availableQuantity}</p>
                    <input type="number" id="discard-quantity-input" min="1" max="${availableQuantity}" value="1"
                           style="width: 100%; padding: 10px; background: rgba(0,0,0,0.5); border: 1px solid #8b7355;
                                  color: #e0dcd1; border-radius: 4px; font-size: 14px; margin-bottom: 20px;">
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                      <button id="discard-quantity-cancel" class="interaction-btn">Há»§y</button>
                      <button id="discard-quantity-confirm" class="interaction-btn" style="background: #8b0000; border-color: #ff6b6b;">XÃ¡c nháº­n vá»©t</button>
                    </div>
                  </div>
                </div>
              `;

              const container = document.querySelector('.guixu-root-container');
              container.appendChild(modal);

              const input = modal.querySelector('#discard-quantity-input');
              const confirmBtn = modal.querySelector('#discard-quantity-confirm');
              const cancelBtn = modal.querySelector('#discard-quantity-cancel');

              confirmBtn.addEventListener('click', () => {
                const quantity = parseInt(input.value, 10);
                if (isNaN(quantity) || quantity <= 0 || quantity > availableQuantity) {
                  this.showTemporaryMessage('Vui lÃ²ng nháº­p sá»‘ lÆ°á»£ng vá»©t há»£p lá»‡');
                  return;
                }
                modal.remove();
                this.confirmDiscardItem(item, category, itemElement, quantity);
                resolve();
              });

              cancelBtn.addEventListener('click', () => {
                modal.remove();
                resolve();
              });

              // è‡ªåŠ¨èšç„¦
              setTimeout(() => input.focus(), 100);
            });
          },

          confirmDiscardItem(item, category, itemElement, quantity = 1) {
            const itemName = this.SafeGetValue(item, 'name');
            const hasQuantity = item.hasOwnProperty('quantity');
            
            let confirmMessage;
            if (hasQuantity) {
              confirmMessage = `Cháº¯c cháº¯n muá»‘n vá»©t ${quantity} cÃ¡i ${itemName} khÃ´ng? Thao tÃ¡c nÃ y khÃ´ng thá»ƒ hoÃ n tÃ¡c.`;
            } else {
              confirmMessage = `Cháº¯c cháº¯n muá»‘n vá»©t ${itemName} khÃ´ng? Thao tÃ¡c nÃ y khÃ´ng thá»ƒ hoÃ n tÃ¡c.`;
            }

            this.showCustomConfirm(confirmMessage, () => {
              // æ·»åŠ åˆ°æŒ‡ä»¤é˜Ÿåˆ—
              this.pendingActions.push({
                action: 'discard',
                itemName: itemName,
                category: category,
                quantity: quantity
              });

              this.savePendingActions();
              
              // å‰ç«¯ä¹è§‚æ˜¾ç¤ºï¼šåˆ·æ–°èƒŒåŒ…ä»¥åæ˜ å˜åŒ–
              this.showInventory();
              
              if (hasQuantity) {
                this.showTemporaryMessage(`ÄÃ£ thÃªm [Vá»©t ${quantity} cÃ¡i ${itemName}] vÃ o hÃ ng Ä‘á»£i lá»‡nh`);
              } else {
                this.showTemporaryMessage(`ÄÃ£ thÃªm [Vá»©t ${itemName}] vÃ o hÃ ng Ä‘á»£i lá»‡nh`);
              }
            });
          },

          showExtractedContent() {
            this.openModal('extracted-content-modal');
            const journeyEl = document.getElementById('extracted-journey');
            const pastLivesEl = document.getElementById('extracted-past-lives');
            const variablesEl = document.getElementById('extracted-variable-changes');
            const sentPromptEl = document.getElementById('sent-prompt-display');

            if (sentPromptEl) {
              sentPromptEl.textContent = this.lastSentPrompt || 'ChÆ°a gá»­i ná»™i dung nÃ o';
            }
            if (journeyEl) {
              journeyEl.textContent = this.lastExtractedJourney || 'KhÃ´ng trÃ­ch xuáº¥t Ä‘Æ°á»£c ná»™i dung';
            }
            if (pastLivesEl) {
              pastLivesEl.textContent = this.lastExtractedPastLives || 'KhÃ´ng trÃ­ch xuáº¥t Ä‘Æ°á»£c ná»™i dung';
            }
            if (variablesEl) {
              variablesEl.textContent = this.lastExtractedVariables || 'Láº§n nÃ y khÃ´ng cÃ³ thay Ä‘á»•i biáº¿n';
            }
            const novelModeEl = document.getElementById('extracted-novel-mode');
            const novelModeBtn = document.getElementById('btn-write-novel-mode');
            if (novelModeEl && novelModeBtn) {
              // æ–°é€»è¾‘ï¼šå§‹ç»ˆæ˜¾ç¤ºæå–åˆ°çš„å†…å®¹ã€‚æŒ‰é’®å¯ç”¨æ€§ä»…å–å†³äºå†…å®¹æ˜¯å¦å­˜åœ¨ã€‚
              novelModeEl.textContent = this.lastExtractedNovelText || 'KhÃ´ng trÃ­ch xuáº¥t Ä‘Æ°á»£c ná»™i dung chÃ­nh trong pháº£n há»“i AI hiá»‡n táº¡i.';
              novelModeBtn.disabled = !this.lastExtractedNovelText;

              // æ›´æ–°æ ‡ç­¾æ–‡æœ¬ä»¥æä¾›å…³äºè‡ªåŠ¨å†™å…¥çŠ¶æ€çš„å³æ—¶åé¦ˆ
              const label = document.querySelector('label[for="novel-mode-enabled-checkbox"]');
              if (label) {
                const statusText = this.isNovelModeEnabled ? 'Báº­t' : 'Táº¯t';
                label.title = `Nháº¥n Ä‘á»ƒ chuyá»ƒn Ä‘á»•i tráº¡ng thÃ¡i tá»± Ä‘á»™ng ghi, hiá»‡n táº¡i lÃ : ${statusText}`;
              }
            }

            // æ–°å¢ï¼šå¤„ç†æå–çš„è§’è‰²å¡
            const characterCardEl = document.getElementById('extracted-character-card');
            const characterCardBtn = document.getElementById('btn-write-character-card');
            if (characterCardEl && characterCardBtn) {
              characterCardEl.textContent = this.lastExtractedCharacterCard || 'KhÃ´ng trÃ­ch xuáº¥t Ä‘Æ°á»£c ná»™i dung tháº» nhÃ¢n váº­t.';
              characterCardBtn.disabled = !this.lastExtractedCharacterCard;
            }
          },

          async showJourney() {
            this.openModal('history-modal');
            this.loadUnifiedIndex(); // ç¡®ä¿è¾“å…¥æ¡†æ˜¾ç¤ºæ­£ç¡®çš„åºå·
            const titleEl = document.getElementById('history-modal-title');
            if (titleEl) titleEl.textContent = 'HÃ nh TrÃ¬nh Kiáº¿p NÃ y';

            const body = document.getElementById('history-modal-body');
            if (!body) return;

            body.innerHTML =
              '<p class="modal-placeholder" style="text-align:center; color:#8b7355; font-size:12px;">Äang Ä‘á»c láº¡i cuá»™n giáº¥y váº­n má»‡nh...</p>';
            try {
              const bookName = '1å½’å¢Ÿ';
              const index = this.unifiedIndex;
              const journeyKey = index > 1 ? `HÃ nh TrÃ¬nh Kiáº¿p NÃ y(${index})` : 'HÃ nh TrÃ¬nh Kiáº¿p NÃ y';
              const allEntries = await TavernHelper.getLorebookEntries(bookName);
              const journeyEntry = allEntries.find(entry => entry.comment === journeyKey);

              if (!journeyEntry) {
                console.warn(`KhÃ´ng tÃ¬m tháº¥y má»¥c cÃ³ tiÃªu Ä‘á» "${journeyKey}" trong Lorebook "${bookName}".`);
              }
              body.innerHTML = this.renderJourneyFromContent(journeyEntry);
              // Bind click event listeners
              this.bindJourneyListeners();
            } catch (error) {
              console.error('Lá»—i khi Ä‘á»c â€œHÃ nh TrÃ¬nh Kiáº¿p NÃ yâ€:', error);
              body.innerHTML = `<p class="modal-placeholder" style="text-align:center; color:#8b7355; font-size:12px;">Lá»—i khi Ä‘á»c láº¡i kÃ½ á»©c: ${error.message}</p>`;
            }
          },

          async showPastLives() {
            this.openModal('history-modal');
            this.loadUnifiedIndex(); // ç¡®ä¿è¾“å…¥æ¡†æ˜¾ç¤ºæ­£ç¡®çš„åºå·
            const titleEl = document.getElementById('history-modal-title');
            if (titleEl) titleEl.textContent = 'SÃ³ng NÆ°á»›c Kiáº¿p XÆ°a';

            const body = document.getElementById('history-modal-body');
            if (!body) return;

            body.innerHTML =
              '<p class="modal-placeholder" style="text-align:center; color:#8b7355; font-size:12px;">Äang ngÆ°á»£c dÃ²ng thá»i gian...</p>';
            try {
              const bookName = 'Quy KhÆ° 2.5-UI';
              const index = this.unifiedIndex;
              const pastLivesKey = index > 1 ? `SÃ³ng NÆ°á»›c Kiáº¿p XÆ°a(${index})` : 'SÃ³ng NÆ°á»›c Kiáº¿p XÆ°a';
              const allEntries = await TavernHelper.getLorebookEntries(bookName);
              const pastLivesEntry = allEntries.find(entry => entry.comment === pastLivesKey);

              if (!pastLivesEntry) {
                console.warn(`KhÃ´ng tÃ¬m tháº¥y má»¥c cÃ³ tiÃªu Ä‘á» "${pastLivesKey}" trong Lorebook "${bookName}".`);
              }

              body.innerHTML = this.renderPastLives(pastLivesEntry);
            } catch (error) {
              console.error('Lá»—i khi Ä‘á»c â€œSÃ³ng NÆ°á»›c Kiáº¿p XÆ°aâ€:', error);
              body.innerHTML = `<p class="modal-placeholder" style="text-align:center; color:#8b7355; font-size:12px;">Lá»—i khi ngÆ°á»£c dÃ²ng thá»i gian: ${error.message}</p>`;
            }
          },

          // --- Rendering Logic for Dynamic Content (Lorebooks) ---
          parseJourneyEntry(contentString) {
            if (!contentString || typeof contentString !== 'string') return [];
            try {
              const events = [];
              const eventBlocks = contentString
                .trim()
                .split(/Sá»‘ thá»© tá»±\|/g)
                .slice(1);

              eventBlocks.forEach(block => {
                const fullBlock = `Sá»‘ thá»© tá»±|${block}`.trim();
                const event = {};
                
                // å®šä¹‰å­—æ®µé¡ºåºï¼Œç”¨äºæ­£ç¡®è§£æå¤šè¡Œå†…å®¹
                const fieldOrder = ['Sá»‘ thá»© tá»±', 'NgÃ y thÃ¡ng', 'TiÃªu Ä‘á»', 'Äá»‹a Ä‘iá»ƒm', 'NhÃ¢n váº­t', 'MÃ´ táº£', 'Quan há»‡ nhÃ¢n váº­t', 'Tháº»', 'ThÃ´ng tin quan trá»ng', 'Ná»™i tuyáº¿n vÃ  Phá»¥c bÃºt', 'Há»‡ thá»‘ng tá»± Ä‘á»™ng hÃ³a'];
                
                let currentFieldIndex = 0;
                let currentKey = '';
                let currentValue = '';
                
                const lines = fullBlock.split('\n');
                
                for (let i = 0; i < lines.length; i++) {
                  const line = lines[i];
                  let foundField = false;
                  
                  // æ£€æŸ¥æ˜¯å¦æ˜¯æ–°å­—æ®µçš„å¼€å§‹
                  for (let j = currentFieldIndex; j < fieldOrder.length; j++) {
                    const field = fieldOrder[j];
                    if (line.startsWith(field + '|')) {
                      // ä¿å­˜å‰ä¸€ä¸ªå­—æ®µçš„å€¼
                      if (currentKey && currentValue.trim()) {
                        event[currentKey] = currentValue.trim();
                      }
                      
                      // å¼€å§‹æ–°å­—æ®µ
                      currentKey = field;
                      currentValue = line.substring(field.length + 1);
                      currentFieldIndex = j;
                      foundField = true;
                      break;
                    }
                  }
                  
                  // å¦‚æœä¸æ˜¯æ–°å­—æ®µï¼Œåˆ™è¿½åŠ åˆ°å½“å‰å­—æ®µå€¼
                  if (!foundField && currentKey) {
                    currentValue += '\n' + line;
                  }
                }
                
                // ä¿å­˜æœ€åä¸€ä¸ªå­—æ®µ
                if (currentKey && currentValue.trim()) {
                  event[currentKey] = currentValue.trim();
                }
                
                if (event['Sá»‘ thá»© tá»±']) {
                  events.push(event);
                }
              });
              return events;
            } catch (e) {
              console.error('PhÃ¢n tÃ­ch má»¥c HÃ nh TrÃ¬nh Kiáº¿p NÃ y tháº¥t báº¡i:', e);
              return [];
            }
          },

          parsePastLifeEntry(contentString) {
            if (!contentString || typeof contentString !== 'string') return {};
            try {
              const data = {};
              const lines = contentString.trim().split('\n');
              lines.forEach(line => {
                const parts = line.split('|');
                if (parts.length >= 2) {
                  const key = parts[0].trim();
                  const value = parts.slice(1).join('|').trim();
                  data[key] = value;
                }
              });
              return data;
            } catch (e) {
              console.error('PhÃ¢n tÃ­ch má»¥c SÃ³ng NÆ°á»›c Kiáº¿p XÆ°a tháº¥t báº¡i:', e);
              return {};
            }
          },

          renderJourneyFromContent(entry) {
            if (!entry || !entry.content)
              return '<p style="text-align:center; color:#8b7355; font-size:12px;">Kiáº¿p nÃ y chÆ°a lÆ°u láº¡i dáº¥u váº¿t nÃ o.</p>';

            const events = this.parseJourneyEntry(entry.content);
            if (events.length === 0)
              return '<p style="text-align:center; color:#8b7355; font-size:12px;">Äá»‹nh dáº¡ng ná»™i dung bá»‹ lá»—i, khÃ´ng thá»ƒ phÃ¢n tÃ­ch sá»± kiá»‡n.</p>';

            events.sort((a, b) => (parseInt(a['Sá»‘ thá»© tá»±'], 10) || 0) - (parseInt(b['Sá»‘ thá»© tá»±'], 10) || 0));

            let html = '<div class="timeline-container"><div class="timeline-line"></div>';
            events.forEach((eventData, index) => {
              const eventId = `event-${entry.uid}-${index}`;
              const date = eventData['NgÃ y thÃ¡ng'] || 'Thá»i gian khÃ´ng rÃµ';
              const title = eventData['TiÃªu Ä‘á»'] || 'KhÃ´ng cÃ³ tiÃªu Ä‘á»';
              const location = eventData['Äá»‹a Ä‘iá»ƒm'] || 'Äá»‹a Ä‘iá»ƒm khÃ´ng rÃµ';
              const description = eventData['MÃ´ táº£'] || 'KhÃ´ng cÃ³ mÃ´ táº£ chi tiáº¿t.';
              const characters = eventData['NhÃ¢n váº­t'] || '';
              const relationships = eventData['Quan há»‡ nhÃ¢n váº­t'] || '';
              const importantInfo = eventData['ThÃ´ng tin quan trá»ng'] || '';
              const hiddenPlot = eventData['Ná»™i tuyáº¿n vÃ  Phá»¥c bÃºt'] || '';
              const autoSystem = eventData['Há»‡ thá»‘ng tá»± Ä‘á»™ng hÃ³a'] || '';

              const tagsHtml = (eventData['Tháº»'] || '')
                .split('|')
                .map(tag => tag.trim())
                .filter(tag => tag)
                .map(tag => `<span class="tag-item">${tag}</span>`)
                .join('');

              // åŸºæœ¬ä¿¡æ¯ï¼ˆé»˜è®¤æ˜¾ç¤ºï¼‰
              const basicInfo = `
                <div class="timeline-header">
                  <div class="timeline-date">${date}</div>
                  <div class="timeline-tags">${tagsHtml}</div>
                </div>
                <div class="timeline-title">${title}</div>
                <div class="timeline-location" style="font-size: 12px; color: #8b7355; margin: 5px 0;">Äá»‹a Ä‘iá»ƒmï¼š${location}</div>
                <div class="timeline-description">${description}</div>
              `;

              // è¯¦ç»†ä¿¡æ¯ï¼ˆéœ€è¦ç‚¹å‡»3æ¬¡æ‰æ˜¾ç¤ºï¼‰
              const detailedInfo = `
                <div class="timeline-detailed-info" id="detailed-${eventId}" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(201, 170, 113, 0.3);">
                  ${characters ? `<div class="detail-section"><strong>NhÃ¢n váº­tï¼š</strong>${characters}</div>` : ''}
                  ${relationships ? `<div class="detail-section"><strong>Quan há»‡ nhÃ¢n váº­tï¼š</strong>${relationships}</div>` : ''}
                  ${importantInfo ? `<div class="detail-section"><strong>ThÃ´ng tin quan trá»ngï¼š</strong>${importantInfo}</div>` : ''}
                  ${hiddenPlot ? `<div class="detail-section"><strong>Ná»™i tuyáº¿n vÃ  Phá»¥c bÃºtï¼š</strong>${hiddenPlot}</div>` : ''}
                  ${autoSystem ? `<div class="detail-section"><strong>Há»‡ thá»‘ng tá»± Ä‘á»™ng hÃ³aï¼š</strong><pre style="white-space: pre-wrap; font-size: 11px; color: #a09c91;">${autoSystem}</pre></div>` : ''}
                </div>
              `;

              html += `
                <div class="timeline-event" data-event-id="${eventId}" data-click-count="0" style="cursor: pointer;">
                  <div class="timeline-content">
                    ${basicInfo}
                    ${detailedInfo}
                  </div>
                </div>`;
            });
            html += '</div>';
            return html;
          },

          renderPastLives(entry) {
            if (!entry || !entry.content)
              return '<p style="text-align:center; color:#8b7355; font-size:12px;">KhÃ´ng tÃ¬m tháº¥y dáº¥u váº¿t cá»§a tiá»n kiáº¿p.</p>';

            const pastLifeBlocks = entry.content
              .trim()
              .split(/Kiáº¿p thá»© x\|/g)
              .slice(1);
            if (pastLifeBlocks.length === 0)
              return '<p style="text-align:center; color:#8b7355; font-size:12px;">Äá»‹nh dáº¡ng ná»™i dung bá»‹ lá»—i, khÃ´ng thá»ƒ phÃ¢n tÃ­ch ghi chÃ©p tiá»n kiáº¿p.</p>';

            let html = '<div class="timeline-container"><div class="timeline-line"></div>';
            pastLifeBlocks.forEach(block => {
              const fullContent = `Kiáº¿p thá»© x|${block}`;
              const data = this.parsePastLifeEntry(fullContent);
              const title = `Kiáº¿p thá»© ${data['Kiáº¿p thá»© x'] || '?'}`;

              html += `
                        <div class="timeline-event">
                            <div class="timeline-content">
                                <div class="timeline-title">${title}</div>
                                <div class="past-life-details">
                                    <div class="detail-item"><strong>Máº¡ch sá»± kiá»‡n:</strong> ${
                                      data['Máº¡ch sá»± kiá»‡n'] || 'KhÃ´ng rÃµ'
                                    }</div>
                                    <div class="detail-item"><strong>Tá»•ng quan kiáº¿p nÃ y:</strong> ${
                                      data['Tá»•ng quan kiáº¿p nÃ y'] || 'KhÃ´ng rÃµ'
                                    }</div>
                                    <div class="detail-item"><strong>ThÃ nh tá»±u kiáº¿p nÃ y:</strong> ${
                                      data['ThÃ nh tá»±u kiáº¿p nÃ y'] || 'KhÃ´ng'
                                    }</div>
                                    <div class="detail-item"><strong>Váº­t pháº©m Ä‘áº¡t Ä‘Æ°á»£c:</strong> ${
                                      data['Váº­t pháº©m Ä‘áº¡t Ä‘Æ°á»£c kiáº¿p nÃ y'] || 'KhÃ´ng'
                                    }</div>
                                    <div class="detail-item"><strong>Quan há»‡ nhÃ¢n váº­t:</strong> ${
                                      data['Máº¡ng lÆ°á»›i quan há»‡ nhÃ¢n váº­t kiáº¿p nÃ y'] || 'KhÃ´ng'
                                    }</div>
                                    <div class="detail-item"><strong>NguyÃªn nhÃ¢n tá»­ vong:</strong> ${
                                      data['NguyÃªn nhÃ¢n tá»­ vong'] || 'KhÃ´ng rÃµ'
                                    }</div>
                                    <div class="detail-item"><strong>Tá»•ng káº¿t kiáº¿p nÃ y:</strong> ${
                                      data['Tá»•ng káº¿t kiáº¿p nÃ y'] || 'KhÃ´ng'
                                    }</div>
                                    <div class="detail-item"><strong>ÄÃ¡nh giÃ¡ kiáº¿p nÃ y:</strong> ${
                                      data['ÄÃ¡nh giÃ¡ kiáº¿p nÃ y'] || 'KhÃ´ng'
                                    }</div>
                                </div>
                            </div>
                        </div>`;
            });
            html += '</div>';
            return html;
          },

          async renderPastLifeDetails(bookName) {
            const detailsContainer = document.getElementById('past-life-details');
            if (!detailsContainer) return;
            detailsContainer.style.display = 'block';
            detailsContainer.innerHTML =
              '<p class="modal-placeholder" style="text-align:center; color:#8b7355; font-size:12px;">Äang Ä‘á»c kÃ½ á»©c cá»§a kiáº¿p nÃ y...</p>';
            try {
              const entries = await TavernHelper.getLorebookEntries(bookName, 'summary');
              if (entries && entries.length > 0) {
                const summaryData = JSON.parse(entries[0].content);
                detailsContainer.innerHTML = `
                            <h4>${bookName} - Tá»•ng quan káº¿t cá»¥c</h4>
                            <p><strong>Cáº£nh giá»›i cuá»‘i cÃ¹ng:</strong> ${summaryData.finalStats.å¢ƒç•Œ}</p>
                            <p><strong>Thá»i gian sá»‘ng sÃ³t:</strong> ${summaryData.finalStats.å­˜æ´»æ—¶é—´}</p>
                            <p><strong>ThÃ nh tá»±u chÃ­nh:</strong> ${summaryData.achievements.join('ã€ ')}</p>
                            <p><strong>Há»‘i tiáº¿c cuá»‘i cÃ¹ng:</strong> ${summaryData.regrets}</p>
                            <p><strong>Sá»± kiá»‡n quan trá»ng:</strong></p>
                            <ul style="padding-left: 20px;">${summaryData.keyEvents
                              .map(e => `<li>${e}</li>`)
                              .join('')}</ul>`;
              } else {
                detailsContainer.innerHTML =
                  '<p class="modal-placeholder" style="text-align:center; color:#8b7355; font-size:12px;">KhÃ´ng tÃ¬m tháº¥y tá»•ng quan káº¿t cá»¥c cá»§a kiáº¿p nÃ y.</p>';
              }
            } catch (error) {
              console.error(`Error fetching details for ${bookName}:`, error);
              detailsContainer.innerHTML = `<p class="modal-placeholder" style="text-align:center; color:#8b7355; font-size:12px;">Lá»—i khi Ä‘á»c kÃ½ á»©c kiáº¿p nÃ y: ${error.message}</p>`;
            }
          },

          // --- Dynamic Event Listeners for Lorebook content ---
          bindJourneyListeners() {
            // Bind click listeners for HÃ nh TrÃ¬nh Kiáº¿p NÃ y events
            const timelineContainer = document.querySelector('.timeline-container');
            if (timelineContainer) {
              timelineContainer.addEventListener('click', (e) => {
                const timelineEvent = e.target.closest('.timeline-event');
                if (timelineEvent) {
                  this.handleJourneyEventClick(timelineEvent);
                }
              });
            }
          },

          handleJourneyEventClick(eventElement) {
            const detailedInfo = eventElement.querySelector('.timeline-detailed-info');
            
            // æ£€æŸ¥è¯¦ç»†ä¿¡æ¯æ˜¯å¦å·²ç»æ˜¾ç¤º
            if (detailedInfo && detailedInfo.style.display === 'block') {
              // å¦‚æœå·²æ˜¾ç¤ºï¼Œåˆ™éšè—
              detailedInfo.style.display = 'none';
              eventElement.style.cursor = 'pointer';
              // é‡ç½®ç‚¹å‡»è®¡æ•°ï¼Œå…è®¸é‡æ–°å¼€å§‹3æ¬¡ç‚¹å‡»
              eventElement.dataset.clickCount = '0';
            } else {
              // å¦‚æœæœªæ˜¾ç¤ºï¼Œç»§ç»­åŸæœ‰çš„3æ¬¡ç‚¹å‡»é€»è¾‘
              const currentCount = parseInt(eventElement.dataset.clickCount || '0', 10);
              const newCount = currentCount + 1;
              eventElement.dataset.clickCount = newCount;

              // å½“ç‚¹å‡»3æ¬¡æ—¶æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
              if (newCount >= 3) {
                if (detailedInfo) {
                  detailedInfo.style.display = 'block';
                }
                
                // ä¿æŒç‚¹å‡»æ ·å¼ï¼Œå…è®¸å†æ¬¡ç‚¹å‡»éšè—
                eventElement.style.cursor = 'pointer';
              }
            }
          },

          async handleRewind(eventId, eventTitle) {
            // â€œå›æº¯â€æŒ‰é’®ç›¸å…³é€»è¾‘å·²ç§»é™¤
          },

          // æ­¤å‡½æ•°ä¸å†éœ€è¦ï¼Œæå–é€»è¾‘å·²åˆå¹¶åˆ° loadAndDisplayCurrentScene
          processAIResponse() {
            // ç©ºå‡½æ•°æˆ–å¯ç›´æ¥åˆ é™¤
          },

          // --- æ–°å¢ï¼šå†™å…¥ä¸–ç•Œä¹¦çš„æ ¸å¿ƒé€»è¾‘ ---
          // ç±»è„‘/æ—…ç¨‹æ¢¦æ˜Ÿä½œå“ï¼Œç¦æ­¢äºŒä¼ ï¼Œç¦æ­¢å•†ä¸šåŒ–ï¼Œå‡æ— å¿å…è´¹å¼€æºåˆ†äº«
          async writeJourneyToLorebook(silent = false) {
            const content = this.lastExtractedJourney;
            await this.writeToLorebook('HÃ nh TrÃ¬nh Kiáº¿p NÃ y', content, silent);
          },

          async writePastLivesToLorebook(silent = false) {
            const content = this.lastExtractedPastLives;
            await this.writeToLorebook('SÃ³ng NÆ°á»›c Kiáº¿p XÆ°a', content, silent);
          },

          async writeNovelModeToLorebook(silent = false) {
            const content = this.lastExtractedNovelText;
            await this.writeToLorebook('Cháº¿ Ä‘á»™ tiá»ƒu thuyáº¿t', content, silent);
          },

          // æœ€ç»ˆç‰ˆï¼šé‡æ„å†™å…¥é€»è¾‘ï¼Œæ”¯æŒåŠ¨æ€ç´¢å¼•å’Œæ¡ç›®åˆ›å»º
          async writeToLorebook(baseEntryKey, contentToWrite, silent = false) {
            if (!contentToWrite || contentToWrite.trim() === '') {
              if (!silent) this.showTemporaryMessage('KhÃ´ng cÃ³ ná»™i dung Ä‘á»ƒ ghi.');
              return;
            }

            // 1. æ ¹æ®åºå·ç”Ÿæˆæœ€ç»ˆçš„æ¡ç›®åç§°
            const index = this.unifiedIndex;
            const finalEntryKey = index > 1 ? `${baseEntryKey}(${index})` : baseEntryKey;
            const bookName = 'Quy KhÆ° 2.5-UI';

            let reformattedContent = contentToWrite.trim();
            let buttonId;

            // 2. å†…å®¹æ ¼å¼åŒ– (é€»è¾‘ä¿æŒä¸å˜)
            if (baseEntryKey === 'HÃ nh TrÃ¬nh Kiáº¿p NÃ y' || baseEntryKey === 'SÃ³ng NÆ°á»›c Kiáº¿p XÆ°a') {
              const journeyFields = ['Sá»‘ thá»© tá»±', 'NgÃ y thÃ¡ng', 'TiÃªu Ä‘á»', 'MÃ´ táº£', 'Tháº»'];
              const pastLivesFields = [
                'Kiáº¿p thá»© x', 'Máº¡ch sá»± kiá»‡n', 'Tá»•ng quan kiáº¿p nÃ y', 'ThÃ nh tá»±u kiáº¿p nÃ y', 'Váº­t pháº©m Ä‘áº¡t Ä‘Æ°á»£c kiáº¿p nÃ y',
                'Máº¡ng lÆ°á»›i quan há»‡ nhÃ¢n váº­t kiáº¿p nÃ y', 'NguyÃªn nhÃ¢n tá»­ vong', 'Tá»•ng káº¿t kiáº¿p nÃ y', 'ÄÃ¡nh giÃ¡ kiáº¿p nÃ y',
              ];
              const fields = baseEntryKey === 'HÃ nh TrÃ¬nh Kiáº¿p NÃ y' ? journeyFields : pastLivesFields;

              const parseContent = (text, fieldList) => {
                const data = {};
                let tempText = text.replace(/\r\n/g, '\n');
                fieldList.forEach((field, fIndex) => {
                  const nextField = fieldList[fIndex + 1];
                  const startMarker = `${field}|`;
                  const startIndex = tempText.indexOf(startMarker);
                  if (startIndex !== -1) {
                    let endIndex;
                    if (nextField) {
                      const nextMarkerIndex = tempText.indexOf(`${nextField}|`, startIndex);
                      endIndex = nextMarkerIndex !== -1 ? nextMarkerIndex : undefined;
                    }
                    let value = tempText.substring(startIndex + startMarker.length, endIndex);
                    data[field] = value.trim();
                  }
                });
                return data;
              };

              const parsedData = parseContent(contentToWrite, fields);
              if (Object.keys(parsedData).length === 0) {
                if (!silent) this.showTemporaryMessage(`KhÃ´ng thá»ƒ phÃ¢n tÃ­ch ná»™i dung cá»§a â€œ${baseEntryKey}â€, thao tÃ¡c ghi Ä‘Ã£ bá»‹ há»§y.`);
                return;
              }
              reformattedContent = fields
                .map(key => (parsedData[key] ? `${key}|${parsedData[key]}` : null))
                .filter(Boolean)
                .join('\n');
              
              buttonId = baseEntryKey === 'HÃ nh TrÃ¬nh Kiáº¿p NÃ y' ? 'btn-write-journey' : 'btn-write-past-lives';
            } else if (baseEntryKey === 'Cháº¿ Ä‘á»™ tiá»ƒu thuyáº¿t') {
              buttonId = 'btn-write-novel-mode';
            }

            const button = document.getElementById(buttonId);
            if (button && !silent) button.textContent = 'Äang ghi...';

            try {
              // 3. æ£€æŸ¥æ¡ç›®æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»º
              const allEntries = await TavernHelper.getLorebookEntries(bookName);
              let targetEntry = allEntries.find(entry => entry.comment === finalEntryKey);

              if (!targetEntry) {
                if (!silent) this.showTemporaryMessage(`Má»¥c "${finalEntryKey}" khÃ´ng tá»“n táº¡i, Ä‘ang táº¡o...`);
                
                // ä»åŸºç¡€æ¡ç›®ï¼ˆå¦‚â€œHÃ nh TrÃ¬nh Kiáº¿p NÃ yâ€ï¼‰å¤åˆ¶å±æ€§æ¥åˆ›å»ºæ–°æ¡ç›®
                const baseEntryTemplate = allEntries.find(entry => entry.comment === baseEntryKey);
                const newEntryData = {
                  comment: finalEntryKey,
                  content: reformattedContent,
                  keys: baseEntryTemplate ? [...baseEntryTemplate.keys, finalEntryKey] : [finalEntryKey],
                  enabled: false,
                  // å¤åˆ¶å…¶ä»–å¯èƒ½å­˜åœ¨çš„å…ƒæ•°æ®
                  selective: baseEntryTemplate?.selective,
                  constant: baseEntryTemplate?.constant,
                  position: baseEntryTemplate?.position,
                  case_sensitive: baseEntryTemplate?.case_sensitive,
                };

                await TavernHelper.createLorebookEntries(bookName, [newEntryData]);
                if (!silent) this.showTemporaryMessage(`ÄÃ£ táº¡o vÃ  ghi thÃ nh cÃ´ng vÃ o â€œ${finalEntryKey}â€.`);
                
                // åˆ›å»ºåï¼Œå¦‚æœè‡ªåŠ¨å¼€å…³æ˜¯å¼€å¯çš„ï¼Œç«‹å³è§¦å‘ä¸€æ¬¡æ›´æ–°ä»¥ç¡®ä¿æ–°æ¡ç›®è¢«æ­£ç¡®å¯ç”¨
                if (this.isAutoToggleLorebookEnabled) {
                    this.updateAutoToggledEntries();
                }

              } else {
                // 4. å¦‚æœæ¡ç›®å­˜åœ¨ï¼Œåˆ™è¿½åŠ å†…å®¹
                const existingContent = targetEntry.content || '';
                if (existingContent.includes(reformattedContent)) {
                  if (!silent) this.showTemporaryMessage('Ná»™i dung Ä‘Ã£ tá»“n táº¡i, khÃ´ng cáº§n ghi láº¡i.');
                  return;
                }

                const updatedContent = existingContent + (existingContent ? '\n\n' : '') + reformattedContent;
                await TavernHelper.setLorebookEntries(bookName, [{ uid: targetEntry.uid, content: updatedContent }]);
                if (!silent) this.showTemporaryMessage(`ÄÃ£ thÃªm ná»™i dung thÃ nh cÃ´ng vÃ o â€œ${finalEntryKey}â€.`);
              }

              if (button && !silent) {
                button.textContent = 'Ghi thÃ nh cÃ´ng';
                setTimeout(() => { button.textContent = 'Ghi vÃ o Lorebook'; }, 2000);
              }

            } catch (error) {
              console.error(`Lá»—i khi ghi vÃ o Lorebook "${finalEntryKey}":`, error);
              if (!silent) {
                this.showTemporaryMessage(`Ghi tháº¥t báº¡i: ${error.message}`);
                if (button) button.textContent = 'Ghi tháº¥t báº¡i';
              }
            } finally {
                if (button && !silent && button.textContent === 'Äang ghi...') {
                    button.textContent = 'Ghi vÃ o Lorebook';
                }
            }
          },

          async writeCharacterCardToLorebook() {
            const content = this.lastExtractedCharacterCard;
            if (!content) {
              this.showTemporaryMessage('KhÃ´ng cÃ³ ná»™i dung nhÃ¢n váº­t Ä‘á»ƒ ghi.');
              return;
            }

            const button = document.getElementById('btn-write-character-card');
            if (button) button.textContent = 'Äang ghi...';

            try {
              const lines = content.trim().split('\n');
              const characterData = {};
              lines.forEach(line => {
                const parts = line.split('|');
                if (parts.length >= 2) {
                  const key = parts[0].trim();
                  const value = parts.slice(1).join('|').trim();
                  characterData[key] = value;
                }
              });

              const characterName = characterData['TÃªn'];
              if (!characterName) {
                throw new Error('KhÃ´ng thá»ƒ tÃ¬m tháº¥y â€œTÃªnâ€ cá»§a nhÃ¢n váº­t tá»« ná»™i dung Ä‘Æ°á»£c trÃ­ch xuáº¥t.');
              }

              const bookName = 'Quy KhÆ° 2.5-UI';
              const allEntries = await TavernHelper.getLorebookEntries(bookName);
              const existingEntry = allEntries.find(entry => entry.comment === characterName);

              if (existingEntry) {
                this.showTemporaryMessage(`NhÃ¢n váº­t â€œ${characterName}â€ Ä‘Ã£ tá»“n táº¡i, vui lÃ²ng sá»­a thá»§ cÃ´ng.`);
                if (button) button.textContent = 'Ghi vÃ o Lorebook';
                return;
              }

              await TavernHelper.createLorebookEntries(bookName, [
                {
                  comment: characterName,
                  keys: [characterName],
                  content: content.trim(),
                  enabled: true,
                },
              ]);

              this.showTemporaryMessage(`ÄÃ£ táº¡o thÃ nh cÃ´ng nhÃ¢n váº­t â€œ${characterName}â€.`);
              if (button) button.textContent = 'Ghi thÃ nh cÃ´ng';
              setTimeout(() => {
                if (button) button.textContent = 'Ghi vÃ o Lorebook';
              }, 2000);
            } catch (error) {
              console.error('Lá»—i khi ghi tháº» nhÃ¢n váº­t vÃ o Lorebook:', error);
              this.showTemporaryMessage(`Ghi tháº¥t báº¡i: ${error.message}`);
              if (button) button.textContent = 'Ghi tháº¥t báº¡i';
            }
          },

          async updateCurrentSceneLorebook(sceneContent) {
            // å¢åŠ å¥å£®æ€§æ£€æŸ¥ï¼Œé˜²æ­¢å†™å…¥ç©ºå†…å®¹
            if (!sceneContent || sceneContent.trim() === '') {
              console.warn('[Quy KhÆ°] Äang cá»‘ ghi ná»™i dung trá»‘ng vÃ o â€œCáº£nh Hiá»‡n Táº¡iâ€, thao tÃ¡c Ä‘Ã£ bá»‹ há»§y.');
              return;
            }
            const bookName = 'Quy KhÆ° 2.5-UI';
            const sceneKey = 'Cáº£nh hiá»‡n táº¡i';
            try {
              const allEntries = await TavernHelper.getLorebookEntries(bookName);
              const sceneEntry = allEntries.find(entry => entry.comment === sceneKey);

              if (!sceneEntry) {
                console.warn(
                  `[Quy KhÆ°] KhÃ´ng tÃ¬m tháº¥y má»¥c Lorebook "${sceneKey}", khÃ´ng thá»ƒ cáº­p nháº­t ná»™i dung cáº£nh. Vui lÃ²ng táº¡o nÃ³ trong Lorebook '${bookName}'.`,
                );
                // å¦‚æœæ¡ç›®ä¸å­˜åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©åˆ›å»ºä¸€ä¸ª
                await TavernHelper.createLorebookEntries(bookName, [
                  {
                    comment: sceneKey,
                    content: sceneContent,
                    keys: [],
                  },
                ]);
                console.log(`[Quy KhÆ°] ÄÃ£ táº¡o vÃ  cáº­p nháº­t ná»™i dung "${sceneKey}".`);
                return;
              }

              // Use overwrite update
              await TavernHelper.setLorebookEntries(bookName, [{ uid: sceneEntry.uid, content: sceneContent }]);
              console.log(`[Quy KhÆ°] Cáº­p nháº­t thÃ nh cÃ´ng ná»™i dung "${sceneKey}".`);
            } catch (error) {
              console.error(`[Quy KhÆ°] Lá»—i khi cáº­p nháº­t "${sceneKey}":`, error);
            }
          },

          async loadAndDisplayCurrentScene(messageContent = null) {
            const gameTextDisplay = document.getElementById('game-text-display');
            if (!gameTextDisplay) return;

            try {
              let contentToParse = messageContent;

              // å¦‚æœæ²¡æœ‰ç›´æ¥æä¾›å†…å®¹ï¼Œåˆ™ä»èŠå¤©è®°å½•ä¸­è·å–
              if (contentToParse === null) {
                const messages = await getChatMessages(getCurrentMessageId());
                if (!messages || messages.length === 0) return;
                const lastAiMessage = [...messages].reverse().find(m => m.role === 'assistant');
                if (lastAiMessage) {
                  contentToParse = lastAiMessage.message;
                }
              }

              if (contentToParse) {
                // 1. æ›´æ–°ä¸»ç•Œé¢æ­£æ–‡ (ä½¿ç”¨æ–°çš„å¥å£®çš„æå–å‡½æ•°)
                const displayText = this._getDisplayText(contentToParse);
                gameTextDisplay.innerHTML = this.formatMessageContent(displayText);

                // 2. åŒæ­¥æå–æ‰€æœ‰æ ‡ç­¾å†…å®¹åˆ°å˜é‡ï¼Œç”¨äºâ€œæŸ¥çœ‹æå–å†…å®¹â€æ¨¡æ€æ¡†
                this.lastExtractedNovelText = this._extractLastTagContent('gametxt', contentToParse);
                this.lastExtractedJourney = this._extractLastTagContent('æœ¬ä¸–å†ç¨‹', contentToParse);
                this.lastExtractedPastLives = this._extractLastTagContent('å¾€ä¸–æ¶Ÿæ¼ª', contentToParse);
                this.lastExtractedVariables = this._extractLastTagContent('UpdateVariable', contentToParse, true); // ignore case
                this.lastExtractedCharacterCard = this._extractLastTagContent('è§’è‰²æå–', contentToParse);
              }
            } catch (error) {
              console.error(`[Quy KhÆ°] Lá»—i khi táº£i vÃ  hiá»ƒn thá»‹ cáº£nh hiá»‡n táº¡i:`, error);
              gameTextDisplay.innerHTML = `<gametxt>Lá»—i khi táº£i cáº£nh.</gametxt>`;
            }
          },

          // --- æ–°å¢ï¼šçŠ¶æ€ä¿å­˜ä¸è‡ªåŠ¨å†™å…¥é€»è¾‘ ---
          saveAutoWriteState(state) {
            try {
              localStorage.setItem('guixu_auto_write_enabled', state);
            } catch (e) {
              console.error('LÆ°u tráº¡ng thÃ¡i tá»± Ä‘á»™ng ghi tháº¥t báº¡i:', e);
            }
          },

          loadAutoWriteState() {
            try {
              const savedState = localStorage.getItem('guixu_auto_write_enabled');
              // å¦‚æœlocalStorageä¸­æ²¡æœ‰ä¿å­˜è¿‡çŠ¶æ€ï¼Œåˆ™é»˜è®¤ä¸ºtrue (å¼€å¯)
              this.isAutoWriteEnabled = savedState === null ? true : savedState === 'true';
              const checkbox = document.getElementById('auto-write-checkbox');
              if (checkbox) {
                checkbox.checked = this.isAutoWriteEnabled;
              }
              // æ ¹æ®åŠ è½½çš„çŠ¶æ€å†³å®šæ˜¯å¦å¯åŠ¨è½®è¯¢
              if (this.isAutoWriteEnabled) {
                this.startAutoWritePolling();
              }
            } catch (e) {
              console.error('Táº£i tráº¡ng thÃ¡i tá»± Ä‘á»™ng ghi tháº¥t báº¡i:', e);
              this.isAutoWriteEnabled = false;
            }
          },

          saveNovelModeState(state) {
            try {
              localStorage.setItem('guixu_novel_mode_enabled', state);
            } catch (e) {
              console.error('LÆ°u tráº¡ng thÃ¡i cháº¿ Ä‘á»™ tiá»ƒu thuyáº¿t tháº¥t báº¡i:', e);
            }
          },

          loadNovelModeState() {
            try {
              const savedState = localStorage.getItem('guixu_novel_mode_enabled');
              // å°è¯´æ¨¡å¼é»˜è®¤ä¸º false (å…³é—­)
              this.isNovelModeEnabled = savedState === 'true';
              const checkbox = document.getElementById('novel-mode-enabled-checkbox');
              if (checkbox) {
                checkbox.checked = this.isNovelModeEnabled;
              }
              // æ ¹æ®åŠ è½½çš„çŠ¶æ€å†³å®šæ˜¯å¦å¯åŠ¨å°è¯´æ¨¡å¼çš„è½®è¯¢
              if (this.isNovelModeEnabled) {
                this.startNovelModeAutoWritePolling();
              }
            } catch (e) {
              console.error('Táº£i tráº¡ng thÃ¡i cháº¿ Ä‘á»™ tiá»ƒu thuyáº¿t tháº¥t báº¡i:', e);
              this.isNovelModeEnabled = false;
            }
          },

          startAutoWritePolling() {
            this.stopAutoWritePolling(); // å…ˆåœæ­¢ä»»ä½•å¯èƒ½å­˜åœ¨çš„æ—§è½®è¯¢
            console.log('[Quy KhÆ°] Báº¯t Ä‘áº§u thÄƒm dÃ² tá»± Ä‘á»™ng ghi...');
            this.autoWriteIntervalId = setInterval(() => {
              // ç›´æ¥è°ƒç”¨æŒ‰é’®çš„é€»è¾‘ï¼Œå¹¶ä¼ å…¥ silent=true
              if (this.lastExtractedJourney) {
                this.writeJourneyToLorebook(true);
              }
              if (this.lastExtractedPastLives) {
                this.writePastLivesToLorebook(true);
              }
            }, 2000); // æ¯2ç§’æ£€æŸ¥ä¸€æ¬¡
          },

          stopAutoWritePolling() {
            if (this.autoWriteIntervalId) {
              console.log('[Quy KhÆ°] Dá»«ng thÄƒm dÃ² tá»± Ä‘á»™ng ghi.');
              clearInterval(this.autoWriteIntervalId);
              this.autoWriteIntervalId = null;
            }
          },

          // --- æ–°å¢ï¼šå°è¯´æ¨¡å¼è‡ªåŠ¨å†™å…¥è½®è¯¢ ---
          startNovelModeAutoWritePolling() {
            this.stopNovelModeAutoWritePolling(); // å…ˆåœæ­¢ä»»ä½•å¯èƒ½å­˜åœ¨çš„æ—§è½®è¯¢
            console.log('[Quy KhÆ°] Báº¯t Ä‘áº§u thÄƒm dÃ² tá»± Ä‘á»™ng ghi cháº¿ Ä‘á»™ tiá»ƒu thuyáº¿t...');
            this.novelModeAutoWriteIntervalId = setInterval(() => {
              if (this.lastExtractedNovelText) {
                this.writeNovelModeToLorebook(true);
              }
            }, 2000); // æ¯2ç§’æ£€æŸ¥ä¸€æ¬¡
          },

          stopNovelModeAutoWritePolling() {
            if (this.novelModeAutoWriteIntervalId) {
              console.log('[Quy KhÆ°] Dá»«ng thÄƒm dÃ² tá»± Ä‘á»™ng ghi cháº¿ Ä‘á»™ tiá»ƒu thuyáº¿t.');
              clearInterval(this.novelModeAutoWriteIntervalId);
              this.novelModeAutoWriteIntervalId = null;
            }
          },

          // --- æ–°å¢ï¼šè£…å¤‡çŠ¶æ€ä¿å­˜ä¸åŠ è½½ ---
          saveEquipmentState() {
            try {
              localStorage.setItem('guixu_equipped_items', JSON.stringify(this.equippedItems));
            } catch (e) {
              console.error('LÆ°u tráº¡ng thÃ¡i trang bá»‹ tháº¥t báº¡i:', e);
            }
          },

          // **é€»è¾‘é‡æ„**: å½»åº•ç®€åŒ–çš„åŠ è½½å‡½æ•°
          loadEquipmentState() {
            try {
              const savedState = localStorage.getItem('guixu_equipped_items');
              if (savedState) {
                const loadedItems = JSON.parse(savedState);
                if (!loadedItems) return;

                this.equippedItems = loadedItems;

                const defaultTextMap = {
                  wuqi: 'VÅ© KhÃ­',
                  fangju: 'PhÃ²ng Cá»¥',
                  shipin: 'Phá»¥ Kiá»‡n',
                  fabao1: 'PhÃ¡p Báº£o',
                  zhuxiuGongfa: 'CÃ´ng PhÃ¡p Chá»§ Tu',
                  fuxiuXinfa: 'TÃ¢m PhÃ¡p Phá»¥ Tu',
                };

                // ç›´æ¥ç”¨ localStorage çš„æ•°æ®æ¸²æŸ“UI
                for (const slotKey in defaultTextMap) {
                  const slotElement = document.getElementById(`equip-${slotKey}`);
                  if (!slotElement) continue;

                  const itemData = this.equippedItems[slotKey];

                  if (itemData && typeof itemData === 'object') {
                    const tier = this.SafeGetValue(itemData, 'tier', 'PhÃ m Pháº©m');
                    const tierStyle = this.getTierStyle(tier);
                    slotElement.textContent = this.SafeGetValue(itemData, 'name');
                    slotElement.setAttribute('style', tierStyle);
                    slotElement.classList.add('equipped');
                    slotElement.dataset.itemDetails = JSON.stringify(itemData).replace(/'/g, "'");
                  } else {
                    slotElement.textContent = defaultTextMap[slotKey];
                    slotElement.classList.remove('equipped');
                    slotElement.removeAttribute('style');
                    delete slotElement.dataset.itemDetails;
                  }
                }
                this.updateDisplayedAttributes();
              }
            } catch (e) {
              console.error('Táº£i tráº¡ng thÃ¡i trang bá»‹ tháº¥t báº¡i:', e);
              localStorage.removeItem('guixu_equipped_items');
            }
          },

          savePendingActions() {
            try {
              localStorage.setItem('guixu_pending_actions', JSON.stringify(this.pendingActions));
            } catch (e) {
              console.error('LÆ°u tráº¡ng thÃ¡i hÃ ng Ä‘á»£i lá»‡nh tháº¥t báº¡i:', e);
            }
          },

          loadPendingActions() {
            try {
              const savedActions = localStorage.getItem('guixu_pending_actions');
              if (savedActions) {
                this.pendingActions = JSON.parse(savedActions) || [];
              }
            } catch (e) {
              console.error('Táº£i tráº¡ng thÃ¡i hÃ ng Ä‘á»£i lá»‡nh tháº¥t báº¡i:', e);
              this.pendingActions = [];
              localStorage.removeItem('guixu_pending_actions');
            }
          },
 
          // --- æ–°å¢ï¼šç»Ÿä¸€è¯»å†™åºå·å­˜å– ---
          saveUnifiedIndex() {
            try {
              localStorage.setItem('guixu_unified_index', this.unifiedIndex);
            } catch (e) {
              console.error('LÆ°u sá»‘ thá»© tá»± Ä‘á»c/ghi thá»‘ng nháº¥t tháº¥t báº¡i:', e);
            }
          },
 
          loadUnifiedIndex() {
            try {
              const savedIndex = localStorage.getItem('guixu_unified_index');
              if (savedIndex) {
                this.unifiedIndex = parseInt(savedIndex, 10) || 1;
              }
              const input = document.getElementById('unified-index-input');
              if (input) {
                input.value = this.unifiedIndex;
              }
            } catch (e) {
              console.error('Táº£i sá»‘ thá»© tá»± Ä‘á»c/ghi thá»‘ng nháº¥t tháº¥t báº¡i:', e);
              this.unifiedIndex = 1; // å‡ºé”™æ—¶é‡ç½®ä¸º1
            }
          },
 
           // --- æ–°å¢ï¼šè‡ªåŠ¨å¼€å…³ä¸–ç•Œä¹¦çŠ¶æ€å­˜å– ---
           saveAutoToggleState() {
             try {
               localStorage.setItem('guixu_auto_toggle_enabled', this.isAutoToggleLorebookEnabled);
             } catch (e) {
               console.error('LÆ°u tráº¡ng thÃ¡i tá»± Ä‘á»™ng báº­t/táº¯t tháº¥t báº¡i:', e);
             }
           },
 
           loadAutoToggleState() {
             try {
               const savedState = localStorage.getItem('guixu_auto_toggle_enabled');
               this.isAutoToggleLorebookEnabled = savedState === 'true';
               const checkbox = document.getElementById('auto-toggle-lorebook-checkbox');
               if (checkbox) {
                 checkbox.checked = this.isAutoToggleLorebookEnabled;
               }
               // æ ¹æ®åŠ è½½çš„çŠ¶æ€å†³å®šæ˜¯å¦å¯åŠ¨è½®è¯¢
                if (this.isAutoToggleLorebookEnabled) {
                    this.startAutoTogglePolling();
                }
             } catch (e) {
               console.error('Táº£i tráº¡ng thÃ¡i tá»± Ä‘á»™ng báº­t/táº¯t tháº¥t báº¡i:', e);
               this.isAutoToggleLorebookEnabled = false;
             }
           },

          // --- æ–°å¢ï¼šè‡ªåŠ¨å¼€å…³ä¸–ç•Œä¹¦è½®è¯¢é€»è¾‘ (V2: å¢åŠ æ¡ç›®è‡ªåŠ¨åˆ›å»º) ---
          async updateAutoToggledEntries(andDisableAll = false) {
            const bookName = 'Quy KhÆ° 2.5-UI';
            const index = this.unifiedIndex;
            const journeyKey = index > 1 ? `HÃ nh TrÃ¬nh Kiáº¿p NÃ y(${index})` : 'HÃ nh TrÃ¬nh Kiáº¿p NÃ y';
            const pastLivesKey = index > 1 ? `SÃ³ng NÆ°á»›c Kiáº¿p XÆ°a(${index})` : 'SÃ³ng NÆ°á»›c Kiáº¿p XÆ°a';

            try {
                let allEntries = await TavernHelper.getLorebookEntries(bookName);
                const entriesToCreate = [];

                // --- æ ¸å¿ƒä¿®å¤ï¼šæ£€æŸ¥å¹¶åˆ›å»ºç¼ºå¤±çš„æ¡ç›® ---
                const targetJourneyEntry = allEntries.find(e => e.comment === journeyKey);
                if (!targetJourneyEntry) {
                    const baseTemplate = allEntries.find(e => e.comment === 'HÃ nh TrÃ¬nh Kiáº¿p NÃ y');
                    if (baseTemplate) {
                        // æœ€ç»ˆä¿®å¤V3ï¼šä½¿ç”¨æ­£ç¡®çš„å±æ€§å¹¶ç¡®ä¿å¯ç”¨
                        const newJourneyEntry = { ...baseTemplate };
                        delete newJourneyEntry.uid;
                        newJourneyEntry.comment = journeyKey;
                        newJourneyEntry.content = '';
                        newJourneyEntry.keys = [...(baseTemplate.keys || []), journeyKey];
                        newJourneyEntry.enabled = true;
                        newJourneyEntry.position = 'before_character_definition';
                        newJourneyEntry.order = 20;
                        entriesToCreate.push(newJourneyEntry);
                    }
                }

                const targetPastLivesEntry = allEntries.find(e => e.comment === pastLivesKey);
                if (!targetPastLivesEntry) {
                    const baseTemplate = allEntries.find(e => e.comment === 'SÃ³ng NÆ°á»›c Kiáº¿p XÆ°a');
                    if (baseTemplate) {
                        // æœ€ç»ˆä¿®å¤V3ï¼šä½¿ç”¨æ­£ç¡®çš„å±æ€§å¹¶ç¡®ä¿å¯ç”¨
                        const newPastLivesEntry = { ...baseTemplate };
                        delete newPastLivesEntry.uid;
                        newPastLivesEntry.comment = pastLivesKey;
                        newPastLivesEntry.content = '';
                        newPastLivesEntry.keys = [...(baseTemplate.keys || []), pastLivesKey];
                        newPastLivesEntry.enabled = true;
                        newPastLivesEntry.position = 'before_character_definition';
                        newPastLivesEntry.order = 19;
                        entriesToCreate.push(newPastLivesEntry);
                    }
                }

                if (entriesToCreate.length > 0) {
                    await TavernHelper.createLorebookEntries(bookName, entriesToCreate);
                    console.log(`[Tá»± Ä‘á»™ng báº­t/táº¯t Quy KhÆ°] ÄÃ£ tá»± Ä‘á»™ng táº¡o ${entriesToCreate.length} má»¥c Lorebook má»›i.`);
                    // é‡æ–°è·å–æ‰€æœ‰æ¡ç›®ï¼Œä»¥åŒ…å«æ–°åˆ›å»ºçš„æ¡ç›®
                    allEntries = await TavernHelper.getLorebookEntries(bookName);
                }
                // --- ä¿®å¤ç»“æŸ ---

                const entriesToUpdate = [];
                for (const entry of allEntries) {
                    const isJourneyEntry = entry.comment.startsWith('HÃ nh TrÃ¬nh Kiáº¿p NÃ y');
                    const isPastLivesEntry = entry.comment.startsWith('SÃ³ng NÆ°á»›c Kiáº¿p XÆ°a');

                    if (!isJourneyEntry && !isPastLivesEntry) {
                        continue;
                    }

                    const isTarget = entry.comment === journeyKey || entry.comment === pastLivesKey;
                    const shouldBeEnabled = isTarget && !andDisableAll;

                    if (entry.enabled !== shouldBeEnabled) {
                        entriesToUpdate.push({ uid: entry.uid, enabled: shouldBeEnabled });
                    }
                }

                if (entriesToUpdate.length > 0) {
                    await TavernHelper.setLorebookEntries(bookName, entriesToUpdate);
                    console.log(`[Tá»± Ä‘á»™ng báº­t/táº¯t Quy KhÆ°] ÄÃ£ cáº­p nháº­t tráº¡ng thÃ¡i cá»§a ${entriesToUpdate.length} má»¥c Lorebook.`);
                }
            } catch (error) {
                console.error('[Tá»± Ä‘á»™ng báº­t/táº¯t Quy KhÆ°] Lá»—i khi cáº­p nháº­t tráº¡ng thÃ¡i má»¥c Lorebook:', error);
            }
          },

          startAutoTogglePolling() {
              this.stopAutoTogglePolling(false); // å…ˆåœæ­¢ä»»ä½•å¯èƒ½å­˜åœ¨çš„æ—§è½®è¯¢, ä½†ä¸ç¦ç”¨æ¡ç›®
              console.log('[Quy KhÆ°] Báº¯t Ä‘áº§u thÄƒm dÃ² tá»± Ä‘á»™ng báº­t/táº¯t Lorebook...');
              this.updateAutoToggledEntries(); // ç«‹å³æ‰§è¡Œä¸€æ¬¡
              this.autoToggleIntervalId = setInterval(() => this.updateAutoToggledEntries(), 5000); // æ¯5ç§’è½®è¯¢ä¸€æ¬¡
          },

          stopAutoTogglePolling(disableEntries = true) {
              if (this.autoToggleIntervalId) {
                  console.log('[Quy KhÆ°] Dá»«ng thÄƒm dÃ² tá»± Ä‘á»™ng báº­t/táº¯t Lorebook.');
                  clearInterval(this.autoToggleIntervalId);
                  this.autoToggleIntervalId = null;
              }
              if (disableEntries) {
                  // åœæ­¢æ—¶ï¼Œç¡®ä¿æ‰€æœ‰ç›¸å…³æ¡ç›®éƒ½è¢«ç¦ç”¨
                  this.updateAutoToggledEntries(true);
              }
          },

           // --- Misc ---
           applyRandomBackground() {
            const backgrounds = [
              'https://i.postimg.cc/ZqvGBxxF/rgthree-compare-temp-hxqke-00004.png',
              'https://i.postimg.cc/fRP4RrmR/rgthree-compare-temp-hxqke-00002.png',
            ];
            const bgUrl = backgrounds[Math.floor(Math.random() * backgrounds.length)];
            const container = document.querySelector('.guixu-root-container');
            if (container) container.style.backgroundImage = `url('${bgUrl}')`;
          },

          async executeQuickSend() {
            const input = document.getElementById('quick-send-input');
            if (!input) return;
            const userMessage = input.value.trim();
            await this.handleAction(userMessage);
          },

          // æ–°å¢ï¼šå¤„ç†æ‰€æœ‰åŠ¨ä½œçš„æ ¸å¿ƒå‡½æ•°

          async handleAction(userMessage = '') {
              // 1. æ•´åˆè¾“å…¥
              let commandText = '';
              if (this.pendingActions.length > 0) {
                  commandText += '[Má»‡nh lá»‡nh hÃ nh Ä‘á»™ng cá»§a lÆ°á»£t nÃ y]\n';
                  this.pendingActions.forEach(cmd => {
                      let actionText = '';
                      switch (cmd.action) {
                          case 'equip': actionText = `Trang bá»‹ [${cmd.itemName}] vÃ o Ã´ [${cmd.category}].`; break;
                          case 'unequip': actionText = `ThÃ¡o [${cmd.itemName}] tá»« Ã´ [${cmd.category}].`; break;
                          case 'use': actionText = `DÃ¹ng ${cmd.quantity} cÃ¡i [${cmd.itemName}].`; break;
                          case 'discard':
                            if (cmd.quantity && cmd.quantity > 1) {
                              actionText = `Vá»©t ${cmd.quantity} cÃ¡i [${cmd.itemName}].`;
                            } else {
                              actionText = `Vá»©t [${cmd.itemName}].`;
                            }
                            break;
                      }
                      commandText += `- ${actionText}\n`;
                  });
              }

              if (!userMessage && !commandText) {
                  this.showTemporaryMessage('Vui lÃ²ng nháº­p pháº£n há»“i hoáº·c thÃªm má»‡nh lá»‡nh rá»“i gá»­i.');
                  return;
              }

              // 2. æ„å»º GenerateConfig å¯¹è±¡
              const generateConfig = {
                  injects: [],
                  should_stream: false, // æˆ‘ä»¬ä¸€æ¬¡æ€§å¤„ç†æ•´ä¸ªå“åº”
              };

              // å°†ç”¨æˆ·è¾“å…¥å’ŒæŒ‡ä»¤åˆå¹¶ä¸ºä¸€ä¸ª user-role æ³¨å…¥
              let combinedContent = '';
              if (commandText) {
                  combinedContent += commandText + '\n'; // æŒ‡ä»¤åœ¨å‰
              }
              if (userMessage) {
                  combinedContent += `<è¡ŒåŠ¨é€‰æ‹©>\n${userMessage}\n</è¡ŒåŠ¨é€‰æ‹©>`;
              }

              if (combinedContent) {
                  generateConfig.injects.push({
                      role: 'user',
                      content: combinedContent,
                      position: 'in_chat', // æ’å…¥åˆ°èŠå¤©è®°å½•ä¸­
                      depth: 0,
                      should_scan: true, // å…è®¸æ‰«æå…³é”®å­—
                  });
              }

              this.lastSentPrompt = combinedContent; // æ›´æ–°è°ƒè¯•ä¿¡æ¯
              this.showWaitingMessage();

              try {
                  // 3. è°ƒç”¨ generateï¼Œä¼ å…¥é…ç½®å¯¹è±¡
                  let aiResponse;
                  try {
                      aiResponse = await TavernHelper.generate(generateConfig);
                  } catch (e) {
                      throw new Error(`Gá»i TavernHelper.generate tháº¥t báº¡i: ${e.message}`);
                  }

                  // è¯Šæ–­æ­¥éª¤ï¼šæ£€æŸ¥æˆ‘ä»¬æ˜¯å¦æ”¶åˆ°äº†æœ‰æ•ˆçš„å›å¤
                  if (typeof aiResponse !== 'string') {
                      throw new Error('AI khÃ´ng tráº£ vá» vÄƒn báº£n há»£p lá»‡, cÃ³ thá»ƒ lÃ  sá»± cá»‘ káº¿t ná»‘i API hoáº·c pháº£n há»“i trá»‘ng.');
                  }
                  console.log('[Quy KhÆ°] Pháº£n há»“i gá»‘c cá»§a AI:', aiResponse);

                  // 3. ä¿®æ­£ï¼šç›´æ¥ä½¿ç”¨AIçš„å®Œæ•´å›å¤ä½œä¸ºæ›´æ–°è„šæœ¬
                  // æ ¹æ® function.ts çš„æºç ï¼Œåç«¯çš„ extractCommands å‡½æ•°ä¼šè‡ªè¡Œæ‰«æå¹¶è§£æå®Œæ•´å­—ç¬¦ä¸²ä¸­çš„æ‰€æœ‰æŒ‡ä»¤ã€‚
                  // å‰ç«¯ä¸éœ€è¦ï¼Œä¹Ÿä¸åº”è¯¥è¿›è¡Œä»»ä½•å½¢å¼çš„æå–æˆ–æ¸…ç†ã€‚
                  const updateScript = aiResponse;
                  
                  // ä¸ºäº†è°ƒè¯•ç›®çš„ï¼Œæˆ‘ä»¬ä»ç„¶åœ¨â€œæŸ¥çœ‹æå–å†…å®¹â€æ¨¡æ€æ¡†ä¸­æ˜¾ç¤ºå®Œæ•´çš„AIå›å¤
                  this.lastExtractedVariables = aiResponse;
                  console.log('[Quy KhÆ°] ÄÃ£ gá»­i pháº£n há»“i Ä‘áº§y Ä‘á»§ cá»§a AI lÃ m ká»‹ch báº£n cho MVU:', updateScript);

                  // 4. è°ƒç”¨ mag_invoke_mvu å¤„ç†å˜é‡æ›´æ–°
                  if (updateScript && this.currentMvuState) {
                      const inputData = { old_variables: this.currentMvuState };
                      let mvuSucceeded = false;
                      try {
                          // å¢åŠ è¶…æ—¶æœºåˆ¶ï¼Œé˜²æ­¢ eventEmit å¡æ­»
                          const mvuPromise = eventEmit('mag_invoke_mvu', updateScript, inputData);
                          const timeoutPromise = new Promise((_, reject) => setTimeout(() => reject(new Error('MVU event timeout')), 3000));
                          await Promise.race([mvuPromise, timeoutPromise]);

                          if (inputData.new_variables) {
                              console.log('[Quy KhÆ°] Tráº¡ng thÃ¡i mvu Ä‘Ã£ Ä‘Æ°á»£c cáº­p nháº­t:', inputData.new_variables);
                              this.currentMvuState = inputData.new_variables; // Update cache
                              this.renderUI(this.currentMvuState.stat_data); // Re-render UI
                              mvuSucceeded = true;
                          } else {
                              console.log('[Quy KhÆ°] mvu khÃ´ng tráº£ vá» tráº¡ng thÃ¡i má»›i, thá»­ phÆ°Æ¡ng Ã¡n dá»± phÃ²ng phÃ­a client.');
                          }
                      } catch (eventError) {
                          console.error('[Quy KhÆ°] Lá»—i hoáº·c háº¿t thá»i gian chá» khi gá»i sá»± kiá»‡n mag_invoke_mvu, thá»­ phÆ°Æ¡ng Ã¡n dá»± phÃ²ng phÃ­a client:', eventError);
                      }

                      if (!mvuSucceeded) {
                          const modifiedState = this._applyUpdateFallback(updateScript, this.currentMvuState);
                          if (modifiedState) {
                              this.currentMvuState = modifiedState;
                              this.renderUI(this.currentMvuState.stat_data);
                              console.log('[Quy KhÆ°-Dá»± phÃ²ng] MÃ´ phá»ng cáº­p nháº­t phÃ­a client thÃ nh cÃ´ng.');
                          }
                      }
                  } else {
                      console.log('[Quy KhÆ°] KhÃ´ng tÃ¬m tháº¥y ká»‹ch báº£n cáº­p nháº­t hoáº·c tráº¡ng thÃ¡i mvu hiá»‡n táº¡i trá»‘ng, bá» qua cáº­p nháº­t mvu.');
                  }
                  
                  await this.loadAndDisplayCurrentScene(aiResponse);

                  // 5. é™é»˜ä¿å­˜åˆ°ç¬¬0å±‚ï¼Œå®ç°åŒå±‚æ¸¸ç©
                  let messages;
                  try {
                      messages = await getChatMessages('0');
                  } catch (e) {
                      throw new Error(`Gá»i getChatMessages('0') tháº¥t báº¡i: ${e.message}`);
                  }

                  if (messages && messages.length > 0) {
                      const messageZero = messages[0];
                      
                      // **å…³é”®ä¿®å¤**: ç›´æ¥ä½¿ç”¨æœªç»å¤„ç†çš„åŸå§‹AIå“åº”ï¼Œä»¥æ”¯æŒåŒå±‚æ¸¸ç©
                      messageZero.message = aiResponse;
                      messageZero.data = this.currentMvuState;
                      try {
                          await TavernHelper.setChatMessages([messageZero], { refresh: 'none' });
                      } catch (e) {
                          throw new Error(`Gá»i setChatMessages tháº¥t báº¡i: ${e.message}`);
                      }
                      console.log('[Quy KhÆ°] ÄÃ£ cáº­p nháº­t Ã¢m tháº§m táº§ng 0.');
                  } else {
                      console.error('[Quy KhÆ°] KhÃ´ng tÃ¬m tháº¥y tin nháº¯n táº§ng 0, khÃ´ng thá»ƒ cáº­p nháº­t.');
                  }

                  // 6. æ¸…ç†å·¥ä½œ
                  const input = document.getElementById('quick-send-input');
                  if (input) input.value = '';
                  this.pendingActions = [];
                  this.savePendingActions();
                  this.closeAllModals();
                  this.showTemporaryMessage('Má»™ng Tinh vÄ© Ä‘áº¡i Ä‘Ã£ há»“i Ä‘Ã¡p.');

              } catch (error) {
                  console.error('Lá»—i khi xá»­ lÃ½ hÃ nh Ä‘á»™ng:', error);
                  this.showTemporaryMessage(`Giao tiáº¿p vá»›i Má»™ng Tinh vÄ© Ä‘áº¡i tháº¥t báº¡i: ${error.message}`);
              } finally {
                  this.hideWaitingMessage();
                  // æœ€ç»ˆä¿®å¤ï¼šåœ¨æ‰€æœ‰æ“ä½œå®Œæˆåï¼Œä¸»åŠ¨ã€å¯é åœ°åˆ·æ–°UIï¼Œé¿å…ä»»ä½•äº‹ä»¶å†²çªã€‚
                  await this.updateDynamicData();
                  this.loadEquipmentState();
              }
          },

          // --- æ–°å¢ï¼šå¿«é€ŸæŒ‡ä»¤åˆ—è¡¨ç›¸å…³å‡½æ•° ---
          toggleQuickCommands() {
            const popup = document.getElementById('quick-command-popup');
            if (!popup) return;

            if (popup.style.display === 'block') {
              this.hideQuickCommands();
            } else {
              this.showQuickCommands();
            }
          },

          showQuickCommands() {
            const popup = document.getElementById('quick-command-popup');
            if (!popup) return;

            if (this.pendingActions.length === 0) {
              popup.innerHTML = '<div class="quick-command-empty">ChÆ°a cÃ³ má»‡nh lá»‡nh nÃ o chá» cháº¥p hÃ nh</div>';
            } else {
              let listHtml = '<ul class="quick-command-list">';
              this.pendingActions.forEach(cmd => {
                let actionText = '';
                switch (cmd.action) {
                  case 'equip':
                    actionText = `Trang bá»‹ [${cmd.itemName}] vÃ o Ã´ [${cmd.category}].`;
                    break;
                  case 'unequip':
                    actionText = `ThÃ¡o [${cmd.itemName}] tá»« Ã´ [${cmd.category}].`;
                    break;
                  case 'use':
                    actionText = `DÃ¹ng ${cmd.quantity} cÃ¡i [${cmd.itemName}].`;
                    break;
                  case 'discard':
                    if (cmd.quantity && cmd.quantity > 1) {
                      actionText = `Vá»©t ${cmd.quantity} cÃ¡i [${cmd.itemName}].`;
                    } else {
                      actionText = `Vá»©t [${cmd.itemName}].`;
                    }
                    break;
                }
                // åˆ—è¡¨é¡¹ä¸å†éœ€è¦data-commandå±æ€§
                listHtml += `<li class="quick-command-item">${actionText}</li>`;
              });
              listHtml += '</ul>';
              popup.innerHTML = listHtml;
            }
            popup.style.display = 'block';
          },

          hideQuickCommands() {
            const popup = document.getElementById('quick-command-popup');
            if (popup) {
              popup.style.display = 'none';
            }
          },

          // --- æ ¸å¿ƒé‡æ„ï¼šå‰ç«¯å¤‡ç”¨MVUå¤„ç†å™¨ ---
          // ç±»è„‘/æ—…ç¨‹æ¢¦æ˜Ÿä½œå“ï¼Œç¦æ­¢äºŒä¼ ï¼Œç¦æ­¢å•†ä¸šåŒ–ï¼Œå‡æ— å¿å…è´¹å¼€æºåˆ†äº«
          _applyUpdateFallback(script, currentMvuState) {
              if (!script || !currentMvuState) return null;
              
              const newState = _.cloneDeep(currentMvuState);
              let modified = false;

              const commands = this._extractCommands(script);

              for (const command of commands) {
                  try {
                      const path = this._trimQuotes(command.args[0]);
                      
                      switch (command.command) {
                          case 'set': {
                              const newValueStr = command.args.length >= 2 ? command.args[1] : undefined;
                              if(newValueStr === undefined) continue;
                              let newValue = this._parseCommandValue(newValueStr);
                              
                              if (newValue instanceof Date) newValue = newValue.toISOString();

                              _.set(newState.stat_data, path, newValue);
                              modified = true;
                              break;
                          }
                          case 'add': {
                              const value = _.get(newState.stat_data, path);
                              const delta = this._parseCommandValue(command.args[1]);
                              if (typeof value === 'number' && typeof delta === 'number') {
                                  _.set(newState.stat_data, path, value + delta);
                                  modified = true;
                              }
                              break;
                          }
                          case 'remove': {
                              _.unset(newState.stat_data, path);
                              modified = true;
                              break;
                          }
                          case 'assign':
                          case 'insert': {
                              if (command.args.length === 2) {
                                  // Handles _.assign('path', value)
                                  const valueToAssign = this._parseCommandValue(command.args[1]);
                                  const parentCollection = _.get(newState.stat_data, path);

                                  // Special handling for our [data_array, "description"] structure
                                  if (Array.isArray(parentCollection) && parentCollection.length === 2 && Array.isArray(parentCollection[0]) && typeof parentCollection[1] === 'string') {
                                      const innerArray = parentCollection[0];
                                      const description = parentCollection[1];
                                      const newInnerArray = innerArray.concat(Array.isArray(valueToAssign) ? valueToAssign : [valueToAssign]);
                                      const newParentArray = [newInnerArray, description];
                                      _.set(newState.stat_data, path, newParentArray);
                                      modified = true;
                                  } else if (Array.isArray(parentCollection)) {
                                      // Standard immutable update for regular arrays
                                      const newCollection = parentCollection.concat(Array.isArray(valueToAssign) ? valueToAssign : [valueToAssign]);
                                      _.set(newState.stat_data, path, newCollection);
                                      modified = true;
                                  } else if (_.isObject(parentCollection)) {
                                      // Merge for objects
                                      _.merge(parentCollection, valueToAssign);
                                      modified = true;
                                  } else {
                                      // If path doesn't exist, just set it
                                      _.set(newState.stat_data, path, valueToAssign);
                                      modified = true;
                                  }
                              } else if (command.args.length >= 3) {
                                  // Handles _.assign('path', key, value)
                                  const keyOrIndex = this._parseCommandValue(command.args[1]);
                                  const valueToAssign = this._parseCommandValue(command.args[2]);
                                  let collection = _.get(newState.stat_data, path);

                                  if (Array.isArray(collection)) {
                                      if (typeof keyOrIndex === 'number') {
                                          const newCollection = [...collection]; // Create a shallow copy for immutability
                                          newCollection.splice(keyOrIndex, 0, valueToAssign);
                                          _.set(newState.stat_data, path, newCollection);
                                          modified = true;
                                      }
                                  } else if (_.isObject(collection)) {
                                      _.set(collection, String(keyOrIndex), valueToAssign);
                                      modified = true;
                                  } else {
                                      // If collection doesn't exist, create it
                                      const newCollection = {};
                                      _.set(newCollection, String(keyOrIndex), valueToAssign);
                                      _.set(newState.stat_data, path, newCollection);
                                      modified = true;
                                  }
                              }
                              break;
                          }
                      }
                  } catch (e) {
                      console.error(`[Quy KhÆ°-Dá»± phÃ²ng] Xá»­ lÃ½ má»‡nh lá»‡nh tháº¥t báº¡i:`, command, e);
                  }
              }

              return modified ? newState : null;
          },

          // --- å†…éƒ¨è¾…åŠ©å‡½æ•°ï¼Œä» function.ts ç§»æ¤ ---
          _trimQuotes(str) {
              if (typeof str !== 'string') return str;
              return str.replace(/^['"` ]*(.*?)['"` ]*$/, '$1');
          },
          
          _parseCommandValue(valStr) {
              if (typeof valStr !== 'string') return valStr;
              const trimmed = valStr.trim();
              if (trimmed === 'true') return true;
              if (trimmed === 'false') return false;
              if (trimmed === 'null') return null;
              if (trimmed === 'undefined') return undefined;
              try {
                  return JSON.parse(trimmed);
              } catch (e) {
                  if ((trimmed.startsWith('{') && trimmed.endsWith('}')) || (trimmed.startsWith('[') && trimmed.endsWith(']'))) {
                      try {
                          return new Function(`return ${trimmed};`)();
                      } catch (err) { /* continue */ }
                  }
              }
              return this._trimQuotes(valStr);
          },

          _extractCommands(inputText) {
              const results = [];
              let i = 0;
              while (i < inputText.length) {
                  const match = inputText.substring(i).match(/_\.(set|assign|remove|add|insert)\(/);
                  if (!match || match.index === undefined) break;
                  
                  const commandType = match[1];
                  const start = i + match.index;
                  const openParen = start + match[0].length;
                  const closeParen = this._findMatchingCloseParen(inputText, openParen);
                  
                  if (closeParen === -1) {
                      i = openParen;
                      continue;
                  }
                  
                  let endPos = closeParen + 1;
                  if (endPos >= inputText.length || inputText[endPos] !== ';') {
                      i = closeParen + 1;
                      continue;
                  }
                  endPos++;
                  
                  const paramsString = inputText.substring(openParen, closeParen);
                  const params = this._parseParameters(paramsString);
                  
                  results.push({ command: commandType, args: params });
                  i = endPos;
              }
              return results;
          },

          _findMatchingCloseParen(str, startPos) {
              let parenCount = 1;
              let inQuote = false;
              let quoteChar = '';
              for (let i = startPos; i < str.length; i++) {
                  const char = str[i];
                  if ((char === '"' || char === "'" || char === '`') && str[i - 1] !== '\\') {
                      if (!inQuote) {
                          inQuote = true;
                          quoteChar = char;
                      } else if (char === quoteChar) {
                          inQuote = false;
                      }
                  }
                  if (!inQuote) {
                      if (char === '(') parenCount++;
                      else if (char === ')') {
                          parenCount--;
                          if (parenCount === 0) return i;
                      }
                  }
              }
              return -1;
          },

          _parseParameters(paramsString) {
              const params = [];
              let currentParam = '';
              let inQuote = false;
              let quoteChar = '';
              let bracketCount = 0;
              let braceCount = 0;
              let parenCount = 0;
              for (let i = 0; i < paramsString.length; i++) {
                  const char = paramsString[i];
                  if ((char === '"' || char === "'" || char === '`') && (i === 0 || paramsString[i - 1] !== '\\')) {
                      if (!inQuote) {
                          inQuote = true;
                          quoteChar = char;
                      } else if (char === quoteChar) {
                          inQuote = false;
                      }
                  }
                  if (!inQuote) {
                      if (char === '(') parenCount++;
                      if (char === ')') parenCount--;
                      if (char === '[') bracketCount++;
                      if (char === ']') bracketCount--;
                      if (char === '{') braceCount++;
                      if (char === '}') braceCount--;
                  }
                  if (char === ',' && !inQuote && parenCount === 0 && bracketCount === 0 && braceCount === 0) {
                      params.push(currentParam.trim());
                      currentParam = '';
                      continue;
                  }
                  currentParam += char;
              }
              if (currentParam.trim()) {
                  params.push(currentParam.trim());
              }
              return params;
          },

          // --- æ–°å¢ï¼šæ–‡æœ¬å‡€åŒ–è¾…åŠ©å‡½æ•° ---
          _getDisplayText(aiResponse) {
            try {
              if (!aiResponse || typeof aiResponse !== 'string') return '';
              
              // ä¼˜å…ˆæå– <gametxt> çš„å†…å®¹
              const gameText = this._extractLastTagContent('gametxt', aiResponse);
              if (gameText !== null) {
                  return gameText;
              }

              // å¤‡ç”¨æ–¹æ¡ˆï¼šå¦‚æœæ‰¾ä¸åˆ° <gametxt>ï¼Œåˆ™ç§»é™¤æ‰€æœ‰å·²çŸ¥çš„éæ˜¾ç¤ºæ ‡ç­¾
              let cleanedText = aiResponse;
              const tagsToRemove = ['æœ¬ä¸–å†ç¨‹', 'å¾€ä¸–æ¶Ÿæ¼ª', 'UpdateVariable', 'è§’è‰²æå–', 'thinking'];
              
              tagsToRemove.forEach(tag => {
                  // ç§»é™¤ <tag>...</tag> ç»“æ„
                  const regexWithContent = new RegExp(`<${tag}>[\\s\\S]*?<\\/${tag}>`, 'gi');
                  cleanedText = cleanedText.replace(regexWithContent, '');
                  // ç§»é™¤è‡ªé—­åˆçš„ <tag/> ç»“æ„
                  const regexSelfClosing = new RegExp(`<${tag}\\s*\\/>`, 'gi');
                  cleanedText = cleanedText.replace(regexSelfClosing, '');
              });

              return cleanedText.trim();
            } catch (e) {
              console.error("Lá»—i khi phÃ¢n tÃ­ch vÄƒn báº£n hiá»ƒn thá»‹:", e, "Äáº§u vÃ o gá»‘c:", aiResponse);
              return "[PhÃ¢n tÃ­ch tÃ³m táº¯t tháº¥t báº¡i]";
            }
          },

          // --- æ–°å¢ï¼šå¯é‡ç”¨çš„ã€å¥å£®çš„æ ‡ç­¾æå–å‡½æ•° ---
          _extractLastTagContent(tagName, text, ignoreCase = false) {
              if (!text || typeof text !== 'string') return null;

              const endTag = `</${tagName}>`;
              let searchPool = text;
              let endTagPattern = endTag;

              if (ignoreCase) {
                  searchPool = text.toLowerCase();
                  endTagPattern = endTag.toLowerCase();
              }

              const lastEndIndex = searchPool.lastIndexOf(endTagPattern);

              if (lastEndIndex !== -1) {
                  const startTag = `<${tagName}>`;
                  let startTagPattern = startTag;
                  if (ignoreCase) {
                      startTagPattern = startTag.toLowerCase();
                  }
                  
                  const lastStartIndex = searchPool.lastIndexOf(startTagPattern, lastEndIndex);

                  if (lastStartIndex !== -1) {
                      const startIndex = lastStartIndex + startTag.length;
                      return text.substring(startIndex, lastEndIndex).trim();
                  }
              }
              return null;
          },

          // --- æ–°å¢ï¼šå¤šå­˜æ¡£ç®¡ç†åŠŸèƒ½ ---
          showSaveLoadManager() {
            this.openModal('save-load-modal');
            const container = document.getElementById('save-slots-container');
            if (!container) return;

            let saves;
            try {
                saves = this.getSavesFromStorage();
            } catch (e) {
                console.error("PhÃ¢n tÃ­ch toÃ n bá»™ tá»‡p lÆ°u trá»¯ tháº¥t báº¡i, cÃ³ thá»ƒ do lá»—i Ä‘á»‹nh dáº¡ng JSON:", e);
                container.innerHTML = `
                    <div style="color: #ff6b6b; padding: 20px; text-align: center;">
                        <p>Lá»—i: Tá»‡p lÆ°u trá»¯ chÃ­nh Ä‘Ã£ bá»‹ há»ng, khÃ´ng thá»ƒ Ä‘á»c.</p>
                        <p style="font-size: 12px; color: #8b7355; margin-top: 10px;">Báº¡n cÃ³ thá»ƒ thá»­ "LÃ m má»›i bá»™ nhá»› Ä‘á»‡m" trong Trung tÃ¢m Má»‡nh lá»‡nh Ä‘á»ƒ xÃ³a táº¥t cáº£ dá»¯ liá»‡u cá»¥c bá»™.</p>
                    </div>
                `;
                return;
            }

            let html = '';
            const totalSlots = 5; // æ€»å…±æä¾›5ä¸ªå­˜æ¡£ä½

            for (let i = 1; i <= totalSlots; i++) {
              const slotId = `slot_${i}`;
              try {
                const saveData = saves[slotId];
                
                html += `
                  <div class="save-slot" data-slot-id="${slotId}">
                    <div class="save-slot-info">
                `;

                // **æœ€ç»ˆä¿®å¤**: æ™ºèƒ½åˆ¤æ–­å­˜æ¡£ç»“æ„ï¼Œå…¼å®¹æ–°æ—§ä¸¤ç§æ•°æ®æ ¼å¼
                let statDataForRender = null;
                // **æœ€ç»ˆä¿®å¤V2**: å¢åŠ æ›´ä¸¥æ ¼çš„ç±»å‹æ£€æŸ¥ï¼Œé˜²æ­¢ mvu_data ä¸º null æˆ–éå¯¹è±¡æ—¶å‡ºé”™
                if (saveData && typeof saveData.mvu_data === 'object' && saveData.mvu_data !== null) {
                    if (saveData.mvu_data.stat_data) {
                        // å…¼å®¹æ—§ç»“æ„: { mvu_data: { stat_data: {...} } }
                        statDataForRender = saveData.mvu_data.stat_data;
                    } else if (saveData.mvu_data['Cáº£nh Giá»›i Hiá»‡n Táº¡i']) {
                        // å…¼å®¹æ–°ç»“æ„: { mvu_data: {...} } (mvu_dataæœ¬èº«å°±æ˜¯stat_data)
                        statDataForRender = saveData.mvu_data;
                    }
                }

                if (statDataForRender) {
                  const date = new Date(saveData.timestamp).toLocaleString('vi-VN');
                  const jingjie = this.SafeGetValue(statDataForRender, 'Cáº£nh Giá»›i Hiá»‡n Táº¡i.0', 'Cáº£nh giá»›i khÃ´ng rÃµ');
                  const jinian = this.SafeGetValue(statDataForRender, 'NiÃªn Äáº¡i Thá»i Gian Hiá»‡n Táº¡i.0', 'NiÃªn ká»· khÃ´ng rÃµ');
                  const summary = this._getDisplayText(saveData.message_content);
                  const saveName = saveData.save_name || `LÆ°u trá»¯ ${i}`;

                  html += `
                      <div class="slot-name">${saveName}</div>
                      <div class="slot-time">${date} - ${jingjie} - ${jinian}</div>
                      <div class="slot-summary">${summary ? summary.substring(0, 40) + '...' : 'KhÃ´ng cÃ³ ghi chÃ©p chÃ­nh vÄƒn'}</div>
                  `;
                } else if (saveData) {
                  // å­˜æ¡£å­˜åœ¨ï¼Œä½†æ•°æ®ç»“æ„ä¸å®Œæ•´
                  html += `
                      <div class="slot-name">LÆ°u trá»¯ ${i}</div>
                      <div class="slot-time" style="color: #ff6b6b; font-weight: bold;">Dá»¯ liá»‡u lÆ°u trá»¯ bá»‹ há»ng (thiáº¿u dá»¯ liá»‡u chÃ­nh)</div>
                  `;
                } else {
                  // ç©ºå­˜æ¡£ä½
                  html += `
                      <div class="slot-name">LÆ°u trá»¯ ${i}</div>
                      <div class="slot-time" style="font-style: italic; color: #8b7355;">Ã” lÆ°u trá»¯ trá»‘ng</div>
                  `;
                }

                html += `
                    </div>
                    <div class="save-slot-actions">
                      <button class="interaction-btn btn-save-slot" style="padding: 8px 12px;">LÆ°u</button>
                      <button class="interaction-btn btn-load-slot" style="padding: 8px 12px;" ${!saveData ? 'disabled' : ''}>Táº£i</button>
                      <button class="interaction-btn btn-delete-slot" style="padding: 8px 12px; background: #8b0000;" ${!saveData ? 'disabled' : ''}>XÃ³a</button>
                    </div>
                  </div>
                `;
              } catch (e) {
                console.error(`Lá»—i khÃ´ng xÃ¡c Ä‘á»‹nh khi hiá»ƒn thá»‹ Ã´ lÆ°u trá»¯ ${i} (ID: ${slotId}):`, e);
                html += `
                  <div class="save-slot" data-slot-id="${slotId}">
                    <div class="save-slot-info">
                      <div class="slot-name">LÆ°u trá»¯ ${i}</div>
                      <div class="slot-time" style="color: #ff6b6b; font-weight: bold;">Lá»—i khÃ´ng xÃ¡c Ä‘á»‹nh khi hiá»ƒn thá»‹</div>
                      <div class="slot-summary" style="font-size:10px; color: #8b7355;">${e.message}</div>
                    </div>
                    <div class="save-slot-actions">
                      <button class="interaction-btn btn-save-slot" style="padding: 8px 12px;">Ghi Ä‘Ã¨</button>
                      <button class="interaction-btn btn-load-slot" style="padding: 8px 12px;" disabled>Táº£i</button>
                      <button class="interaction-btn btn-delete-slot" style="padding: 8px 12px; background: #8b0000;">XÃ³a</button>
                    </div>
                  </div>
                `;
              }
            }
            container.innerHTML = html;
            this.bindSaveSlotListeners();
          },

          bindSaveSlotListeners() {
            const container = document.getElementById('save-slots-container');
            if (!container) {
              console.error('[LÆ°u trá»¯ Quy KhÆ°] KhÃ´ng tÃ¬m tháº¥y pháº§n tá»­ chá»©a cÃ¡c Ã´ lÆ°u trá»¯');
              return;
            }

            // ä½¿ç”¨å…‹éš†èŠ‚ç‚¹çš„æ–¹å¼æ¥ç¡®ä¿æ¯æ¬¡éƒ½ç»‘å®šæ–°çš„ã€å¹²å‡€çš„äº‹ä»¶ç›‘å¬å™¨
            const newContainer = container.cloneNode(true);
            container.parentNode.replaceChild(newContainer, container);

            console.log('[LÆ°u trá»¯ Quy KhÆ°] GÃ¡n trÃ¬nh láº¯ng nghe sá»± kiá»‡n cho cÃ¡c nÃºt lÆ°u trá»¯');
            newContainer.addEventListener('click', (e) => {
              const target = e.target;
              const slotDiv = target.closest('.save-slot');
              if (!slotDiv) return;
              
              const slotId = slotDiv.dataset.slotId;
              console.log('[LÆ°u trá»¯ Quy KhÆ°] Nháº¥n nÃºt lÆ°u trá»¯, Ã´:', slotId, 'loáº¡i nÃºt:', target.className);

              if (target.classList.contains('btn-save-slot')) {
                console.log('[LÆ°u trá»¯ Quy KhÆ°] Thá»±c hiá»‡n thao tÃ¡c lÆ°u');
                this.saveGame(slotId);
              } else if (target.classList.contains('btn-load-slot')) {
                console.log('[LÆ°u trá»¯ Quy KhÆ°] Thá»±c hiá»‡n thao tÃ¡c táº£i');
                this.loadGame(slotId);
              } else if (target.classList.contains('btn-delete-slot')) {
                console.log('[LÆ°u trá»¯ Quy KhÆ°] Thá»±c hiá»‡n thao tÃ¡c xÃ³a');
                this.deleteSave(slotId);
              }
            });
          },

          getSavesFromStorage() {
            try {
              const saves = localStorage.getItem('guixu_multi_save_data');
              return saves ? JSON.parse(saves) : {};
            } catch (e) {
              console.error("Láº¥y tá»‡p lÆ°u tháº¥t báº¡i:", e);
              return {};
            }
          },

          async saveGame(slotId) {
            try {
              // é¦–å…ˆå¼¹å‡ºè¾“å…¥æ¡†è®©ç”¨æˆ·å‘½åå­˜æ¡£
              const saveName = await this.promptForSaveName(slotId);
              if (!saveName) {
                this.showTemporaryMessage('ÄÃ£ há»§y lÆ°u trá»¯');
                return;
              }

              const allSaves = this.getSavesFromStorage();
              const slotExists = allSaves[slotId];

              const performSave = async () => {
                try {
                  // ä¿®å¤ï¼šä¼˜å…ˆä½¿ç”¨ç¼“å­˜çš„mvuçŠ¶æ€ï¼Œå¦‚æœæ²¡æœ‰å†ä»æ¶ˆæ¯è·å–
                  let currentMvuData = this.currentMvuState;
                  let currentMessageContent = '';
                  
                  if (!currentMvuData) {
                    console.log('[LÆ°u trá»¯ Quy KhÆ°] Tráº¡ng thÃ¡i cache trá»‘ng, thá»­ láº¥y tá»« tin nháº¯n...');
                    const messages = await getChatMessages(getCurrentMessageId());
                    if (!messages || messages.length === 0) {
                      this.showTemporaryMessage('Lá»—i: KhÃ´ng thá»ƒ láº¥y dá»¯ liá»‡u tin nháº¯n hiá»‡n táº¡i, khÃ´ng thá»ƒ lÆ°u.');
                      return;
                    }
                    currentMvuData = messages[0].data;
                    currentMessageContent = messages[0].message || '';
                  } else {
                    // å¦‚æœæœ‰ç¼“å­˜çŠ¶æ€ï¼Œä¹Ÿå°è¯•è·å–å½“å‰æ¶ˆæ¯å†…å®¹
                    try {
                      const messages = await getChatMessages(getCurrentMessageId());
                      if (messages && messages.length > 0) {
                        currentMessageContent = messages[0].message || '';
                      }
                    } catch (e) {
                      console.warn('[LÆ°u trá»¯ Quy KhÆ°] Láº¥y ná»™i dung tin nháº¯n tháº¥t báº¡i, sá»­ dá»¥ng ná»™i dung trá»‘ng:', e);
                    }
                  }
                  
                  if (!currentMvuData || !currentMvuData.stat_data) {
                    this.showTemporaryMessage('é”™è¯¯ï¼šMVUæ•°æ®ä¸å®Œæ•´ï¼Œæ— æ³•å­˜æ¡£ã€‚è¯·å…ˆè¿›è¡Œä¸€æ¬¡æ¸¸æˆæ“ä½œã€‚');
                    return;
                  }
                  
                  console.log('[LÆ°u trá»¯ Quy KhÆ°] Báº¯t Ä‘áº§u lÆ°u, kiá»ƒm tra dá»¯ liá»‡u Ä‘Ã£ qua');
                

                // --- æ–°é€»è¾‘ï¼šåˆ›å»ºç‹¬ç«‹çš„ä¸–ç•Œä¹¦æ¡ç›® ---
                const bookName = 'Quy KhÆ° 2.5-UI';
                const index = this.unifiedIndex;
                const journeyKey = index > 1 ? `HÃ nh TrÃ¬nh Kiáº¿p NÃ y(${index})` : 'HÃ nh TrÃ¬nh Kiáº¿p NÃ y';
                const pastLivesKey = index > 1 ? `SÃ³ng NÆ°á»›c Kiáº¿p XÆ°a(${index})` : 'SÃ³ng NÆ°á»›c Kiáº¿p XÆ°a';
                
                // ç”Ÿæˆç‹¬ç«‹ä¸–ç•Œä¹¦æ¡ç›®åç§°
                const saveJourneyEntryName = `${saveName}-HÃ nh TrÃ¬nh Kiáº¿p NÃ y`;
                const savePastLivesEntryName = `${saveName}-SÃ³ng NÆ°á»›c Kiáº¿p XÆ°a`;
                
                let lorebookEntries = {
                  journey_entry_name: saveJourneyEntryName,
                  past_lives_entry_name: savePastLivesEntryName
                };

                try {
                  const allEntries = await TavernHelper.getLorebookEntries(bookName);
                  const journeyEntry = allEntries.find(entry => entry.comment === journeyKey);
                  const pastLivesEntry = allEntries.find(entry => entry.comment === pastLivesKey);
                  
                  // åˆ›å»ºç‹¬ç«‹çš„ä¸–ç•Œä¹¦æ¡ç›®
                  const entriesToCreate = [];
                  
                  // ä¿®å¤ï¼šå³ä½¿å†…å®¹ä¸ºç©ºä¹Ÿåˆ›å»ºæ¡ç›®ï¼Œé¿å…å­˜æ¡£å¤±è´¥
                  if (journeyEntry) {
                    entriesToCreate.push({
                      comment: saveJourneyEntryName,
                      content: journeyEntry.content || '', // å…è®¸ç©ºå†…å®¹
                      keys: [saveJourneyEntryName],
                      enabled: false, // é»˜è®¤ç¦ç”¨
                      position: 'before_character_definition',
                      order: 20
                    });
                    console.log(`[LÆ°u trá»¯ Quy KhÆ°] Chuáº©n bá»‹ táº¡o má»¥c HÃ nh TrÃ¬nh Kiáº¿p NÃ y, Ä‘á»™ dÃ i ná»™i dung: ${(journeyEntry.content || '').length}`);
                  } else {
                    // å¦‚æœæ‰¾ä¸åˆ°åŸå§‹æ¡ç›®ï¼Œåˆ›å»ºä¸€ä¸ªç©ºçš„
                    entriesToCreate.push({
                      comment: saveJourneyEntryName,
                      content: '# HÃ nh TrÃ¬nh Kiáº¿p NÃ y\nTáº¡m thá»i khÃ´ng cÃ³ ghi chÃ©p',
                      keys: [saveJourneyEntryName],
                      enabled: false,
                      position: 'before_character_definition',
                      order: 20
                    });
                    console.log(`[LÆ°u trá»¯ Quy KhÆ°] Má»¥c HÃ nh TrÃ¬nh Kiáº¿p NÃ y gá»‘c khÃ´ng tá»“n táº¡i, táº¡o má»¥c trá»‘ng`);
                  }
                  
                  if (pastLivesEntry) {
                    entriesToCreate.push({
                      comment: savePastLivesEntryName,
                      content: pastLivesEntry.content || '', // å…è®¸ç©ºå†…å®¹
                      keys: [savePastLivesEntryName],
                      enabled: false, // é»˜è®¤ç¦ç”¨
                      position: 'before_character_definition',
                      order: 19
                    });
                    console.log(`[LÆ°u trá»¯ Quy KhÆ°] Chuáº©n bá»‹ táº¡o má»¥c SÃ³ng NÆ°á»›c Kiáº¿p XÆ°a, Ä‘á»™ dÃ i ná»™i dung: ${(pastLivesEntry.content || '').length}`);
                  } else {
                    // å¦‚æœæ‰¾ä¸åˆ°åŸå§‹æ¡ç›®ï¼Œåˆ›å»ºä¸€ä¸ªç©ºçš„
                    entriesToCreate.push({
                      comment: savePastLivesEntryName,
                      content: '# SÃ³ng NÆ°á»›c Kiáº¿p XÆ°a\nTáº¡m thá»i khÃ´ng cÃ³ ghi chÃ©p',
                      keys: [savePastLivesEntryName],
                      enabled: false,
                      position: 'before_character_definition',
                      order: 19
                    });
                    console.log(`[LÆ°u trá»¯ Quy KhÆ°] Má»¥c SÃ³ng NÆ°á»›c Kiáº¿p XÆ°a gá»‘c khÃ´ng tá»“n táº¡i, táº¡o má»¥c trá»‘ng`);
                  }
                  
                  if (entriesToCreate.length > 0) {
                    await TavernHelper.createLorebookEntries(bookName, entriesToCreate);
                    console.log(`[LÆ°u trá»¯ Quy KhÆ°] ÄÃ£ táº¡o ${entriesToCreate.length} má»¥c Lorebook Ä‘á»™c láº­p`);
                  }
                  
                } catch (e) {
                  console.error("Lá»—i khi táº¡o má»¥c Lorebook Ä‘á»™c láº­p:", e);
                  this.showTemporaryMessage("Cáº£nh bÃ¡o: Táº¡o má»¥c Lorebook tháº¥t báº¡i, nhÆ°ng dá»¯ liá»‡u chÃ­nh váº«n sáº½ Ä‘Æ°á»£c lÆ°u.");
                }
                // --- æ–°é€»è¾‘ç»“æŸ ---
                
                const saveDataPayload = {
                  timestamp: new Date().toISOString(),
                  save_name: saveName, // æ–°å¢ï¼šç”¨æˆ·è¾“å…¥çš„å­˜æ¡£åç§°
                  message_content: currentMessageContent,
                  lorebook_entries: lorebookEntries, // ä¿®æ”¹ï¼šæ”¹ä¸ºä¸–ç•Œä¹¦æ¡ç›®åç§°
                  mvu_data: {
                    stat_data: currentMvuData.stat_data,
                    schema: currentMvuData.schema,
                    initialized_lorebooks: currentMvuData.initialized_lorebooks,
                    display_data: currentMvuData.display_data,
                    delta_data: currentMvuData.delta_data,
                  }
                };

                allSaves[slotId] = saveDataPayload;

                localStorage.setItem('guixu_multi_save_data', JSON.stringify(allSaves));
                this.showTemporaryMessage(`Tá»‡p lÆ°u "${saveName}" Ä‘Ã£ Ä‘Æ°á»£c lÆ°u vÃ o Ã´ ${slotId.split('_')[1]}`);
                this.showSaveLoadManager(); // Refresh UI
                } catch (error) {
                  console.error('LÆ°u tháº¥t báº¡i:', error);
                  this.showTemporaryMessage(`LÆ°u tháº¥t báº¡i: ${error.message}`);
                }
              };

              if (slotExists) {
                this.showCustomConfirm(`Ã” lÆ°u trá»¯ ${slotId.split('_')[1]} Ä‘Ã£ cÃ³ dá»¯ liá»‡u, cháº¯c cháº¯n muá»‘n ghi Ä‘Ã¨ khÃ´ng?`, performSave);
              } else {
                await performSave();
              }
            } catch (error) {
              console.error('Lá»—i trong quÃ¡ trÃ¬nh lÆ°u:', error);
              this.showTemporaryMessage(`LÆ°u tháº¥t báº¡i: ${error.message}`);
            }
          },

          async loadGame(slotId) {
            const allSaves = this.getSavesFromStorage();
            const saveData = allSaves[slotId];
            
            if (!saveData) {
              this.showTemporaryMessage('KhÃ´ng tÃ¬m tháº¥y tá»‡p lÆ°u.');
              return;
            }

            const saveName = saveData.save_name || `LÆ°u trá»¯ ${slotId.split('_')[1]}`;
            this.showCustomConfirm(`Cháº¯c cháº¯n muá»‘n táº£i tá»‡p lÆ°u "${saveName}" khÃ´ng? Táº¥t cáº£ tiáº¿n Ä‘á»™ chÆ°a lÆ°u hiá»‡n táº¡i sáº½ bá»‹ ghi Ä‘Ã¨.`, async () => {
              try {
                const messages = await getChatMessages(getCurrentMessageId());
                if (!messages || messages.length === 0) {
                  this.showTemporaryMessage('Lá»—i: KhÃ´ng thá»ƒ láº¥y tin nháº¯n hiá»‡n táº¡i, khÃ´ng thá»ƒ táº£i.');
                  return;
                }
                
                const messageZero = messages[0];
                const loadedData = saveData.mvu_data;
                const loadedMessageContent = saveData.message_content || '';

                messageZero.data = loadedData;
                messageZero.message = loadedMessageContent;

                // --- æ–°é€»è¾‘ï¼šä»ç‹¬ç«‹ä¸–ç•Œä¹¦æ¢å¤åˆ°å½“å‰åºå· ---
                if (saveData.lorebook_entries) {
                  const entries = saveData.lorebook_entries;
                  const bookName = 'Quy KhÆ° 2.5-UI';
                  const currentIndex = this.unifiedIndex;
                  const currentJourneyKey = currentIndex > 1 ? `HÃ nh TrÃ¬nh Kiáº¿p NÃ y(${currentIndex})` : 'HÃ nh TrÃ¬nh Kiáº¿p NÃ y';
                  const currentPastLivesKey = currentIndex > 1 ? `SÃ³ng NÆ°á»›c Kiáº¿p XÆ°a(${currentIndex})` : 'SÃ³ng NÆ°á»›c Kiáº¿p XÆ°a';

                  try {
                    const allEntries = await TavernHelper.getLorebookEntries(bookName);
                    
                    // æŸ¥æ‰¾å­˜æ¡£çš„ç‹¬ç«‹ä¸–ç•Œä¹¦æ¡ç›®
                    const saveJourneyEntry = allEntries.find(entry => entry.comment === entries.journey_entry_name);
                    const savePastLivesEntry = allEntries.find(entry => entry.comment === entries.past_lives_entry_name);
                    
                    // æŸ¥æ‰¾å½“å‰åºå·çš„ä¸–ç•Œä¹¦æ¡ç›®
                    const currentJourneyEntry = allEntries.find(entry => entry.comment === currentJourneyKey);
                    const currentPastLivesEntry = allEntries.find(entry => entry.comment === currentPastLivesKey);
                    
                    const entriesToUpdate = [];
                    
                    // Overwrite HÃ nh TrÃ¬nh Kiáº¿p NÃ y - Fix: Allow restoration of empty content
                    if (saveJourneyEntry) {
                      const contentToRestore = saveJourneyEntry.content || '';
                      if (currentJourneyEntry) {
                        // æ›´æ–°ç°æœ‰æ¡ç›®
                        entriesToUpdate.push({
                          uid: currentJourneyEntry.uid,
                          content: contentToRestore
                        });
                        console.log(`[Táº£i Quy KhÆ°] Cáº­p nháº­t má»¥c HÃ nh TrÃ¬nh Kiáº¿p NÃ y, Ä‘á»™ dÃ i ná»™i dung: ${contentToRestore.length}`);
                      } else {
                        // åˆ›å»ºæ–°æ¡ç›®
                        await TavernHelper.createLorebookEntries(bookName, [{
                          comment: currentJourneyKey,
                          content: contentToRestore,
                          keys: [currentJourneyKey],
                          enabled: true,
                          position: 'before_character_definition',
                          order: 20
                        }]);
                        console.log(`[Táº£i Quy KhÆ°] Táº¡o má»¥c HÃ nh TrÃ¬nh Kiáº¿p NÃ y, Ä‘á»™ dÃ i ná»™i dung: ${contentToRestore.length}`);
                      }
                    }
                    
                    // Overwrite SÃ³ng NÆ°á»›c Kiáº¿p XÆ°a - Fix: Allow restoration of empty content
                    if (savePastLivesEntry) {
                      const contentToRestore = savePastLivesEntry.content || '';
                      if (currentPastLivesEntry) {
                        // æ›´æ–°ç°æœ‰æ¡ç›®
                        entriesToUpdate.push({
                          uid: currentPastLivesEntry.uid,
                          content: contentToRestore
                        });
                        console.log(`[Táº£i Quy KhÆ°] Cáº­p nháº­t má»¥c SÃ³ng NÆ°á»›c Kiáº¿p XÆ°a, Ä‘á»™ dÃ i ná»™i dung: ${contentToRestore.length}`);
                      } else {
                        // åˆ›å»ºæ–°æ¡ç›®
                        await TavernHelper.createLorebookEntries(bookName, [{
                          comment: currentPastLivesKey,
                          content: contentToRestore,
                          keys: [currentPastLivesKey],
                          enabled: true,
                          position: 'before_character_definition',
                          order: 19
                        }]);
                        console.log(`[Táº£i Quy KhÆ°] Táº¡o má»¥c SÃ³ng NÆ°á»›c Kiáº¿p XÆ°a, Ä‘á»™ dÃ i ná»™i dung: ${contentToRestore.length}`);
                      }
                    }
                    
                    // æ‰¹é‡æ›´æ–°ç°æœ‰æ¡ç›®
                    if (entriesToUpdate.length > 0) {
                      await TavernHelper.setLorebookEntries(bookName, entriesToUpdate);
                    }
                    
                    console.log(`[Táº£i Quy KhÆ°] ÄÃ£ ghi Ä‘Ã¨ dá»¯ liá»‡u Lorebook cá»§a tá»‡p lÆ°u "${saveName}" vÃ o sá»‘ thá»© tá»± hiá»‡n táº¡i ${currentIndex}`);
                    
                  } catch (e) {
                    console.error("Lá»—i khi khÃ´i phá»¥c dá»¯ liá»‡u Lorebook:", e);
                    this.showTemporaryMessage("Cáº£nh bÃ¡o: KhÃ´i phá»¥c dá»¯ liá»‡u Lorebook tháº¥t báº¡i, nhÆ°ng dá»¯ liá»‡u chÃ­nh Ä‘Ã£ Ä‘Æ°á»£c khÃ´i phá»¥c.");
                  }
                }
                // --- æ–°é€»è¾‘ç»“æŸ ---

                await TavernHelper.setChatMessages([messageZero], { refresh: 'all' });
                
                await this.loadAndDisplayCurrentScene(loadedMessageContent);
                await this.init();

                this.showTemporaryMessage(`Táº£i tá»‡p lÆ°u "${saveName}" thÃ nh cÃ´ng!`);
                this.closeAllModals();

              } catch (error) {
                console.error('Táº£i tháº¥t báº¡i:', error);
                this.showTemporaryMessage(`Táº£i tháº¥t báº¡i: ${error.message}`);
              }
            });
          },

          deleteSave(slotId) {
            this.showCustomConfirm(`Cháº¯c cháº¯n muá»‘n xÃ³a tá»‡p lÆ°u ${slotId.split('_')[1]} khÃ´ng? Thao tÃ¡c nÃ y khÃ´ng thá»ƒ hoÃ n tÃ¡c.`, () => {
              try {
                const allSaves = this.getSavesFromStorage();
                if (allSaves[slotId]) {
                  delete allSaves[slotId];
                  localStorage.setItem('guixu_multi_save_data', JSON.stringify(allSaves));
                  this.showTemporaryMessage(`Tá»‡p lÆ°u ${slotId.split('_')[1]} Ä‘Ã£ bá»‹ xÃ³a.`);
                  this.showSaveLoadManager(); // Refresh UI
                }
              } catch (error) {
                console.error('XÃ³a tá»‡p lÆ°u tháº¥t báº¡i:', error);
                this.showTemporaryMessage(`XÃ³a tá»‡p lÆ°u tháº¥t báº¡i: ${error.message}`);
              }
            });
          },

          clearAllSaves() {
            this.showCustomConfirm(`Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a táº¥t cáº£ cÃ¡c tá»‡p lÆ°u khÃ´ng? Thao tÃ¡c nÃ y sáº½ xÃ³a dá»¯ liá»‡u cá»§a cáº£ 5 Ã´ lÆ°u trá»¯ vÃ  khÃ´ng thá»ƒ hoÃ n tÃ¡c.`, () => {
              try {
                localStorage.removeItem('guixu_multi_save_data');
                this.showTemporaryMessage(`Táº¥t cáº£ cÃ¡c tá»‡p lÆ°u Ä‘Ã£ Ä‘Æ°á»£c xÃ³a.`);
                this.showSaveLoadManager(); // åˆ·æ–°UI
              } catch (error) {
                console.error('XÃ³a táº¥t cáº£ tá»‡p lÆ°u tháº¥t báº¡i:', error);
                this.showTemporaryMessage(`XÃ³a tá»‡p lÆ°u tháº¥t báº¡i: ${error.message}`);
              }
            });
          },

          // --- æ–°å¢ï¼šå­˜æ¡£å‘½åè¾“å…¥æ¡† ---
          async promptForSaveName(slotId) {
            console.log('[LÆ°u trá»¯ Quy KhÆ°] Hiá»ƒn thá»‹ há»™p thoáº¡i Ä‘áº·t tÃªn tá»‡p lÆ°u');
            return new Promise((resolve) => {
              try {
                // åˆ›å»ºæ¨¡æ€æ¡†
                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.style.display = 'flex';
                modal.style.zIndex = '2000'; // ç¡®ä¿åœ¨æœ€é¡¶å±‚
                modal.innerHTML = `
                  <div class="modal-content" style="width: 400px; height: auto; max-height: none;">
                    <div class="modal-header">
                      <h2 class="modal-title">Äáº·t tÃªn tá»‡p lÆ°u</h2>
                    </div>
                    <div class="modal-body" style="padding: 20px;">
                      <p style="margin-bottom: 15px; color: #c9aa71;">Vui lÃ²ng nháº­p tÃªn cho Ã´ lÆ°u trá»¯ ${slotId.split('_')[1]}:</p>
                      <input type="text" id="save-name-input" placeholder="VÃ­ dá»¥: Äá»™t phÃ¡ Kim Äan ká»³"
                             style="width: 100%; padding: 10px; background: rgba(0,0,0,0.5); border: 1px solid #8b7355;
                                    color: #e0dcd1; border-radius: 4px; font-size: 14px; margin-bottom: 15px;">
                      <p style="font-size: 12px; color: #8b7355; margin-bottom: 20px;">
                        Sáº½ táº¡o cÃ¡c má»¥c Lorebook:<br>
                        â€¢ <span id="preview-journey">TÃªn-HÃ nh TrÃ¬nh Kiáº¿p NÃ y</span><br>
                        â€¢ <span id="preview-past-lives">TÃªn-SÃ³ng NÆ°á»›c Kiáº¿p XÆ°a</span>
                      </p>
                      <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button id="save-name-cancel" class="interaction-btn">Há»§y</button>
                        <button id="save-name-confirm" class="interaction-btn primary-btn">XÃ¡c nháº­n</button>
                      </div>
                    </div>
                  </div>
                `;

                const container = document.querySelector('.guixu-root-container');
                if (!container) {
                  console.error('[LÆ°u trá»¯ Quy KhÆ°] KhÃ´ng tÃ¬m tháº¥y vÃ¹ng chá»©a gá»‘c');
                  resolve(null);
                  return;
                }
                container.appendChild(modal);

                const input = modal.querySelector('#save-name-input');
                const previewJourney = modal.querySelector('#preview-journey');
                const previewPastLives = modal.querySelector('#preview-past-lives');
                const confirmBtn = modal.querySelector('#save-name-confirm');
                const cancelBtn = modal.querySelector('#save-name-cancel');

                if (!input || !confirmBtn || !cancelBtn) {
                  console.error('[LÆ°u trá»¯ Quy KhÆ°] Táº¡o pháº§n tá»­ modal tháº¥t báº¡i');
                  modal.remove();
                  resolve(null);
                  return;
                }

                // å®æ—¶æ›´æ–°é¢„è§ˆ
                input.addEventListener('input', () => {
                  const name = input.value.trim() || 'TÃªn';
                  if (previewJourney) previewJourney.textContent = `${name}-HÃ nh TrÃ¬nh Kiáº¿p NÃ y`;
                  if (previewPastLives) previewPastLives.textContent = `${name}-SÃ³ng NÆ°á»›c Kiáº¿p XÆ°a`;
                });

                // ç¡®è®¤æŒ‰é’®
                confirmBtn.addEventListener('click', () => {
                  const saveName = input.value.trim();
                  if (!saveName) {
                    this.showTemporaryMessage('Vui lÃ²ng nháº­p tÃªn tá»‡p lÆ°u');
                    return;
                  }
                  console.log('[LÆ°u trá»¯ Quy KhÆ°] NgÆ°á»i dÃ¹ng nháº­p tÃªn tá»‡p lÆ°u:', saveName);
                  modal.remove();
                  resolve(saveName);
                });

                // Cancel button
                cancelBtn.addEventListener('click', () => {
                  console.log('[LÆ°u trá»¯ Quy KhÆ°] NgÆ°á»i dÃ¹ng há»§y lÆ°u trá»¯');
                  modal.remove();
                  resolve(null);
                });

                // å›è½¦ç¡®è®¤
                input.addEventListener('keypress', (e) => {
                  if (e.key === 'Enter') {
                    confirmBtn.click();
                  }
                });

                // è‡ªåŠ¨èšç„¦
                setTimeout(() => {
                  try {
                    input.focus();
                  } catch (e) {
                    console.warn('[LÆ°u trá»¯ Quy KhÆ°] Tá»± Ä‘á»™ng láº¥y nÃ©t tháº¥t báº¡i:', e);
                  }
                }, 100);

              } catch (error) {
                console.error('[LÆ°u trá»¯ Quy KhÆ°] Lá»—i khi táº¡o há»™p thoáº¡i Ä‘áº·t tÃªn tá»‡p lÆ°u:', error);
                resolve(null);
              }
            });
          },

        };
 
         // --- Entry Point ---
         // TÃ¡c pháº©m cá»§a LÃ£o NÃ£o/Lá»¯ TrÃ¬nh Má»™ng Tinh, cáº¥m Ä‘Äƒng láº¡i, cáº¥m thÆ°Æ¡ng máº¡i hÃ³a, táº¥t cáº£ Ä‘á»u Ä‘Æ°á»£c chia sáº» miá»…n phÃ­ vÃ  mÃ£ nguá»“n má»Ÿ
        eventOn(tavern_events.APP_READY, () => {
          GuixuManager.init();
        });

        // äº‹ä»¶ç›‘å¬å·²åœ¨ GuixuManager.init() ä¸­å¤„ç†ï¼Œæ­¤å¤„ä¸å†éœ€è¦
      })();
    </script>
  </body>
</html>
